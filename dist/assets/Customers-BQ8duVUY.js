import{r as n,ap as je,U as t,V as Ce,Y as we,Z as E,W as ze,a4 as Te,bg as Ie,ao as Ne,a0 as F,bb as G,an as Ae,a2 as $e,bz as ve,a3 as De,a6 as y,be as l,$ as z,bh as Ee,bi as C,aa as Fe}from"./index-CDYSMnhF.js";import{a as _e,b as Le,B as ke,F as Ue,N as Re,R as Pe}from"./FollowUpDrawer-DL1d_dOw.js";import{h as Be,E as Ve,R as Ze}from"./html2canvas.esm-DzcwRW7F.js";import{u as _,a as Oe}from"./xlsx-CyWl6TWy.js";import{R as Me}from"./MessageOutlined-BKyq4j-V.js";import{P as We}from"./index-BaWZJApH.js";import{R as Ge}from"./DeleteOutlined-C8bxn61I.js";import"./MinusCircleOutlined-11eb5nEz.js";import"./moment-C5S46NFB.js";const{Title:He}=ze,{TabPane:W}=G,T="/api/accounts",ot=()=>{const[p,H]=n.useState(""),[u,Y]=n.useState("all"),[I,K]=n.useState([]),[L,h]=n.useState(!1),[J,q]=n.useState([]),[Q,k]=n.useState(!1),[U,X]=n.useState([]),[ee,R]=n.useState(!1),[te,A]=n.useState(!1),[x,P]=n.useState(null),[se,$]=n.useState(!1),[w,B]=n.useState(null),[v,V]=n.useState(null),[ae,Z]=n.useState(!1),[oe,O]=n.useState(!1),[D,M]=n.useState(null),re=je();n.useRef(null);const j=JSON.parse(localStorage.getItem("user")),f=j==null?void 0:j.role,m=j==null?void 0:j._id,[r,N]=n.useState({current:1,pageSize:10,total:0}),b=async(e={})=>{h(!0);try{const{current:s=r.current,pageSize:o=r.pageSize,searchText:a="",sortBy:i="createdAt",sortOrder:g="desc",zoneId:d=u}=e;let c=`${T}/paginated?page=${s}&pageSize=${o}&search=${a}&status=Customer`;i&&(c+=`&sortBy=${i}`),g&&(c+=`&sortOrder=${g}`),f==="Employee"&&m?c+=`&userId=${m}&role=${f}`:f==="Team Leader"&&m&&(c+=`&teamLeaderId=${m}&role=${f}`),d&&d!=="all"&&(c+=`&zone=${d}`);const S=await y.get(c);K(S.data.data),N({...r,current:S.data.page,pageSize:S.data.pageSize,total:S.data.total})}catch(s){l.error("Failed to load customers"),console.error("Error fetching customers:",s)}finally{h(!1)}},ne=async()=>{k(!0);try{const e=await y.get("/api/accounts/users");q(e.data)}catch(e){l.error("Failed to load user list"),console.error("Error fetching users:",e)}finally{k(!1)}},le=async()=>{R(!0);try{let e="/api/zones";f==="Employee"&&m?e+=`?userId=${m}`:f==="Team Leader"&&m&&(e+=`?teamLeaderId=${m}`);const s=await y.get(e);X(s.data)}catch(e){console.error("Error fetching zones:",e),l.error("Failed to load zones.")}finally{R(!1)}},ce=e=>{Y(e),N({...r,current:1})};n.useEffect(()=>{b({current:r.current,pageSize:r.pageSize,searchText:p,zoneId:u}),ne(),le()},[r.current,r.pageSize,p,f,m,u]);const ie=e=>{P(e),A(!0)},de=async e=>{var s;h(!0);try{x!=null&&x._id?(await y.put(`${T}/${x._id}`,e),l.success("Customer updated successfully")):(await y.post(T,e),l.success("Customer created successfully")),b({current:r.current,pageSize:r.pageSize,searchText:p,zoneId:u})}catch(o){l.error(`Failed to ${x!=null&&x._id?"update":"create"} customer`),console.error("Save customer error:",((s=o.response)==null?void 0:s.data)||o.message)}finally{A(!1),P(null),h(!1)}},ue=(e,s)=>{B(s),V(e),$(!0)},pe=async()=>{var e;h(!0);try{const s={...w,status:v};await y.put(`${T}/${w._id}`,s),l.success(`Status updated to ${v}`),b({current:r.current,pageSize:r.pageSize,searchText:p,zoneId:u})}catch(s){l.error("Failed to update status"),console.error("Status update error:",((e=s.response)==null?void 0:e.data)||s.message)}finally{$(!1),B(null),V(null),h(!1)}},me=async e=>{var s;h(!0);try{await y.put(`${T}/${e}`,{status:"Closed",isCustomer:!1}),l.success("Customer status set to Closed"),b({current:r.current,pageSize:r.pageSize,searchText:p,zoneId:u})}catch(o){l.error("Failed to close customer account"),console.error("Soft delete error:",((s=o.response)==null?void 0:s.data)||o.message)}finally{h(!1)}},ge=e=>{M(e),Z(!0)},he=e=>{M(e),O(!0)},xe=e=>{re(`/customers/${e._id}`)},fe=async()=>{const e=document.getElementById("customerTable");if(!e){l.error("Table content not found for PDF export.");return}l.loading("Generating PDF...",{id:"pdf-toast"});try{const s=await Be(e,{scale:2}),o=s.toDataURL("image/png"),a=new Ve("p","mm","a4"),i=210,g=297,d=s.height*i/s.width;let c=d,S=0;for(a.addImage(o,"PNG",0,S,i,d),c-=g;c>=0;)S=c-d,a.addPage(),a.addImage(o,"PNG",0,S,i,d),c-=g;a.save("Customers_Details.pdf"),l.success("PDF generated!",{id:"pdf-toast"})}catch(s){console.error("Error generating PDF:",s),l.error("Failed to generate PDF.",{id:"pdf-toast"})}},Se=()=>{if(I.length===0){l.error("No data to export to Excel.");return}const e=I.map((a,i)=>{var d,c;return{"S.No":i+1+(r.current-1)*r.pageSize,"Business Name":a.businessName,"Contact Name":a.contactName,Email:a.email,"Mobile Number":a.mobileNumber,"Lead Type":a.type,Status:a.status,"Source Type":a.sourceType,"Assigned To":((d=a.assignedTo)==null?void 0:d.name)||"Unassigned","GST Number":a.gstNumber,"Phone Number":a.phoneNumber,"Address Line 1":a.addressLine1,"Address Line 2":a.addressLine2,"Address Line 3":a.addressLine3,Landmark:a.landmark,City:a.city,Pincode:a.pincode,State:a.state,Country:a.country,Website:a.website,"Is Customer":a.isCustomer?"Yes":"No","Created At":new Date(a.createdAt).toLocaleString(),Zone:((c=a.zone)==null?void 0:c.name)||"N/A"}}),s=_.json_to_sheet(e),o=_.book_new();_.book_append_sheet(o,s,"Customers Data"),Oe(o,"Customers_Data.xlsx"),l.success("Data exported to Excel!")},be=[{title:"Sno.",render:(e,s,o)=>o+1+(r.current-1)*r.pageSize,width:60},{title:"Business Name",dataIndex:"businessName",render:(e,s)=>t.jsx("a",{onClick:()=>xe(s),style:{cursor:"pointer",color:"#ef7a1b"},children:e}),sorter:!0},{title:"Contact Name",dataIndex:"contactName",sorter:!0},{title:"Email Id",dataIndex:"email",sorter:!0},{title:"Type",dataIndex:"type",render:e=>{switch(e){case"Hot":return t.jsx(z,{color:"red",children:"Hot"});case"Warm":return t.jsx(z,{color:"orange",children:"Warm"});case"Cold":return t.jsx(z,{color:"blue",children:"Cold"});default:return t.jsx(z,{children:"Unknown"})}},sorter:!0},{title:"Assigned To",dataIndex:["assignedTo","name"],render:(e,s)=>s.assignedTo?t.jsxs("span",{children:[s.assignedTo.name," (",s.assignedTo.role,")"]}):t.jsx("em",{children:"Unassigned"}),sorter:!0},{title:"Zone",dataIndex:["zone","name"],render:e=>e||"N/A",sorter:(e,s)=>{var i,g;const o=((i=e.zone)==null?void 0:i.name)||"",a=((g=s.zone)==null?void 0:g.name)||"";return o.localeCompare(a)}},{title:"Latest Note",render:(e,s)=>{var a;const o=(a=s.notes)==null?void 0:a[s.notes.length-1];return o?t.jsxs("div",{children:[t.jsx("small",{style:{color:"#888"},children:new Date(o.timestamp).toLocaleString()}),t.jsx("br",{}),o.text]}):t.jsx("em",{children:"No notes"})}},{title:"Status",dataIndex:"status",render:(e,s)=>t.jsx(z,{color:s.status==="Customer"?"blue":"gray",children:s.status}),sorter:!0},{title:"Actions",render:(e,s)=>t.jsx(Ee,{overlay:t.jsxs(C,{children:[t.jsx(C.Item,{icon:t.jsx(Fe,{}),onClick:()=>ie(s),children:"Edit Customer"},"edit"),t.jsx(C.Item,{icon:t.jsx(Me,{}),onClick:()=>ge(s),children:"View/Add Notes"},"notes"),t.jsx(C.Item,{icon:t.jsx(Pe,{}),onClick:()=>he(s),children:"View/Add Follow-ups"},"followups"),t.jsx(C.Item,{onClick:()=>ue("Active",s),children:"Change to Active Lead"},"change-to-active"),f==="Superadmin"&&t.jsx(C.Item,{children:t.jsxs(We,{title:"Are you sure you want to close this account? This will set its status to 'Closed'.",onConfirm:()=>me(s._id),okText:"Yes",cancelText:"No",children:[t.jsx(Ge,{}),"Close Account"]})},"close-account")]}),trigger:["click"],children:t.jsx(F,{icon:t.jsx(Ze,{})})})}],ye=(e,s,o)=>{N(e);const a=o.field,i=o.order==="ascend"?"asc":o.order==="descend"?"desc":void 0;b({current:e.current,pageSize:e.pageSize,searchText:p,sortBy:a,sortOrder:i,zoneId:u})};return t.jsxs("div",{children:[t.jsxs(Ce,{children:[t.jsxs(we,{gutter:[16,16],align:"middle",style:{marginBottom:16},children:[t.jsx(E,{xs:24,sm:12,md:8,lg:6,children:t.jsx(He,{level:4,style:{margin:0},children:"Customers"})}),t.jsx(E,{xs:24,sm:12,md:8,lg:6,children:t.jsx(Te,{placeholder:"Search by Business Name, Contact Name or Email",prefix:t.jsx(Ie,{}),value:p,onChange:e=>{H(e.target.value),N({...r,current:1})},style:{width:"100%"}})}),t.jsx(E,{xs:24,sm:24,md:8,lg:12,style:{display:"flex",justifyContent:"flex-end"},children:t.jsxs(Ne,{wrap:!0,children:[t.jsx(F,{icon:t.jsx(_e,{}),onClick:fe,style:{backgroundColor:"#ef7a1b",borderColor:"#ef7a1b",color:"white"},className:"orange-button",children:"Export to PDF"}),t.jsx(F,{icon:t.jsx(Le,{}),onClick:Se,style:{backgroundColor:"#ef7a1b",borderColor:"#ef7a1b",color:"white"},className:"orange-button",children:"Export to Excel"})]})})]}),t.jsxs(G,{activeKey:u,onChange:ce,style:{marginBottom:16},children:[t.jsx(W,{tab:"All Customers"},"all"),U.map(e=>t.jsx(W,{tab:t.jsx("span",{children:e.name})},e._id))]}),L?t.jsx(Ae,{size:"large",style:{display:"block",margin:"50px auto"}}):I.length>0?t.jsx("div",{id:"customerTable",children:t.jsx($e,{columns:be,dataSource:I,rowKey:"_id",pagination:r,onChange:ye,scroll:{x:"max-content"},className:"customers-table"})}):t.jsx(ve,{description:"No customers found."})]}),t.jsx(ke,{visible:te,onClose:()=>A(!1),onSave:de,initialValues:x,allUsers:J,loadingUsers:Q,allZones:U,loadingZones:ee}),t.jsx(De,{title:"Confirm Status Change",open:se,onOk:pe,onCancel:()=>$(!1),okText:"Yes",cancelText:"No",confirmLoading:L,children:t.jsxs("p",{children:["Are you sure you want to change the status of ",t.jsx("strong",{children:w==null?void 0:w.businessName})," to ",t.jsx("strong",{children:v}),"?"]})}),D&&t.jsxs(t.Fragment,{children:[t.jsx(Ue,{visible:oe,onClose:()=>O(!1),account:D,refreshAccounts:()=>b({current:r.current,pageSize:r.pageSize,searchText:p,zoneId:u})}),t.jsx(Re,{visible:ae,onClose:()=>Z(!1),account:D,refreshAccounts:()=>b({current:r.current,pageSize:r.pageSize,searchText:p,zoneId:u})})]})]})};export{ot as default};
