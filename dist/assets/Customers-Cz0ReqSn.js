import{r as n,ah as je,K as t,L as Ce,N as we,O as D,T as Te,Y as ze,a_ as Ie,ag as Ne,Q as E,aU as Y,af as Ae,W as $e,bh as _e,X as ve,$ as b,aY as l,P as T,a$ as De,b0 as C,a3 as Ee,aW as Fe}from"./index-FVmEbnB1.js";import{a as Le,b as ke,B as Ue,F as Pe,N as Re,R as Be}from"./FollowUpDrawer-BavWiXBC.js";import{h as Ve,E as Ze,R as Oe}from"./html2canvas.esm-B6uPR1ag.js";import{u as F,a as We}from"./xlsx-CyWl6TWy.js";import{R as Me}from"./MessageOutlined-2hKw1Wa4.js";import{P as Ye}from"./index-BTVJIO-A.js";import"./MinusCircleOutlined-BotvY0WV.js";import"./moment-C5S46NFB.js";const{Title:Ge}=Te,{TabPane:M}=Y,z="/api/accounts",at=()=>{const[p,G]=n.useState(""),[u,H]=n.useState("all"),[I,K]=n.useState([]),[L,h]=n.useState(!1),[J,Q]=n.useState([]),[X,k]=n.useState(!1),[U,q]=n.useState([]),[ee,P]=n.useState(!1),[te,A]=n.useState(!1),[x,R]=n.useState(null),[se,$]=n.useState(!1),[w,B]=n.useState(null),[_,V]=n.useState(null),[ae,Z]=n.useState(!1),[oe,O]=n.useState(!1),[v,W]=n.useState(null),re=je();n.useRef(null);const j=JSON.parse(localStorage.getItem("user")),f=j==null?void 0:j.role,g=j==null?void 0:j._id,[r,N]=n.useState({current:1,pageSize:10,total:0}),y=async(e={})=>{h(!0);try{const{current:s=r.current,pageSize:o=r.pageSize,searchText:a="",sortBy:i="createdAt",sortOrder:m="desc",zoneId:d=u}=e;let c=`${z}/paginated?page=${s}&pageSize=${o}&search=${a}&status=Customer`;i&&(c+=`&sortBy=${i}`),m&&(c+=`&sortOrder=${m}`),f==="Employee"&&g?c+=`&userId=${g}&role=${f}`:f==="Team Leader"&&g&&(c+=`&teamLeaderId=${g}&role=${f}`),d&&d!=="all"&&(c+=`&zone=${d}`);const S=await b.get(c);K(S.data.data),N({...r,current:S.data.page,pageSize:S.data.pageSize,total:S.data.total})}catch(s){l.error("Failed to load customers"),console.error("Error fetching customers:",s)}finally{h(!1)}},ne=async()=>{k(!0);try{const e=await b.get("/api/accounts/users");Q(e.data)}catch(e){l.error("Failed to load user list"),console.error("Error fetching users:",e)}finally{k(!1)}},le=async()=>{P(!0);try{let e="/api/zones";f==="Employee"&&g?e+=`?userId=${g}`:f==="Team Leader"&&g&&(e+=`?teamLeaderId=${g}`);const s=await b.get(e);q(s.data)}catch(e){console.error("Error fetching zones:",e),l.error("Failed to load zones.")}finally{P(!1)}},ce=e=>{H(e),N({...r,current:1})};n.useEffect(()=>{y({current:r.current,pageSize:r.pageSize,searchText:p,zoneId:u}),ne(),le()},[r.current,r.pageSize,p,f,g,u]);const ie=e=>{R(e),A(!0)},de=async e=>{var s;h(!0);try{x!=null&&x._id?(await b.put(`${z}/${x._id}`,e),l.success("Customer updated successfully")):(await b.post(z,e),l.success("Customer created successfully")),y({current:r.current,pageSize:r.pageSize,searchText:p,zoneId:u})}catch(o){l.error(`Failed to ${x!=null&&x._id?"update":"create"} customer`),console.error("Save customer error:",((s=o.response)==null?void 0:s.data)||o.message)}finally{A(!1),R(null),h(!1)}},ue=(e,s)=>{B(s),V(e),$(!0)},pe=async()=>{var e;h(!0);try{const s={...w,status:_};await b.put(`${z}/${w._id}`,s),l.success(`Status updated to ${_}`),y({current:r.current,pageSize:r.pageSize,searchText:p,zoneId:u})}catch(s){l.error("Failed to update status"),console.error("Status update error:",((e=s.response)==null?void 0:e.data)||s.message)}finally{$(!1),B(null),V(null),h(!1)}},ge=async e=>{var s;h(!0);try{await b.put(`${z}/${e}`,{status:"Closed",isCustomer:!1}),l.success("Customer status set to Closed"),y({current:r.current,pageSize:r.pageSize,searchText:p,zoneId:u})}catch(o){l.error("Failed to close customer account"),console.error("Soft delete error:",((s=o.response)==null?void 0:s.data)||o.message)}finally{h(!1)}},me=e=>{W(e),Z(!0)},he=e=>{W(e),O(!0)},xe=e=>{re(`/customers/${e._id}`)},fe=async()=>{const e=document.getElementById("customerTable");if(!e){l.error("Table content not found for PDF export.");return}l.loading("Generating PDF...",{id:"pdf-toast"});try{const s=await Ve(e,{scale:2}),o=s.toDataURL("image/png"),a=new Ze("p","mm","a4"),i=210,m=297,d=s.height*i/s.width;let c=d,S=0;for(a.addImage(o,"PNG",0,S,i,d),c-=m;c>=0;)S=c-d,a.addPage(),a.addImage(o,"PNG",0,S,i,d),c-=m;a.save("Customers_Details.pdf"),l.success("PDF generated!",{id:"pdf-toast"})}catch(s){console.error("Error generating PDF:",s),l.error("Failed to generate PDF.",{id:"pdf-toast"})}},Se=()=>{if(I.length===0){l.error("No data to export to Excel.");return}const e=I.map((a,i)=>{var d,c;return{"S.No":i+1+(r.current-1)*r.pageSize,"Business Name":a.businessName,"Contact Name":a.contactName,Email:a.email,"Mobile Number":a.mobileNumber,"Lead Type":a.type,Status:a.status,"Source Type":a.sourceType,"Assigned To":((d=a.assignedTo)==null?void 0:d.name)||"Unassigned","GST Number":a.gstNumber,"Phone Number":a.phoneNumber,"Address Line 1":a.addressLine1,"Address Line 2":a.addressLine2,"Address Line 3":a.addressLine3,Landmark:a.landmark,City:a.city,Pincode:a.pincode,State:a.state,Country:a.country,Website:a.website,"Is Customer":a.isCustomer?"Yes":"No","Created At":new Date(a.createdAt).toLocaleString(),Zone:((c=a.zone)==null?void 0:c.name)||"N/A"}}),s=F.json_to_sheet(e),o=F.book_new();F.book_append_sheet(o,s,"Customers Data"),We(o,"Customers_Data.xlsx"),l.success("Data exported to Excel!")},ye=[{title:"Sno.",render:(e,s,o)=>o+1+(r.current-1)*r.pageSize,width:60},{title:"Business Name",dataIndex:"businessName",render:(e,s)=>t.jsx("a",{onClick:()=>xe(s),style:{cursor:"pointer",color:"#ef7a1b"},children:e}),sorter:!0},{title:"Contact Name",dataIndex:"contactName",sorter:!0},{title:"Email Id",dataIndex:"email",sorter:!0},{title:"Type",dataIndex:"type",render:e=>{switch(e){case"Hot":return t.jsx(T,{color:"red",children:"Hot"});case"Warm":return t.jsx(T,{color:"orange",children:"Warm"});case"Cold":return t.jsx(T,{color:"blue",children:"Cold"});default:return t.jsx(T,{children:"Unknown"})}},sorter:!0},{title:"Assigned To",dataIndex:["assignedTo","name"],render:(e,s)=>s.assignedTo?t.jsxs("span",{children:[s.assignedTo.name," (",s.assignedTo.role,")"]}):t.jsx("em",{children:"Unassigned"}),sorter:!0},{title:"Zone",dataIndex:["zone","name"],render:e=>e||"N/A",sorter:(e,s)=>{var i,m;const o=((i=e.zone)==null?void 0:i.name)||"",a=((m=s.zone)==null?void 0:m.name)||"";return o.localeCompare(a)}},{title:"Latest Note",render:(e,s)=>{var a;const o=(a=s.notes)==null?void 0:a[s.notes.length-1];return o?t.jsxs("div",{children:[t.jsx("small",{style:{color:"#888"},children:new Date(o.timestamp).toLocaleString()}),t.jsx("br",{}),o.text]}):t.jsx("em",{children:"No notes"})}},{title:"Status",dataIndex:"status",render:(e,s)=>t.jsx(T,{color:s.status==="Customer"?"blue":"gray",children:s.status}),sorter:!0},{title:"Actions",render:(e,s)=>t.jsx(De,{overlay:t.jsxs(C,{children:[t.jsx(C.Item,{icon:t.jsx(Ee,{}),onClick:()=>ie(s),children:"Edit Customer"},"edit"),t.jsx(C.Item,{icon:t.jsx(Me,{}),onClick:()=>me(s),children:"View/Add Notes"},"notes"),t.jsx(C.Item,{icon:t.jsx(Be,{}),onClick:()=>he(s),children:"View/Add Follow-ups"},"followups"),t.jsx(C.Item,{onClick:()=>ue("Active",s),children:"Change to Active Lead"},"change-to-active"),f==="Superadmin"&&t.jsx(C.Item,{children:t.jsxs(Ye,{title:"Are you sure you want to close this account? This will set its status to 'Closed'.",onConfirm:()=>ge(s._id),okText:"Yes",cancelText:"No",children:[t.jsx(Fe,{}),"Close Account"]})},"close-account")]}),trigger:["click"],children:t.jsx(E,{icon:t.jsx(Oe,{})})})}],be=(e,s,o)=>{N(e);const a=o.field,i=o.order==="ascend"?"asc":o.order==="descend"?"desc":void 0;y({current:e.current,pageSize:e.pageSize,searchText:p,sortBy:a,sortOrder:i,zoneId:u})};return t.jsxs("div",{children:[t.jsxs(Ce,{children:[t.jsxs(we,{gutter:[16,16],align:"middle",style:{marginBottom:16},children:[t.jsx(D,{xs:24,sm:12,md:8,lg:6,children:t.jsx(Ge,{level:4,style:{margin:0},children:"Customers"})}),t.jsx(D,{xs:24,sm:12,md:8,lg:6,children:t.jsx(ze,{placeholder:"Search by Business Name, Contact Name or Email",prefix:t.jsx(Ie,{}),value:p,onChange:e=>{G(e.target.value),N({...r,current:1})},style:{width:"100%"}})}),t.jsx(D,{xs:24,sm:24,md:8,lg:12,style:{display:"flex",justifyContent:"flex-end"},children:t.jsxs(Ne,{wrap:!0,children:[t.jsx(E,{icon:t.jsx(Le,{}),onClick:fe,style:{backgroundColor:"#ef7a1b",borderColor:"#ef7a1b",color:"white"},className:"orange-button",children:"Export to PDF"}),t.jsx(E,{icon:t.jsx(ke,{}),onClick:Se,style:{backgroundColor:"#ef7a1b",borderColor:"#ef7a1b",color:"white"},className:"orange-button",children:"Export to Excel"})]})})]}),t.jsxs(Y,{activeKey:u,onChange:ce,style:{marginBottom:16},children:[t.jsx(M,{tab:"All Customers"},"all"),U.map(e=>t.jsx(M,{tab:t.jsx("span",{children:e.name})},e._id))]}),L?t.jsx(Ae,{size:"large",style:{display:"block",margin:"50px auto"}}):I.length>0?t.jsx("div",{id:"customerTable",children:t.jsx($e,{columns:ye,dataSource:I,rowKey:"_id",pagination:r,onChange:be,scroll:{x:"max-content"},className:"customers-table"})}):t.jsx(_e,{description:"No customers found."})]}),t.jsx(Ue,{visible:te,onClose:()=>A(!1),onSave:de,initialValues:x,allUsers:J,loadingUsers:X,allZones:U,loadingZones:ee}),t.jsx(ve,{title:"Confirm Status Change",open:se,onOk:pe,onCancel:()=>$(!1),okText:"Yes",cancelText:"No",confirmLoading:L,children:t.jsxs("p",{children:["Are you sure you want to change the status of ",t.jsx("strong",{children:w==null?void 0:w.businessName})," to ",t.jsx("strong",{children:_}),"?"]})}),v&&t.jsxs(t.Fragment,{children:[t.jsx(Pe,{visible:oe,onClose:()=>O(!1),account:v,refreshAccounts:()=>y({current:r.current,pageSize:r.pageSize,searchText:p,zoneId:u})}),t.jsx(Re,{visible:ae,onClose:()=>Z(!1),account:v,refreshAccounts:()=>y({current:r.current,pageSize:r.pageSize,searchText:p,zoneId:u})})]})]})};export{at as default};
