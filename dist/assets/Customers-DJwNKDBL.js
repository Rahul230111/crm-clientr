import{r as n,J as be,x as t,H as je,B as v,S as we,an as i,ao as Te,ap as j}from"./index-3j2E7pUL.js";import{i as C}from"./axios-CSlAuMiO.js";import{a as ze,b as Ie,B as Ne,F as Ae,N as $e,R as Ee}from"./FollowUpDrawer-CyApDoYa.js";import{h as Fe,E as ve,R as De}from"./html2canvas.esm-D5fRu8Us.js";import{u as D,a as _e}from"./xlsx-CyWl6TWy.js";import{C as Le}from"./index-DhvOivYi.js";import{R as ke,C as _}from"./row-BatVd8KW.js";import{T as Re}from"./index-C-eCguuc.js";import{I as Ue}from"./index-CsUGJ7YV.js";import{b as Pe}from"./TextArea-DELUlYzR.js";import{T as G}from"./index-BRTO4pFo.js";import{F as Be}from"./Table-HKvwWm1_.js";import{E as Ve}from"./index-DiojptZP.js";import{M as Ze}from"./index-B80iahJ-.js";import{T}from"./index-BrSJe371.js";import{R as Oe}from"./EditOutlined-0_cnfjzU.js";import{R as Me}from"./MessageOutlined-DZkEco9W.js";import{P as He}from"./index-CFb1Uy8W.js";import{R as Ge}from"./DeleteOutlined-BAvkxAoL.js";import"./index-jd3XYpcD.js";import"./index-DVSodFTC.js";import"./context-DJnMqWkY.js";import"./useClosable-CC1Ls4ip.js";import"./extendsObject-78o_rR5W.js";import"./MinusCircleOutlined-BOYpYwy0.js";import"./PlusOutlined-BdSH2k4o.js";import"./index-VOyckxEQ.js";import"./index-MHS1ptoq.js";import"./moment-C5S46NFB.js";import"./index-NsnFnMr_.js";import"./dayjs.min-BAOJIqCz.js";import"./index-BoISyFuH.js";import"./Pagination-Buu9EMH_.js";import"./styleChecker-D89VOBbV.js";import"./addEventListener-BJarX3AI.js";import"./index-CfNZZRpy.js";import"./InfoCircleFilled-DSywJBHM.js";import"./ActionButton-RId_fRI3.js";import"./index-Dgbp67W9.js";const{Title:We}=Re,{TabPane:H}=G,z="/api/accounts",_t=()=>{const[m,W]=n.useState(""),[u,Y]=n.useState("all"),[I,J]=n.useState([]),[L,f]=n.useState(!1),[K,q]=n.useState([]),[Q,k]=n.useState(!1),[R,X]=n.useState([]),[ee,U]=n.useState(!1),[te,A]=n.useState(!1),[h,P]=n.useState(null),[se,$]=n.useState(!1),[w,B]=n.useState(null),[E,V]=n.useState(null),[oe,Z]=n.useState(!1),[ae,O]=n.useState(!1),[F,M]=n.useState(null),re=be();n.useRef(null);const b=JSON.parse(localStorage.getItem("user")),x=b==null?void 0:b.role,p=b==null?void 0:b._id,[r,N]=n.useState({current:1,pageSize:10,total:0}),y=async(e={})=>{f(!0);try{const{current:s=r.current,pageSize:a=r.pageSize,searchText:o="",sortBy:c="createdAt",sortOrder:g="desc",zoneId:d=u}=e;let l=`${z}/paginated?page=${s}&pageSize=${a}&search=${o}&status=Customer`;c&&(l+=`&sortBy=${c}`),g&&(l+=`&sortOrder=${g}`),x==="Employee"&&p?l+=`&userId=${p}&role=${x}`:x==="Team Leader"&&p&&(l+=`&teamLeaderId=${p}&role=${x}`),d&&d!=="all"&&(l+=`&zone=${d}`);const S=await C.get(l);J(S.data.data),N({...r,current:S.data.page,pageSize:S.data.pageSize,total:S.data.total})}catch(s){i.error("Failed to load customers"),console.error("Error fetching customers:",s)}finally{f(!1)}},ne=async()=>{k(!0);try{const e=await C.get("/api/accounts/users");q(e.data)}catch(e){i.error("Failed to load user list"),console.error("Error fetching users:",e)}finally{k(!1)}},ie=async()=>{U(!0);try{let e="/api/zones";x==="Employee"&&p?e+=`?userId=${p}`:x==="Team Leader"&&p&&(e+=`?teamLeaderId=${p}`);const s=await C.get(e);X(s.data)}catch(e){console.error("Error fetching zones:",e),i.error("Failed to load zones.")}finally{U(!1)}},le=e=>{Y(e),N({...r,current:1})};n.useEffect(()=>{y({current:r.current,pageSize:r.pageSize,searchText:m,zoneId:u}),ne(),ie()},[r.current,r.pageSize,m,x,p,u]);const ce=e=>{P(e),A(!0)},de=async e=>{var s;f(!0);try{h!=null&&h._id?(await C.put(`${z}/${h._id}`,e),i.success("Customer updated successfully")):(await C.post(z,e),i.success("Customer created successfully")),y({current:r.current,pageSize:r.pageSize,searchText:m,zoneId:u})}catch(a){i.error(`Failed to ${h!=null&&h._id?"update":"create"} customer`),console.error("Save customer error:",((s=a.response)==null?void 0:s.data)||a.message)}finally{A(!1),P(null),f(!1)}},ue=(e,s)=>{B(s),V(e),$(!0)},me=async()=>{var e;f(!0);try{const s={...w,status:E};await C.put(`${z}/${w._id}`,s),i.success(`Status updated to ${E}`),y({current:r.current,pageSize:r.pageSize,searchText:m,zoneId:u})}catch(s){i.error("Failed to update status"),console.error("Status update error:",((e=s.response)==null?void 0:e.data)||s.message)}finally{$(!1),B(null),V(null),f(!1)}},pe=async e=>{var s;f(!0);try{await C.put(`${z}/${e}`,{status:"Closed",isCustomer:!1}),i.success("Customer status set to Closed"),y({current:r.current,pageSize:r.pageSize,searchText:m,zoneId:u})}catch(a){i.error("Failed to close customer account"),console.error("Soft delete error:",((s=a.response)==null?void 0:s.data)||a.message)}finally{f(!1)}},ge=e=>{M(e),Z(!0)},fe=e=>{M(e),O(!0)},he=e=>{re(`/customers/${e._id}`)},xe=async()=>{const e=document.getElementById("customerTable");if(!e){i.error("Table content not found for PDF export.");return}i.loading("Generating PDF...",{id:"pdf-toast"});try{const s=await Fe(e,{scale:2}),a=s.toDataURL("image/png"),o=new ve("p","mm","a4"),c=210,g=297,d=s.height*c/s.width;let l=d,S=0;for(o.addImage(a,"PNG",0,S,c,d),l-=g;l>=0;)S=l-d,o.addPage(),o.addImage(a,"PNG",0,S,c,d),l-=g;o.save("Customers_Details.pdf"),i.success("PDF generated!",{id:"pdf-toast"})}catch(s){console.error("Error generating PDF:",s),i.error("Failed to generate PDF.",{id:"pdf-toast"})}},Se=()=>{if(I.length===0){i.error("No data to export to Excel.");return}const e=I.map((o,c)=>{var d,l;return{"S.No":c+1+(r.current-1)*r.pageSize,"Business Name":o.businessName,"Contact Name":o.contactName,Email:o.email,"Mobile Number":o.mobileNumber,"Lead Type":o.type,Status:o.status,"Source Type":o.sourceType,"Assigned To":((d=o.assignedTo)==null?void 0:d.name)||"Unassigned","GST Number":o.gstNumber,"Phone Number":o.phoneNumber,"Address Line 1":o.addressLine1,"Address Line 2":o.addressLine2,"Address Line 3":o.addressLine3,Landmark:o.landmark,City:o.city,Pincode:o.pincode,State:o.state,Country:o.country,Website:o.website,"Is Customer":o.isCustomer?"Yes":"No","Created At":new Date(o.createdAt).toLocaleString(),Zone:((l=o.zone)==null?void 0:l.name)||"N/A"}}),s=D.json_to_sheet(e),a=D.book_new();D.book_append_sheet(a,s,"Customers Data"),_e(a,"Customers_Data.xlsx"),i.success("Data exported to Excel!")},ye=[{title:"Sno.",render:(e,s,a)=>a+1+(r.current-1)*r.pageSize,width:60},{title:"Business Name",dataIndex:"businessName",render:(e,s)=>t.jsx("a",{onClick:()=>he(s),style:{cursor:"pointer",color:"#ef7a1b"},children:e}),sorter:!0},{title:"Contact Name",dataIndex:"contactName",sorter:!0},{title:"Email Id",dataIndex:"email",sorter:!0},{title:"Type",dataIndex:"type",render:e=>{switch(e){case"Hot":return t.jsx(T,{color:"red",children:"Hot"});case"Warm":return t.jsx(T,{color:"orange",children:"Warm"});case"Cold":return t.jsx(T,{color:"blue",children:"Cold"});default:return t.jsx(T,{children:"Unknown"})}},sorter:!0},{title:"Assigned To",dataIndex:["assignedTo","name"],render:(e,s)=>s.assignedTo?t.jsxs("span",{children:[s.assignedTo.name," (",s.assignedTo.role,")"]}):t.jsx("em",{children:"Unassigned"}),sorter:!0},{title:"Zone",dataIndex:["zone","name"],render:e=>e||"N/A",sorter:(e,s)=>{var c,g;const a=((c=e.zone)==null?void 0:c.name)||"",o=((g=s.zone)==null?void 0:g.name)||"";return a.localeCompare(o)}},{title:"Latest Note",render:(e,s)=>{var o;const a=(o=s.notes)==null?void 0:o[s.notes.length-1];return a?t.jsxs("div",{children:[t.jsx("small",{style:{color:"#888"},children:new Date(a.timestamp).toLocaleString()}),t.jsx("br",{}),a.text]}):t.jsx("em",{children:"No notes"})}},{title:"Status",dataIndex:"status",render:(e,s)=>t.jsx(T,{color:s.status==="Customer"?"blue":"gray",children:s.status}),sorter:!0},{title:"Actions",render:(e,s)=>t.jsx(Te,{overlay:t.jsxs(j,{children:[t.jsx(j.Item,{icon:t.jsx(Oe,{}),onClick:()=>ce(s),children:"Edit Customer"},"edit"),t.jsx(j.Item,{icon:t.jsx(Me,{}),onClick:()=>ge(s),children:"View/Add Notes"},"notes"),t.jsx(j.Item,{icon:t.jsx(Ee,{}),onClick:()=>fe(s),children:"View/Add Follow-ups"},"followups"),t.jsx(j.Item,{onClick:()=>ue("Active",s),children:"Change to Active Lead"},"change-to-active"),x==="Superadmin"&&t.jsx(j.Item,{children:t.jsxs(He,{title:"Are you sure you want to close this account? This will set its status to 'Closed'.",onConfirm:()=>pe(s._id),okText:"Yes",cancelText:"No",children:[t.jsx(Ge,{}),"Close Account"]})},"close-account")]}),trigger:["click"],children:t.jsx(v,{icon:t.jsx(De,{})})})}],Ce=(e,s,a)=>{N(e);const o=a.field,c=a.order==="ascend"?"asc":a.order==="descend"?"desc":void 0;y({current:e.current,pageSize:e.pageSize,searchText:m,sortBy:o,sortOrder:c,zoneId:u})};return t.jsxs("div",{children:[t.jsxs(Le,{children:[t.jsxs(ke,{gutter:[16,16],align:"middle",style:{marginBottom:16},children:[t.jsx(_,{xs:24,sm:12,md:8,lg:6,children:t.jsx(We,{level:4,style:{margin:0},children:"Customers"})}),t.jsx(_,{xs:24,sm:12,md:8,lg:6,children:t.jsx(Ue,{placeholder:"Search by Business Name, Contact Name or Email",prefix:t.jsx(Pe,{}),value:m,onChange:e=>{W(e.target.value),N({...r,current:1})},style:{width:"100%"}})}),t.jsx(_,{xs:24,sm:24,md:8,lg:12,style:{display:"flex",justifyContent:"flex-end"},children:t.jsxs(je,{wrap:!0,children:[t.jsx(v,{icon:t.jsx(ze,{}),onClick:xe,style:{backgroundColor:"#ef7a1b",borderColor:"#ef7a1b",color:"white"},className:"orange-button",children:"Export to PDF"}),t.jsx(v,{icon:t.jsx(Ie,{}),onClick:Se,style:{backgroundColor:"#ef7a1b",borderColor:"#ef7a1b",color:"white"},className:"orange-button",children:"Export to Excel"})]})})]}),t.jsxs(G,{activeKey:u,onChange:le,style:{marginBottom:16},children:[t.jsx(H,{tab:"All Customers"},"all"),R.map(e=>t.jsx(H,{tab:t.jsx("span",{children:e.name})},e._id))]}),L?t.jsx(we,{size:"large",style:{display:"block",margin:"50px auto"}}):I.length>0?t.jsx("div",{id:"customerTable",children:t.jsx(Be,{columns:ye,dataSource:I,rowKey:"_id",pagination:r,onChange:Ce,scroll:{x:"max-content"},className:"customers-table"})}):t.jsx(Ve,{description:"No customers found."})]}),t.jsx(Ne,{visible:te,onClose:()=>A(!1),onSave:de,initialValues:h,allUsers:K,loadingUsers:Q,allZones:R,loadingZones:ee}),t.jsx(Ze,{title:"Confirm Status Change",open:se,onOk:me,onCancel:()=>$(!1),okText:"Yes",cancelText:"No",confirmLoading:L,children:t.jsxs("p",{children:["Are you sure you want to change the status of ",t.jsx("strong",{children:w==null?void 0:w.businessName})," to ",t.jsx("strong",{children:E}),"?"]})}),F&&t.jsxs(t.Fragment,{children:[t.jsx(Ae,{visible:ae,onClose:()=>O(!1),account:F,refreshAccounts:()=>y({current:r.current,pageSize:r.pageSize,searchText:m,zoneId:u})}),t.jsx($e,{visible:oe,onClose:()=>Z(!1),account:F,refreshAccounts:()=>y({current:r.current,pageSize:r.pageSize,searchText:m,zoneId:u})})]})]})};export{_t as default};
