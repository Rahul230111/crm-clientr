import{M as c,r as y,aY as b,$ as ae,E as W,K as e,L as O,N as g,O as l,S as A,Y as h,Z as Q,av as k,aV as G,a4 as J,Q as I,aW as fe,ag as de,aX as be,b1 as q}from"./index-FVmEbnB1.js";import{t as Ie}from"./index-9MkPJsak.js";import{R as Se}from"./MinusCircleOutlined-BotvY0WV.js";import{R as Te}from"./SaveOutlined-DF6IXxnZ.js";import{R as ve}from"./PrinterOutlined-Bp2pzz6Q.js";const{Option:f}=A,{TextArea:Ce}=h,{useToken:Ne}=Ie,Ae=({onCancel:ce,onSave:le,initialValues:o,isSaving:B})=>{var se;const[S]=c.useForm(),[x,T]=y.useState([{id:1,productId:null,productName:"",description:"",hsnSac:"",quantity:1,quantityType:"",rate:0,specifications:[{key:Date.now(),name:"",value:""}]}]),[$,K]=y.useState("pending"),[v,Z]=y.useState(null),[N,ie]=y.useState([]),[R,V]=y.useState(18),[C,me]=y.useState([]),[u,z]=y.useState(null),[j,ee]=y.useState(null),{token:a}=Ne(),s={mainCardTitle:{fontSize:"20px",fontWeight:"bold",color:a.colorPrimary},quotationCard:{borderRadius:a.borderRadiusLG},formField:{width:"100%"},readOnlyFormField:{width:"100%",backgroundColor:a.colorFillAlter,color:a.colorTextDisabled,cursor:"not-allowed"},readOnlyTextArea:{backgroundColor:a.colorFillAlter,color:a.colorTextDisabled},businessInfoCard:{backgroundColor:a.colorFillAlter,borderColor:a.colorBorderSecondary,borderRadius:a.borderRadiusSM},businessInfoPre:{whiteSpace:"pre-wrap",fontFamily:"Roboto, sans-serif",fontSize:a.fontSizeSM,color:a.colorTextSecondary,margin:0},divider:{margin:"24px 0",borderColor:a.colorBorderSecondary},itemCard:{marginBottom:a.margin,borderRadius:a.borderRadius,border:`1px solid ${a.colorBorder}`},deleteButton:{color:a.colorError},specificationDivider:{margin:"16px 0 8px 0",fontSize:a.fontSizeSM,color:a.colorTextSecondary},specificationRow:{marginBottom:a.marginXS},addButton:{width:"100%",borderColor:a.colorPrimaryBorder,color:a.colorPrimary},addSpecButton:{marginTop:a.margin,borderColor:a.colorBorder,color:a.colorTextSecondary},addItemButton:{marginTop:a.margin,borderColor:a.colorBorder,color:a.colorTextSecondary},summaryRow:{marginBottom:a.margin},totalField:{backgroundColor:a.colorFillAlter,color:a.colorText,fontWeight:"bold",fontSize:a.fontSizeLG},grandTotalField:{backgroundColor:a.colorSuccessBg,color:a.colorSuccessText,fontWeight:"bold",fontSize:a.fontSizeXL},notesCard:{backgroundColor:a.colorFillAlter,borderColor:a.colorBorderSecondary,borderRadius:a.borderRadiusSM},noteText:{marginBottom:a.marginXS,color:a.colorTextSecondary},buttonGroup:{marginTop:a.marginXL,textAlign:"right"}},L=y.useRef(!1),_=y.useRef(!1),ue=()=>{try{const t=JSON.parse(localStorage.getItem("user"));return(t==null?void 0:t.email)||"Unknown"}catch{return"Unknown"}},F=y.useCallback(t=>{var r,n;return t?`
${(r=t.businessName)==null?void 0:r.toUpperCase()}
${t.contactName?`Mr. ${(n=t.contactName)==null?void 0:n.toUpperCase()}`:""}
${t.addressLine1||""}${t.addressLine2?", "+t.addressLine2:""}
${t.city||""}${t.pincode?" - "+t.pincode:""}
${t.state||""}, ${t.country||""}
${t.gstNumber||""}
`.trim():""},[]),te=y.useCallback(async()=>{if(L.current)return;L.current=!0;const t=b.loading("Loading business options...");try{const r=await ae.get("/api/invoices/leads/active");ie(r.data),b.success("Business options loaded",{id:t})}catch(r){b.error("Failed to load businesses",{id:t}),console.error("Error fetching business options:",r),L.current=!1}},[]),ne=y.useCallback(async()=>{if(_.current)return;_.current=!0;const t=b.loading("Loading product options...");try{const r=await ae.get("/api/product");me(r.data.map(n=>({...n,hsnSac:n.hsnSac||"",quantityType:n.quantityType||"",options:n.options||[]}))),b.success("Product options loaded",{id:t})}catch(r){b.error("Failed to load products",{id:t}),console.error("Error fetching product options:",r),_.current=!1}},[]);y.useEffect(()=>{te(),ne()},[te,ne]),y.useEffect(()=>{var t;if(o&&C.length>0&&N.length>0){console.log("Initial Values Effect triggered."),console.log("initialValues:",o),console.log("productOptions:",C);const r=((t=o.businessId)==null?void 0:t._id)||o.businessId,n=N.find(d=>d._id===r);S.setFieldsValue({...o,date:o.date?W(o.date):null,dueDate:o.dueDate?W(o.dueDate):null,paymentStatus:o.paymentStatus||"pending",invoiceType:"Invoice",gstType:o.gstType||null,businessName:n==null?void 0:n.businessName,businessType:n==null?void 0:n.type,businessInfo:n?F(n):"",gstin:(n==null?void 0:n.gstNumber)||"",businessId:n==null?void 0:n._id,contactName:o.contactName||"",email:o.email||"",mobileNumber:o.mobileNumber||""});const i=o.items.map(d=>{var D;const m=((D=d.productId)==null?void 0:D._id)||d.productId,p=C.find(M=>M._id===m);return console.log("--- Item Processing ---"),console.log("Original item.productId:",d.productId),console.log("ID used for lookup (currentProductId):",m),console.log("Found product:",p),{...d,id:d.id||Date.now()+Math.random(),productId:m,productName:d.productName||(p?p.productName||p.name:d.description||"Product Not Found"),rate:d.rate||(p?p.price:0),description:d.description||(p?p.description:""),hsnSac:d.hsnSac||(p?p.hsnSac:""),quantityType:d.quantityType||(p?p.quantityType:""),specifications:d.specifications||(p&&p.options?p.options.map(M=>({key:Date.now()+Math.random(),name:M.type||"",value:M.description||""})):[{key:Date.now()+Math.random(),name:"",value:""}])}});T(i),console.log("Updated Items after mapping:",i),K(o.paymentStatus||"pending"),Z(o.dueDate?W(o.dueDate):null),ee(o.gstType||null),V(o.gstPercentage||18),n&&z(n)}},[o,C,N,S,F]);const pe=()=>{const t=Math.max(0,...x.map(r=>r.id))+1;T([...x,{id:t,productId:null,productName:"",description:"",hsnSac:"",quantity:1,quantityType:"",rate:0,specifications:[{key:Date.now()+Math.random(),name:"",value:""}]}])},P=(t,r,n)=>{T(x.map(i=>{if(i.id===t){if(r==="productId"){const d=C.find(m=>m._id===n);if(d)return{...i,productId:n,productName:d.productName||d.name,description:d.description||"",hsnSac:d.hsnSac||"",rate:d.price||0,quantityType:d.quantityType||"",specifications:d.options&&d.options.length>0?d.options.map(m=>({key:Date.now()+Math.random(),name:m.type||"",value:m.description||""})):[{key:Date.now()+Math.random(),name:"",value:""}]}}return{...i,[r]:n}}return i}))},he=t=>{T(x.filter(r=>r.id!==t))},re=t=>{T(r=>r.map(n=>n.id===t?{...n,specifications:[...n.specifications,{key:Date.now()+Math.random(),name:"",value:""}]}:n))},ye=(t,r)=>{T(n=>n.map(i=>i.id===t?{...i,specifications:i.specifications.filter(d=>d.key!==r)}:i))},oe=(t,r,n,i)=>{T(d=>d.map(m=>m.id===t?{...m,specifications:m.specifications.map(p=>p.key===r?{...p,[n]:i}:p)}:m))},w=()=>x.reduce((t,r)=>t+(r.quantity||0)*(r.rate||0),0),Y=()=>w()*(R/100),E=()=>j==="interstate"?Y():0,U=()=>j==="intrastate"?Y()/2:0,H=()=>j==="intrastate"?Y()/2:0,X=()=>w()+Y(),xe=t=>{const r=N.find(n=>n._id===t);if(r){z(r);const n=F(r);S.setFieldsValue({businessId:r._id,businessName:r.businessName,businessType:r.type,gstin:r.gstNumber,businessInfo:n,contactName:r.contactName||"",email:r.email||"",mobileNumber:r.mobileNumber||""})}else z(null),S.setFieldsValue({businessId:null,businessName:null,businessType:null,gstin:null,businessInfo:"",contactName:"",email:"",mobileNumber:""})},ge=t=>{var p,D;if(!x||x.length===0){b.error("At least one item is required.");return}if(!j){b.error("Please select a GST type.");return}const r=w(),n=R,i=X(),d={amount:t.newPaymentAmount,method:t.newPaymentMethod,reference:t.newPaymentReference,date:(p=t.newPaymentDate)==null?void 0:p.format("YYYY-MM-DD"),addedBy:ue()},m={...t,date:(D=t.date)==null?void 0:D.format("YYYY-MM-DD"),dueDate:v==null?void 0:v.format("YYYY-MM-DD"),paymentStatus:$,items:x,subTotal:r,gstPercentage:n,totalAmount:i,gstType:j,igstAmount:E(),cgstAmount:U(),sgstAmount:H(),invoiceType:"Invoice",businessName:u==null?void 0:u.businessName,businessType:u==null?void 0:u.type,gstin:u==null?void 0:u.gstNumber,businessInfo:u?F(u):"",contactName:t.contactName,email:t.email,mobileNumber:t.mobileNumber};d.amount&&d.method&&(m.paymentHistory=[...(o==null?void 0:o.paymentHistory)||[],d]),delete m.newPaymentAmount,delete m.newPaymentMethod,delete m.newPaymentReference,delete m.newPaymentDate,le(m)},je=()=>{var m;const t=S.getFieldsValue(!0),r=w(),n=R,i=X(),d={...t,date:(m=t.date)==null?void 0:m.format("YYYY-MM-DD"),dueDate:v==null?void 0:v.format("YYYY-MM-DD"),paymentStatus:$,items:x,subTotal:r,gstPercentage:n,totalAmount:i,gstType:j,igstAmount:E(),cgstAmount:U(),sgstAmount:H(),invoiceNumber:(o==null?void 0:o.invoiceNumber)||"DRAFT",invoiceType:"Invoice",businessName:u==null?void 0:u.businessName,businessType:u==null?void 0:u.type,gstin:u==null?void 0:u.gstNumber,businessInfo:u?F(u):"",contactName:t.contactName,email:t.email,mobileNumber:t.mobileNumber,companyName:"Your Company Name",companyAddress:"Your Company Address Line 1, City, State - PIN, Country",companyGSTIN:"YOURGSTIN12345",notes:(o==null?void 0:o.notes)||[],paymentTerms:(o==null?void 0:o.paymentTerms)||"Payment due within 15 days of invoice date"};localStorage.setItem("invoiceToPrint",JSON.stringify(d)),window.open("/print-invoice","_blank")};return e.jsx(O,{title:e.jsx("span",{style:s.mainCardTitle,children:o?"Edit Invoice":"Create New Invoice"}),loading:B,style:s.quotationCard,children:e.jsxs(c,{form:S,layout:"vertical",onFinish:ge,children:[e.jsxs(g,{gutter:[16,24],children:[e.jsxs(l,{xs:24,md:12,children:[e.jsx(c.Item,{label:"Business Name",name:"businessId",rules:[{required:!0,message:"Please select a business!"}],children:e.jsx(A,{placeholder:"Select business",showSearch:!0,optionFilterProp:"children",filterOption:(t,r)=>((r==null?void 0:r.children)||"").toLowerCase().includes(t.toLowerCase()),onChange:xe,allowClear:!0,style:s.formField,children:N.map(t=>e.jsx(f,{value:t._id,children:t.businessName},t._id))})}),e.jsx(c.Item,{name:"businessName",hidden:!0,children:e.jsx(h,{})})]}),e.jsx(l,{xs:24,md:12,children:e.jsx(c.Item,{name:"businessType",label:"Type",children:e.jsx(h,{readOnly:!0,style:s.readOnlyFormField})})})]}),e.jsxs(g,{gutter:[24],children:[e.jsx(l,{xs:24,md:12,children:e.jsx(c.Item,{label:"Business Info",children:e.jsx(O,{bordered:!0,style:s.businessInfoCard,children:e.jsx("pre",{style:s.businessInfoPre,children:S.getFieldValue("businessInfo")||"Select a business to view details..."})})})}),e.jsx(l,{xs:24,md:12,children:e.jsx(c.Item,{label:"Invoice Type",name:"invoiceType",initialValue:"Invoice",children:e.jsx(h,{readOnly:!0,style:s.readOnlyFormField})})})]}),e.jsxs(g,{gutter:16,children:[(o==null?void 0:o.invoiceNumber)&&e.jsx(l,{span:12,children:e.jsx(c.Item,{label:"Invoice Number",children:e.jsx(h,{value:o.invoiceNumber,readOnly:!0,style:s.readOnlyFormField})})}),e.jsx(l,{span:12,children:e.jsx(c.Item,{label:"GSTIN",name:"gstin",children:e.jsx(h,{readOnly:!0,style:s.readOnlyFormField})})})]}),e.jsxs(g,{gutter:16,children:[e.jsx(l,{span:12,children:e.jsx(c.Item,{label:"Date",name:"date",rules:[{required:!0}],children:e.jsx(Q,{style:s.formField,format:"DD/MM/YYYY"})})}),e.jsx(l,{span:12,children:e.jsx(c.Item,{label:"Due Date",name:"dueDate",children:e.jsx(Q,{style:s.formField,format:"DD/MM/YYYY",value:v,onChange:Z})})})]}),e.jsxs(g,{gutter:16,children:[e.jsx(l,{span:8,children:e.jsx(c.Item,{label:"Contact Person",name:"contactName",rules:[{required:!0,message:"Please enter contact person name!"}],children:e.jsx(h,{style:s.formField})})}),e.jsx(l,{span:8,children:e.jsx(c.Item,{label:"Email",name:"email",rules:[{required:!0,type:"email",message:"Please enter a valid email!"}],children:e.jsx(h,{style:s.formField})})}),e.jsx(l,{span:8,children:e.jsx(c.Item,{label:"Mobile Number",name:"mobileNumber",rules:[{required:!0,message:"Please enter mobile number!"}],children:e.jsx(h,{style:s.formField})})})]}),e.jsx(k,{style:s.divider,children:"Invoice Items"}),x.map((t,r)=>e.jsxs(O,{style:s.itemCard,size:"small",children:[e.jsxs(g,{gutter:[16,16],align:"middle",children:[e.jsxs(l,{xs:24,sm:8,children:["Product Name",e.jsx(c.Item,{label:"Product",noStyle:!0,children:e.jsxs(A,{placeholder:"Search or select a product",showSearch:!0,optionFilterProp:"children",filterOption:(n,i)=>((i==null?void 0:i.children)||"").toLowerCase().includes(n.toLowerCase()),onChange:n=>P(t.id,"productId",n),value:t.productId,style:s.formField,children:[t.productName&&!C.some(n=>n._id===t.productId)&&e.jsx(f,{value:t.productId,children:t.productName},t.productId),C.map(n=>e.jsxs(f,{value:n._id,children:[n.productName||n.name," "]},n._id))]},t.productId||`new-item-${t.id}`)})]}),e.jsxs(l,{xs:12,sm:8,children:["Quantity",e.jsx(c.Item,{label:"Qty",noStyle:!0,children:e.jsx(G,{placeholder:"1",value:t.quantity,onChange:n=>P(t.id,"quantity",n),style:s.formField,min:0})})]}),e.jsxs(l,{xs:24,sm:8,children:["Price (per unit)",e.jsx(c.Item,{label:"Price (per unit)",noStyle:!0,children:e.jsx(G,{prefix:"₹",value:t.rate,onChange:n=>P(t.id,"rate",n),min:0,step:.01,style:s.formField})})]}),e.jsx(l,{xs:24,sm:6,style:{display:"flex",justifyContent:"flex-end",alignItems:"center"},children:x.length>1&&e.jsx(J,{title:"Remove Item",children:e.jsx(I,{icon:e.jsx(fe,{}),danger:!0,onClick:()=>he(t.id),type:"text",style:s.deleteButton})})})]}),e.jsxs(g,{gutter:[16,16],style:{marginTop:a.margin},children:[e.jsxs(l,{xs:24,sm:8,children:["HSN/SAC Code",e.jsx(c.Item,{label:"HSN/SAC Code",noStyle:!0,children:e.jsx(h,{placeholder:"HSN/SAC",value:t.hsnSac,onChange:n=>P(t.id,"hsnSac",n.target.value)})})]}),e.jsxs(l,{xs:24,sm:8,children:["Item Total",e.jsx(c.Item,{label:"Item Total",noStyle:!0,children:e.jsx(h,{value:`₹${((t.quantity||0)*(t.rate||0)).toFixed(2)}`,readOnly:!0,style:s.totalField})})]}),e.jsxs(l,{xs:24,sm:8,children:["Description",e.jsx(c.Item,{label:"Description",noStyle:!0,children:e.jsx(Ce,{placeholder:"Detailed description of the item",value:t.description,onChange:n=>P(t.id,"description",n.target.value),rows:2})})]})]}),t.specifications&&t.specifications.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(k,{orientation:"left",style:s.specificationDivider,children:"Specifications"}),t.specifications.map((n,i)=>e.jsxs(g,{gutter:16,style:s.specificationRow,align:"middle",children:[e.jsx(l,{xs:24,sm:10,children:e.jsx(h,{placeholder:"Specification Name (e.g., Color)",value:n.name,onChange:d=>oe(t.id,n.key,"name",d.target.value),style:s.formField})}),e.jsx(l,{xs:24,sm:10,children:e.jsx(h,{placeholder:"Specification Value (e.g., Blue)",value:n.value,onChange:d=>oe(t.id,n.key,"value",d.target.value),style:s.formField})}),e.jsx(l,{xs:24,sm:4,children:e.jsxs(de,{children:[t.specifications.length>1&&e.jsx(J,{title:"Remove Specification",children:e.jsx(I,{icon:e.jsx(Se,{}),onClick:()=>ye(t.id,n.key),type:"text",danger:!0,style:s.deleteButton})}),i===t.specifications.length-1&&e.jsx(J,{title:"Add New Specification",children:e.jsx(I,{icon:e.jsx(be,{}),onClick:()=>re(t.id),type:"dashed",style:s.addButton})})]})})]},n.key))]}),(!t.specifications||t.specifications.length===0||t.specifications.length>0&&t.specifications[t.specifications.length-1].name&&t.specifications[t.specifications.length-1].value)&&e.jsx(I,{onClick:()=>re(t.id),block:!0,type:"dashed",style:s.addSpecButton,children:"+ Add Specification"})]},t.id)),e.jsx(I,{onClick:pe,block:!0,type:"dashed",style:s.addItemButton,children:"+ Add Another Item"}),e.jsx(k,{style:s.divider,children:"Summary"}),e.jsx(l,{xs:24,md:12,children:e.jsx(c.Item,{name:"gstType",label:"GST Type",rules:[{required:!0,message:"Please select a GST type!"}],children:e.jsxs(A,{placeholder:"Select GST calculation type",onChange:t=>ee(t),value:j,style:s.formField,children:[e.jsx(f,{value:"interstate",children:"Interstate - IGST (Integrated GST)"}),e.jsx(f,{value:"intrastate",children:"Intrastate - SGST/CGST (State/Central GST)"})]})})}),e.jsxs(g,{gutter:[16,16],style:s.summaryRow,children:[e.jsx(l,{xs:24,sm:8,children:e.jsx(c.Item,{label:"Sub Total",children:e.jsx(h,{readOnly:!0,value:`₹${w().toFixed(2)}`,style:s.totalField})})}),e.jsx(l,{xs:24,sm:8,children:e.jsx(c.Item,{label:"GST Rate (%)",children:e.jsx(G,{min:0,max:100,step:.1,value:R,onChange:V,style:s.formField})})}),j==="interstate"&&e.jsx(l,{xs:24,sm:8,children:e.jsx(c.Item,{label:"IGST Amount",children:e.jsx(h,{readOnly:!0,value:`₹${E().toFixed(2)}`,style:s.totalField})})}),j==="intrastate"&&e.jsxs(e.Fragment,{children:[e.jsx(l,{xs:24,sm:8,children:e.jsx(c.Item,{label:"CGST Amount",children:e.jsx(h,{readOnly:!0,value:`₹${U().toFixed(2)}`,style:s.totalField})})}),e.jsx(l,{xs:24,sm:8,children:e.jsx(c.Item,{label:"SGST Amount",children:e.jsx(h,{readOnly:!0,value:`₹${H().toFixed(2)}`,style:s.totalField})})})]}),e.jsx(l,{xs:24,sm:8,children:e.jsx(c.Item,{label:"Grand Total",children:e.jsx(h,{readOnly:!0,value:`₹${X().toFixed(2)}`,style:s.grandTotalField})})})]}),e.jsx(c.Item,{label:"Payment Status",name:"paymentStatus",children:e.jsxs(q.Group,{value:$,onChange:t=>K(t.target.value),children:[e.jsx(q.Button,{value:"pending",children:"Pending"}),e.jsx(q.Button,{value:"partial",children:"Partial"}),e.jsx(q.Button,{value:"paid",children:"Paid"})]})}),e.jsx(k,{children:"Payment History"}),((se=o==null?void 0:o.paymentHistory)==null?void 0:se.length)>0&&e.jsx("div",{style:{marginBottom:16},children:o.paymentHistory.map((t,r)=>e.jsxs(O,{size:"small",style:{marginBottom:8},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Amount:"})," ₹",t.amount]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Method:"})," ",t.method]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Date:"})," ",t.date]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Reference:"})," ",t.reference]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Added By:"})," ",t.addedBy]})]},r))}),e.jsx(k,{children:"Add Payment Entry"}),e.jsxs(g,{gutter:16,children:[e.jsx(l,{span:6,children:e.jsx(c.Item,{label:"Amount",name:"newPaymentAmount",children:e.jsx(G,{min:0,style:s.formField})})}),e.jsx(l,{span:6,children:e.jsx(c.Item,{label:"Method",name:"newPaymentMethod",children:e.jsxs(A,{placeholder:"Select method",style:s.formField,children:[e.jsx(f,{value:"Cash",children:"Cash"}),e.jsx(f,{value:"Bank",children:"Bank"}),e.jsx(f,{value:"UPI",children:"UPI"}),e.jsx(f,{value:"Cheque",children:"Cheque"})]})})}),e.jsx(l,{span:6,children:e.jsx(c.Item,{label:"Reference",name:"newPaymentReference",children:e.jsx(h,{style:s.formField})})}),e.jsx(l,{span:6,children:e.jsx(c.Item,{label:"Date",name:"newPaymentDate",children:e.jsx(Q,{style:s.formField,format:"DD/MM/YYYY"})})})]}),e.jsx(c.Item,{style:s.buttonGroup,children:e.jsxs(de,{size:"middle",children:[e.jsx(I,{onClick:ce,size:"large",disabled:B,children:"Cancel"}),e.jsx(I,{type:"primary",style:{backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},htmlType:"submit",icon:e.jsx(Te,{}),size:"large",loading:B,children:o?"Update Invoice":"Save Invoice"}),e.jsx(I,{icon:e.jsx(ve,{}),size:"large",onClick:je,children:"Print"})]})})]})})};export{Ae as default};
