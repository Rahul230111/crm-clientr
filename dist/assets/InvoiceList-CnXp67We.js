import{r as d,I as He,q as ze,o as ue,p as e,S as ut,C as U,D as pe,V as v,E as te,J as _e,T as Be,F as mt,M as H}from"./index-Bb3iEPMp.js";import{R as pt,E as ht}from"./jspdf.es.min-BTZJM5r9.js";import{a as xt}from"./jspdf.plugin.autotable-CtA5BUKo.js";import{u as ye,w as ft}from"./xlsx-x9ZxUr7s.js";import{I as ne,i as z,R as yt}from"./axios-DCtTpA0N.js";import{F as M}from"./index-JAN9Ufnv.js";import{D as be}from"./index-D6GAQ_u7.js";import{R as gt}from"./SendOutlined-BpXUOk0v.js";import{T as xe,a as ae}from"./index-CYGB0aP3.js";import{s as Ue}from"./index-6PEQyDZM.js";import{D as he,d as ge}from"./index-B7TWxO8Z.js";import{D as j}from"./index-D4qKKYUJ.js";import{S as D}from"./index-fWweIekq.js";import{F,R as jt}from"./Table-BdyiHqL-.js";import{M as le}from"./index-Cj4OrNc-.js";import{P as qe}from"./index-DDpDepK1.js";import{h as re,R as wt}from"./moment-vgxS63qH.js";import{D as Se}from"./index-CVLB7Q99.js";import{T as Ge,R as St}from"./index-cBdIU9Pv.js";import{L as oe}from"./index-D_7VJabU.js";import{C as bt}from"./index-Dp5mNM7X.js";import{a as Tt}from"./index-CkwLvGmr.js";import{R as It}from"./MessageOutlined-EEmKcb3Y.js";import{R as Ft}from"./ScheduleOutlined-GGuVuyYY.js";import{R as Nt}from"./DollarOutlined-B_Yx79t3.js";import{R as Ct}from"./DeleteOutlined-DUY0Gbb0.js";var Dt={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M832 464h-68V240c0-70.7-57.3-128-128-128H388c-70.7 0-128 57.3-128 128v224h-68c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V496c0-17.7-14.3-32-32-32zM332 240c0-30.9 25.1-56 56-56h248c30.9 0 56 25.1 56 56v224H332V240zm460 600H232V536h560v304zM484 701v53c0 4.4 3.6 8 8 8h40c4.4 0 8-3.6 8-8v-53a48.01 48.01 0 10-56 0z"}}]},name:"lock",theme:"outlined"},At=function(_,r){return d.createElement(He,ze({},_,{ref:r,icon:Dt}))},kt=d.forwardRef(At),vt={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M832 464H332V240c0-30.9 25.1-56 56-56h248c30.9 0 56 25.1 56 56v68c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-68c0-70.7-57.3-128-128-128H388c-70.7 0-128 57.3-128 128v224h-68c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V496c0-17.7-14.3-32-32-32zm-40 376H232V536h560v304zM484 701v53c0 4.4 3.6 8 8 8h40c4.4 0 8-3.6 8-8v-53a48.01 48.01 0 10-56 0z"}}]},name:"unlock",theme:"outlined"},Pt=function(_,r){return d.createElement(He,ze({},_,{ref:r,icon:vt}))},$t=d.forwardRef(Pt),me={exports:{}},Et=me.exports,Le;function Mt(){return Le||(Le=1,function(N,_){(function(r,y){y()})(Et,function(){function r(i,o){return typeof o>"u"?o={autoBom:!1}:typeof o!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),o={autoBom:!o}),o.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(i.type)?new Blob(["\uFEFF",i],{type:i.type}):i}function y(i,o,w){var c=new XMLHttpRequest;c.open("GET",i),c.responseType="blob",c.onload=function(){k(c.response,o,w)},c.onerror=function(){console.error("could not download file")},c.send()}function P(i){var o=new XMLHttpRequest;o.open("HEAD",i,!1);try{o.send()}catch{}return 200<=o.status&&299>=o.status}function h(i){try{i.dispatchEvent(new MouseEvent("click"))}catch{var o=document.createEvent("MouseEvents");o.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),i.dispatchEvent(o)}}var g=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof ue=="object"&&ue.global===ue?ue:void 0,$=g.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),k=g.saveAs||(typeof window!="object"||window!==g?function(){}:"download"in HTMLAnchorElement.prototype&&!$?function(i,o,w){var c=g.URL||g.webkitURL,b=document.createElement("a");o=o||i.name||"download",b.download=o,b.rel="noopener",typeof i=="string"?(b.href=i,b.origin===location.origin?h(b):P(b.href)?y(i,o,w):h(b,b.target="_blank")):(b.href=c.createObjectURL(i),setTimeout(function(){c.revokeObjectURL(b.href)},4e4),setTimeout(function(){h(b)},0))}:"msSaveOrOpenBlob"in navigator?function(i,o,w){if(o=o||i.name||"download",typeof i!="string")navigator.msSaveOrOpenBlob(r(i,w),o);else if(P(i))y(i,o,w);else{var c=document.createElement("a");c.href=i,c.target="_blank",setTimeout(function(){h(c)})}}:function(i,o,w,c){if(c=c||open("","_blank"),c&&(c.document.title=c.document.body.innerText="downloading..."),typeof i=="string")return y(i,o,w);var b=i.type==="application/octet-stream",L=/constructor/i.test(g.HTMLElement)||g.safari,X=/CriOS\/[\d]+/.test(navigator.userAgent);if((X||b&&L||$)&&typeof FileReader<"u"){var p=new FileReader;p.onloadend=function(){var T=p.result;T=X?T:T.replace(/^data:[^;]*;/,"data:attachment/file;"),c?c.location.href=T:location=T,c=null},p.readAsDataURL(i)}else{var I=g.URL||g.webkitURL,x=I.createObjectURL(i);c?c.location=x:location.href=x,c=null,setTimeout(function(){I.revokeObjectURL(x)},4e4)}});g.saveAs=k.saveAs=k,N.exports=k})}(me)),me.exports}var Xe=Mt();const{TextArea:Rt}=ne,Ot=({visible:N,onClose:_,account:r,invoice:y,refreshInvoices:P,refreshAccounts:h})=>{const[g]=M.useForm(),[$,k]=d.useState([]),[i,o]=d.useState(!1);d.useEffect(()=>{var I;const p=((I=y||r)==null?void 0:I.notes)||[];k(Array.isArray(p)?p:[])},[y,r]);const w=()=>{try{const p=JSON.parse(localStorage.getItem("user"));return(p==null?void 0:p.name)||(p==null?void 0:p.email)||"Unknown"}catch{return"Unknown"}},c=()=>y?`/api/invoices/${y._id}`:`/api/accounts/${r._id}`,b=async({note:p})=>{if(!p)return;const I={text:p,timestamp:new Date().toISOString(),addedBy:w()},x=[...$,I];try{o(!0),await z.put(c(),{...y||r,notes:x}),Ue.success("Note added"),k(x),g.resetFields(),y?P==null||P():h==null||h()}catch(T){console.error("Failed to add note:",T),Ue.error("Failed to add note")}finally{o(!1)}},X=(p=>{const I={};return p.forEach(x=>{if(!x||typeof x!="object")return;const T=x.timestamp?new Date(x.timestamp).toLocaleDateString():"Unknown Date";I[T]||(I[T]=[]),I[T].push(x)}),I})($);return e.jsx(be,{title:e.jsxs("div",{children:["Notes for ",y?"Invoice":"Account"," ",e.jsxs(xe.Text,{code:!0,children:["#",(y==null?void 0:y.invoiceNumber)||(r==null?void 0:r.businessName)]})]}),open:N,onClose:_,width:450,destroyOnClose:!0,children:e.jsxs(ut,{spinning:i,children:[e.jsx("div",{style:{padding:"0 8px"},children:Object.entries(X).map(([p,I])=>e.jsxs("div",{children:[e.jsx("div",{className:"note-date-header",children:p}),I.map((x,T)=>e.jsxs("div",{className:"note-bubble",children:[e.jsxs("div",{className:"note-meta",children:[x.addedBy||"Unknown"," • ",x.timestamp?new Date(x.timestamp).toLocaleTimeString():""]}),e.jsx("div",{className:"note-text",children:typeof x.text=="string"?x.text:JSON.stringify(x.text)})]},T))]},p))}),e.jsxs(M,{form:g,layout:"vertical",onFinish:b,style:{marginTop:16},children:[e.jsx(M.Item,{name:"note",rules:[{required:!0,message:"Enter note"}],children:e.jsx(Rt,{rows:3,placeholder:"Type your note here..."})}),e.jsx(U,{htmlType:"submit",type:"primary",icon:e.jsx(gt,{}),block:!0,children:"Add Note"})]})]})})},{Text:je}=xe,Yt=({visible:N,onClose:_,invoice:r,refreshInvoices:y})=>{var O;const[P]=M.useForm(),[h]=M.useForm(),[g,$]=d.useState(!1),[k,i]=d.useState({paymentHistory:[]}),[o,w]=d.useState(!1),[c,b]=d.useState(null),[L,X]=d.useState(0),[p,I]=d.useState(0),[x,T]=d.useState(!1),q=u=>{const f=u.paymentHistory.reduce((Y,ie)=>Y+ie.amount,0);if(X(f),r!=null&&r.totalAmount){const Y=r.totalAmount-f;I(Y),T(Y<=.01)}else I(0),T(!1)},se=()=>{try{const u=JSON.parse(localStorage.getItem("user"));return(u==null?void 0:u.email)||"Unknown"}catch{return"Unknown"}},V=async()=>{if(r!=null&&r._id)try{const u=await z.get(`/api/invoices/${r._id}`),f={...u.data,paymentHistory:Array.isArray(u.data.paymentHistory)?u.data.paymentHistory:[]};i(f),q(f)}catch(u){v.error("Failed to fetch invoice details."),console.error("Error fetching invoice:",u),i({paymentHistory:[]}),q({paymentHistory:[]})}};d.useEffect(()=>{N&&V()},[N,r==null?void 0:r._id]),d.useEffect(()=>{q(k)},[r==null?void 0:r.totalAmount,k.paymentHistory]);const Z=async u=>{const f=parseFloat(u.amount);if(isNaN(f)||f<=0){v.error("Please enter a valid positive amount!");return}const Y=k.paymentHistory.reduce((ee,fe)=>ee+fe.amount,0),ie=(r==null?void 0:r.totalAmount)||0;if(Y+f>ie+.01){v.error(`Payment amount exceeds outstanding balance. Outstanding: ₹${(ie-Y).toFixed(2)}`);return}$(!0);try{const ee={...u,date:u.date.format("YYYY-MM-DD"),addedBy:se()};await z.post(`/api/invoices/${r._id}/payments`,ee),v.success("Payment added successfully!"),P.resetFields(),await V(),y()}catch(ee){v.error("Failed to add payment."),console.error("Error adding payment:",ee)}finally{$(!1)}},l=async u=>{try{await z.delete(`/api/invoices/${r._id}/payments/${u}`),v.success("Payment deleted successfully!"),await V(),y()}catch(f){v.error("Failed to delete payment."),console.error("Error deleting payment:",f)}},C=async u=>{try{const f={...u,date:u.date.format("YYYY-MM-DD")};await z.put(`/api/invoices/${r._id}/payments/${c}`,f),v.success("Payment updated successfully!"),w(!1),await V(),y()}catch(f){v.error("Failed to update payment."),console.error("Error updating payment:",f)}},B=[{title:"Amount",dataIndex:"amount",key:"amount",render:u=>`₹${Number(u).toFixed(2)}`},{title:"Method",dataIndex:"method",key:"method"},{title:"Reference",dataIndex:"reference",key:"reference"},{title:"Date",dataIndex:"date",key:"date",render:u=>ge(u).format("DD/MM/YYYY")},{title:"Added By",dataIndex:"addedBy",key:"addedBy"},{title:"Actions",key:"actions",render:(u,f)=>e.jsxs(pe,{size:"middle",children:[e.jsx(U,{type:"link",onClick:()=>{b(f._id),h.setFieldsValue({amount:f.amount,method:f.method,reference:f.reference,date:ge(f.date)}),w(!0)},children:"Edit"}),e.jsx(qe,{title:"Are you sure to delete this payment?",onConfirm:()=>l(f._id),okText:"Yes",cancelText:"No",children:e.jsx(U,{type:"link",danger:!0,children:"Delete"})})]})}];return e.jsxs(be,{title:`Payment History for Invoice #${(r==null?void 0:r.invoiceNumber)||(r==null?void 0:r.proformaNumber)||"N/A"}`,placement:"right",onClose:_,open:N,width:720,children:[e.jsxs(j,{bordered:!0,column:1,size:"small",style:{marginBottom:20},children:[e.jsx(j.Item,{label:"Invoice Total",children:e.jsxs(je,{strong:!0,children:["₹",((O=r==null?void 0:r.totalAmount)==null?void 0:O.toFixed(2))||"0.00"]})}),e.jsx(j.Item,{label:"Total Paid",children:e.jsxs(je,{strong:!0,style:{color:L>0?"green":"inherit"},children:["₹",L.toFixed(2)]})}),e.jsx(j.Item,{label:"Outstanding Balance",children:e.jsxs(je,{strong:!0,style:{color:p>0?"red":"green"},children:["₹",p.toFixed(2)]})})]}),!x&&e.jsxs(e.Fragment,{children:[e.jsx("h3",{children:"Add New Payment"}),e.jsx(M,{form:P,layout:"vertical",onFinish:Z,style:{marginBottom:20},children:e.jsxs(pe,{children:[e.jsx(M.Item,{name:"amount",label:"Amount",rules:[{required:!0,message:"Please input amount!"}],children:e.jsx(ne,{type:"number",step:"0.01"})}),e.jsx(M.Item,{name:"method",label:"Method",rules:[{required:!0,message:"Please select method!"}],children:e.jsxs(D,{style:{width:120},children:[e.jsx(D.Option,{value:"Cash",children:"Cash"}),e.jsx(D.Option,{value:"UPI",children:"UPI"}),e.jsx(D.Option,{value:"Bank Transfer",children:"Bank Transfer"}),e.jsx(D.Option,{value:"Card",children:"Card"})]})}),e.jsx(M.Item,{name:"reference",label:"Reference",children:e.jsx(ne,{})}),e.jsx(M.Item,{name:"date",label:"Date",rules:[{required:!0,message:"Please select date!"}],children:e.jsx(he,{style:{width:"100%"},defaultValue:ge(),format:"DD/MM/YYYY"})}),e.jsx(U,{type:"primary",htmlType:"submit",loading:g,children:"Add Payment"})]})})]}),e.jsx("h3",{children:"Payment History"}),e.jsx(F,{dataSource:k.paymentHistory,columns:B,rowKey:"_id",pagination:!1,scroll:{x:"max-content"}}),e.jsx(le,{open:o,title:"Edit Payment Entry",onCancel:()=>w(!1),onOk:()=>h.submit(),okText:"Update",cancelText:"Cancel",children:e.jsxs(M,{layout:"vertical",form:h,onFinish:C,children:[e.jsx(M.Item,{name:"amount",label:"Amount",rules:[{required:!0}],children:e.jsx(ne,{type:"number"})}),e.jsx(M.Item,{name:"method",label:"Method",rules:[{required:!0}],children:e.jsxs(D,{children:[e.jsx(D.Option,{value:"Cash",children:"Cash"}),e.jsx(D.Option,{value:"UPI",children:"UPI"}),e.jsx(D.Option,{value:"Bank Transfer",children:"Bank Transfer"}),e.jsx(D.Option,{value:"Card",children:"Card"})]})}),e.jsx(M.Item,{name:"reference",label:"Reference",rules:[{required:!0}],children:e.jsx(ne,{})}),e.jsx(M.Item,{name:"date",label:"Date",rules:[{required:!0}],children:e.jsx(he,{style:{width:"100%"},format:"DD/MM/YYYY"})})]})})]})},{TextArea:_t}=ne,{TabPane:we}=Ge,{Text:Ve}=xe,Bt=({visible:N,onClose:_,invoice:r,refreshInvoices:y})=>{const[P,h]=d.useState(""),[g,$]=d.useState(null),[k,i]=d.useState(!1),[o,w]=d.useState([]),[c,b]=d.useState(null);d.useEffect(()=>{N&&(r!=null&&r._id)&&L()},[N,r]);const L=async()=>{try{const l=await z.get(`/api/invoices/${r._id}/followups`);w(l.data||[])}catch(l){console.error("Failed to fetch follow-ups:",l),te.error("Failed to fetch follow-ups")}},X=()=>{if(!P||!g){te.error("Please fill in both date and note fields.");return}const l=JSON.parse(localStorage.getItem("user")),C=l==null?void 0:l._id;if(!C){te.error("User information not found. Please log in.");return}i(!0);const B={date:g.format("YYYY-MM-DD"),note:P,addedBy:C};(c===null?z.post(`/api/invoices/${r._id}/followups`,B):z.put(`/api/invoices/${r._id}/followups/${c}`,B)).then(()=>{te.success(c===null?"Follow-up added successfully!":"Follow-up updated successfully!"),h(""),$(null),b(null),L(),y()}).catch(u=>{var f,Y;console.error("Error saving follow-up:",u),te.error(((Y=(f=u==null?void 0:u.response)==null?void 0:f.data)==null?void 0:Y.message)||"Failed to save follow-up.")}).finally(()=>i(!1))},p=l=>{const C=o[l];h(C.note),$(re(C.date)),b(l)},I=l=>{le.confirm({title:"Delete Follow-up",content:"Are you sure you want to delete this follow-up? This action cannot be undone.",okText:"Yes, Delete",cancelText:"No",okButtonProps:{danger:!0},onOk:()=>{z.delete(`/api/invoices/${r._id}/followups/${l}`).then(()=>{te.success("Follow-up deleted successfully!"),L(),y()}).catch(C=>{var B,O;console.error("Error deleting follow-up:",C),te.error(((O=(B=C==null?void 0:C.response)==null?void 0:B.data)==null?void 0:O.message)||"Failed to delete follow-up.")})}})},x=re().format("YYYY-MM-DD"),T=[...o].sort((l,C)=>new Date(C.date)-new Date(l.date)),q=T.filter(l=>re(l.date).format("YYYY-MM-DD")===x),se=T.filter(l=>re(l.date).isAfter(x,"day")),V=T.filter(l=>re(l.date).isBefore(x,"day")),Z=(l,C)=>{var B,O;return e.jsx(oe.Item,{actions:[e.jsx(U,{type:"link",onClick:()=>p(C),children:"Edit"},"edit"),e.jsx(U,{type:"link",danger:!0,onClick:()=>I(C),children:"Delete"},"delete")],children:e.jsxs("div",{children:[e.jsx(Ve,{strong:!0,children:re(l.date).format("DD-MM-YYYY")}),e.jsx("br",{}),l.note,e.jsx("br",{}),e.jsxs(Ve,{type:"secondary",children:["By ",((B=l.addedBy)==null?void 0:B.name)||((O=l.addedBy)==null?void 0:O.email)||"Unknown User"]})]})})};return e.jsxs(be,{title:`Follow-ups for Invoice: ${(r==null?void 0:r.invoiceNumber)||(r==null?void 0:r.proformaNumber)||"N/A"}`,open:N,onClose:()=>{b(null),h(""),$(null),_()},width:720,children:[e.jsxs("div",{style:{marginBottom:20},children:[e.jsx(he,{style:{width:"100%",marginBottom:8},format:"DD-MM-YYYY",value:g,onChange:l=>$(l),placeholder:"Select follow-up date"}),e.jsx(_t,{rows:4,placeholder:"Enter follow-up note",value:P,onChange:l=>h(l.target.value)}),e.jsx(U,{type:"primary",block:!0,onClick:X,loading:k,style:{marginTop:10},children:c===null?"Add Follow-up":"Update Follow-up"})]}),e.jsx(Se,{children:"Existing Follow-ups"}),e.jsxs(Ge,{defaultActiveKey:"today",children:[e.jsx(we,{tab:`Today's (${q.length})`,children:e.jsx(oe,{dataSource:q,renderItem:l=>Z(l,o.indexOf(l)),locale:{emptyText:"No follow-ups scheduled for today."}})},"today"),e.jsx(we,{tab:`Upcoming (${se.length})`,children:e.jsx(oe,{dataSource:se,renderItem:l=>Z(l,o.indexOf(l)),locale:{emptyText:"No upcoming follow-ups."}})},"upcoming"),e.jsx(we,{tab:`Past (${V.length})`,children:e.jsx(oe,{dataSource:V,renderItem:l=>Z(l,o.indexOf(l)),locale:{emptyText:"No past follow-ups."}})},"past")]})]})},{Text:m}=xe,{RangePicker:Ut}=he,Lt=({invoices:N,onAddNew:_,onEdit:r,onDelete:y,onSearch:P,refreshInvoices:h})=>{var Ne,Ce,De,Ae,ke,ve,Pe;const[g,$]=d.useState(""),[k,i]=d.useState(!1),[o,w]=d.useState(null),[c,b]=d.useState("all"),[L,X]=d.useState(!1),[p,I]=d.useState(!1),[x,T]=d.useState(!1),[q,se]=d.useState(null),[V,Z]=d.useState("all"),[l,C]=d.useState("Invoice"),[B,O]=d.useState(!1),[u,f]=d.useState({}),[Y,ie]=d.useState("all"),ee=[...new Set(N.map(t=>t.businessName))],fe=t=>{var s;const n=parseFloat(t.totalAmount)||0,a=((s=t.paymentHistory)==null?void 0:s.reduce((R,S)=>R+parseFloat(S.amount||0),0))||0;return n<=0?"N/A":a>=n-.01?"paid":a>0&&a<n?"partial":"pending"};d.useEffect(()=>{const t={};N.forEach(n=>{t[n._id]=fe(n)}),f(t)},[N]);const G=t=>{const n=["","One","Two","Three","Four","Five","Six","Seven","Eight","Nine"],a=["Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"],s=["","Ten","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"];return t===0?"Zero":t<10?n[t]:t<20?a[t-10]:t<100?s[Math.floor(t/10)]+(t%10?" "+n[t%10]:""):t<1e3?n[Math.floor(t/100)]+" Hundred"+(t%100?" and "+G(t%100):""):t<1e5?G(Math.floor(t/1e3))+" Thousand"+(t%1e3?" "+G(t%1e3):""):t<1e7?G(Math.floor(t/1e5))+" Lakh"+(t%1e5?" "+G(t%1e5):""):G(Math.floor(t/1e7))+" Crore"+(t%1e7?" "+G(t%1e7):"")},E=t=>isNaN(t)?"0.00":t.toLocaleString("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2}),We=t=>{try{const n=new ht({orientation:"portrait",unit:"mm",format:"a4"});n.setProperties({title:`${t.invoiceType} - ${t.invoiceNumber||t.proformaNumber}`,subject:"Invoice",author:"Your Company Name",keywords:"invoice, billing",creator:"Invoice Management System"});const a=15;let s=a;n.setFontSize(16),n.setTextColor(0,0,0),n.setFont("helvetica","bold"),n.text(t.invoiceType==="Proforma"?"PROFORMA INVOICE":"TAX INVOICE",105,s,{align:"center"}),s+=10,n.setFontSize(10),n.setTextColor(0,0,0),n.setFont("helvetica","bold"),n.text("Your Company Name",a,s),n.setFont("helvetica","normal"),n.text("Your Company Address Line 1",a,s+5),n.text("Your Company Address Line 2",a,s+10),n.text("City, State - PIN, Country",a,s+15),n.text(`GSTIN: ${t.companyGSTIN||"XXXXXXXXXXXXXXX"}`,a,s+20),s+=30,n.setFontSize(10),n.setFont("helvetica","bold"),n.text(`Bill To: ${t.customerName||"N/A"}`,a,s),n.text(`${t.invoiceType==="Proforma"?"Proforma No":"Invoice No"}: ${t.invoiceType==="Proforma"?t.proformaNumber:t.invoiceNumber||"N/A"}`,140,s),s+=5,n.text(`Contact: ${t.contactPerson||"N/A"}`,a,s),n.text(`Date: ${t.date||new Date().toLocaleDateString()}`,140,s),s+=5,n.text(`Phone: ${t.contactNumber||"N/A"}`,a,s),n.text(`Due Date: ${t.dueDate||"N/A"}`,140,s),s+=5,n.text(`GSTIN: ${t.customerGSTIN||"N/A"}`,a,s),s+=5,n.text(`Address: ${t.customerAddress||"N/A"}`,a,s),s+=10;const R=(t.items||[]).map((A,lt)=>{var Me,Re,Oe;const it=((Me=A==null?void 0:A.description)==null?void 0:Me.toString())||"N/A",ct=A!=null&&A.specifications&&A.specifications.length>0?A.specifications.map(Ye=>`${Ye.name}: ${Ye.value}`).join(", "):"N/A",$e=((Re=A==null?void 0:A.quantity)==null?void 0:Re.toString())||"1",Ee=((Oe=A==null?void 0:A.rate)==null?void 0:Oe.toString())||"0",dt=(parseFloat($e)*parseFloat(Ee)).toFixed(2);return[(lt+1).toString(),it,ct,$e,`₹${E(parseFloat(Ee))}`,`₹${E(parseFloat(dt))}`]});xt(n,{head:[["S.No","Description","Specification","Qty","Unit Price (₹)","Total (₹)"]],body:R,startY:s,theme:"grid",headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},styles:{fontSize:9,cellPadding:3,overflow:"linebreak"},columnStyles:{0:{cellWidth:10},1:{cellWidth:50},2:{cellWidth:35},3:{cellWidth:15},4:{cellWidth:25},5:{cellWidth:25}}}),s=n.lastAutoTable.finalY+10,n.setFontSize(10),n.setFont("helvetica","bold"),n.text("Amount Summary:",a,s),s+=5;const S=parseFloat(t.subTotal)||0,W=parseFloat(t.igstAmount)||0,J=parseFloat(t.cgstAmount)||0,K=parseFloat(t.sgstAmount)||0,ce=W+J+K,Q=parseFloat(t.totalAmount)||0;if(n.text("Sub Total:",140,s),n.text(`₹${E(S)}`,200-a,s,{align:"right"}),s+=5,t.gstType==="interstate")n.text(`IGST (${t.gstPercentage||0}%):`,140,s),n.text(`₹${E(W)}`,200-a,s,{align:"right"}),s+=5;else if(t.gstType==="intrastate"){const A=(t.gstPercentage||0)/2;n.text(`CGST (${A}%):`,140,s),n.text(`₹${E(J)}`,200-a,s,{align:"right"}),s+=5,n.text(`SGST (${A}%):`,140,s),n.text(`₹${E(K)}`,200-a,s,{align:"right"}),s+=5}n.text("Grand Total:",140,s),n.text(`₹${E(Q)}`,200-a,s,{align:"right"}),s+=10,n.setFont("helvetica","bold"),n.text("Amount in Words:",a,s),n.setFont("helvetica","normal"),n.text(`${G(Math.floor(Q))} Rupees Only`,a+30,s),s+=15,n.setFontSize(9),n.setFont("helvetica","bold"),n.text("Payment Terms:",a,s),n.setFont("helvetica","normal"),n.text(t.paymentTerms||"Payment due within 15 days of invoice date",a+25,s),s+=10,n.setFontSize(8),n.setFont("helvetica","bold"),n.text("Notes:",a,s),n.setFont("helvetica","normal"),n.text(t.notes||"Thank you for your business!",a+15,s,{maxWidth:180}),s+=15,n.setFontSize(9),n.setFont("helvetica","bold"),n.text("Bank Details:",a,s),n.setFont("helvetica","normal"),n.text("Bank Name: Your Bank Name",a,s+5),n.text("Account Number: XXXXXXXXXXXX",a,s+10),n.text("IFSC Code: XXXXXXXXXX",a,s+15),n.text("Branch: Your Branch Name",a,s+20),s+=30,n.setFontSize(10),n.text("This is Computer Generated Invoice & requires no Signature",105,s,{align:"center"});const de=n.output("blob");Xe.saveAs(de,`${t.invoiceType.toLowerCase()}-${t.invoiceType==="Proforma"?t.proformaNumber:t.invoiceNumber||"draft"}.pdf`)}catch(n){console.error("Error generating PDF:",n),v.error("Failed to generate PDF")}},Te=t=>{$(t),P(t)},Je=t=>{w(t),i(!0)},Ke=t=>{w(t),X(!0)},Qe=t=>{w(t),T(!0)},Ze=t=>{w(t),O(!0)},et=t=>{w(t),I(!0)},tt=async t=>{const n=v.loading("Closing invoice...");try{await z.patch(`/api/invoices/${t}/close`),v.success("Invoice closed successfully",{id:n}),h==null||h()}catch(a){console.error("Error closing invoice:",a),v.error("Failed to close invoice",{id:n})}},nt=async t=>{const n=v.loading("Unlocking invoice...");try{await z.patch(`/api/invoices/${t}/unlock`),v.success("Invoice unlocked successfully",{id:n}),h==null||h()}catch(a){console.error("Error unlocking invoice:",a),v.error("Failed to unlock invoice",{id:n})}},ot=()=>{const t=Ie.map((S,W)=>({SNo:W+1,Number:S.invoiceType==="Proforma"?S.proformaNumber:S.invoiceNumber,Type:S.invoiceType,Business:S.businessName,Customer:S.customerName,TotalAmount:S.totalAmount||0,Date:S.date,DueDate:S.dueDate||"",Status:u[S._id]||S.paymentStatus,Closed:S.isClosed?"Yes":"No",ConversionStatus:S.invoiceType==="Proforma"&&S.conversionStatus||"N/A"})),n=ye.json_to_sheet(t),a=ye.book_new();ye.book_append_sheet(a,n,"Invoices");const s=ft(a,{bookType:"xlsx",type:"array"}),R=new Blob([s],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});Xe.saveAs(R,`Invoices-${new Date().toISOString().split("T")[0]}.xlsx`)},Ie=N.filter(t=>{var K,ce,Q,de;const n=t.invoiceType===l,a=!g||((K=t.invoiceNumber)==null?void 0:K.toLowerCase().includes(g.toLowerCase()))||((ce=t.proformaNumber)==null?void 0:ce.toLowerCase().includes(g.toLowerCase()))||((Q=t.businessName)==null?void 0:Q.toLowerCase().includes(g.toLowerCase()))||((de=t.customerName)==null?void 0:de.toLowerCase().includes(g.toLowerCase())),s=!q||new Date(t.date)>=q[0].toDate()&&new Date(t.date)<=q[1].toDate(),R=u[t._id],S=c==="all"?!0:c==="overdue"?R!=="paid"&&new Date(t.dueDate)<new Date:R===c,W=V==="all"?!0:t.businessName===V,J=Y==="all"?!0:t.invoiceType==="Proforma"&&t.conversionStatus===Y;return n&&a&&s&&S&&W&&J}),Fe=t=>{let n="red",a="Payment Pending";return t==="paid"?(n="green",a="Completed Payment"):t==="partial"&&(n="orange",a="Partial Payment"),e.jsx(ae,{color:n,children:a})},st=e.jsx(pe,{style:{marginBottom:16},children:["Invoice","Proforma"].map(t=>{const n=N.filter(s=>s.invoiceType===t).length,a=l===t;return e.jsxs("span",{onClick:()=>C(t),style:{cursor:"pointer",borderBottom:a?"2px solid #1890ff":"none",color:a?"#1890ff":"#000",fontWeight:a?"600":"normal",paddingBottom:4,marginRight:20},children:[t," (",n,")"]},t)})}),at=()=>[{title:"S.No",width:60,align:"center",render:(t,n,a)=>a+1},{title:"Description",dataIndex:"description",ellipsis:!0,render:(t,n)=>{var a;if(!t&&((a=n.specifications)==null?void 0:a.length)>0){const s=n.specifications.find(R=>R.name==="SPECIFICATION");return s?s.value:"N/A"}return t||"N/A"}},{title:"HSN/SAC",dataIndex:"hsnSac",width:100,align:"center",render:t=>t||"N/A"},{title:"Qty",dataIndex:"quantity",width:80,align:"center",render:t=>parseFloat(t)||0},{title:"Unit Price (₹)",width:140,align:"right",render:(t,n)=>E(n.rate||0)},{title:"Total (₹)",width:140,align:"right",render:(t,n)=>e.jsx(m,{strong:!0,style:{color:"#52c41a"},children:E((n.quantity||0)*(n.rate||0))})}],rt=[{title:"S.No",render:(t,n,a)=>e.jsx(m,{strong:!0,children:a+1}),width:60},{title:"Number",render:(t,n)=>e.jsx(ae,{icon:e.jsx(_e,{}),color:"blue",children:n.invoiceType==="Proforma"?n.proformaNumber:n.invoiceNumber})},{title:"Type",dataIndex:"invoiceType",render:t=>e.jsx(ae,{color:t==="Proforma"?"purple":"cyan",children:t})},{title:"Business",render:(t,n)=>{var s;const a=((s=n.businessId)==null?void 0:s.businessName)||n.businessName;return e.jsx(Be,{title:a,children:e.jsx(m,{strong:!0,children:a})})}},{title:"Customer",render:(t,n)=>{const s=(n.businessId||{}).businessName||n.customerName||"N/A";return e.jsx(Be,{title:s,children:e.jsx(m,{children:s})})}},{title:"Amount",dataIndex:"totalAmount",align:"right",render:t=>e.jsxs(m,{style:{color:"#52c41a"},children:["₹",(t||0).toFixed(2)]})},{title:"Date",dataIndex:"date",align:"center",render:t=>e.jsx(m,{children:t||"N/A"})},{title:"Due Date",dataIndex:"dueDate",align:"center",render:t=>e.jsx(m,{children:t||"N/A"})},{title:"Payment Status",key:"paymentStatusLabel",align:"center",render:(t,n)=>{const a=u[n._id]||"pending";return Fe(a)}},{title:"Actions",width:80,render:(t,n)=>e.jsx(mt,{overlay:e.jsxs(H,{children:[e.jsx(H.Item,{icon:e.jsx(yt,{}),onClick:()=>Je(n),children:"View Invoice Details"},"view"),e.jsx(H.Item,{icon:e.jsx(_e,{}),onClick:()=>Ze(n),children:"View Item Specifications"},"view-specs"),e.jsx(H.Item,{icon:e.jsx(pt,{}),onClick:()=>We(n),children:"Generate PDF"},"generate-pdf"),e.jsx(H.Item,{icon:e.jsx(It,{}),onClick:()=>Ke(n),children:"View Notes"},"view-notes"),e.jsx(H.Item,{icon:e.jsx(Ft,{}),onClick:()=>et(n),children:"Add/View Follow-ups"},"add-followup"),e.jsx(H.Item,{icon:e.jsx(Nt,{}),onClick:()=>Qe(n),children:"View Payments"},"view-payments"),!n.isClosed&&e.jsx(H.Item,{icon:e.jsx(jt,{}),onClick:()=>r(n),children:"Edit Invoice"},"edit"),n.isClosed?e.jsx(H.Item,{icon:e.jsx($t,{}),onClick:()=>{le.confirm({title:"Unlock Invoice",content:"Are you sure you want to unlock this invoice? It will become editable again.",okText:"Yes, Unlock",cancelText:"No",onOk:()=>nt(n._id)})},children:"Unlock Invoice"},"unlock"):e.jsx(H.Item,{icon:e.jsx(kt,{}),onClick:()=>{le.confirm({title:"Close Invoice",content:"Are you sure you want to close this invoice? It will become uneditable.",okText:"Yes, Close",cancelText:"No",okButtonProps:{danger:!0},onOk:()=>tt(n._id)})},children:"Lock Invoice"},"lock"),e.jsx(H.Item,{icon:e.jsx(Ct,{}),children:e.jsx(qe,{title:"Are you sure you want to delete this invoice?",onConfirm:()=>y(n._id),okText:"Yes",cancelText:"No",children:"Delete Invoice"})},"delete")]}),trigger:["click"],children:e.jsx(U,{icon:e.jsx(wt,{})})})}];return e.jsxs(e.Fragment,{children:[e.jsxs(bt,{title:"Invoice Management",extra:e.jsxs(pe,{wrap:!0,children:[e.jsx(Ut,{onChange:se,format:"YYYY-MM-DD"}),e.jsxs(D,{value:c,onChange:b,style:{width:140},children:[e.jsx(D.Option,{value:"all",children:"All Status"}),e.jsx(D.Option,{value:"paid",children:"Paid"}),e.jsx(D.Option,{value:"pending",children:"Pending"}),e.jsx(D.Option,{value:"partial",children:"Partial"}),e.jsx(D.Option,{value:"overdue",children:"Overdue"})]}),e.jsxs(D,{value:V,onChange:Z,placeholder:"Filter by Business",style:{width:200},allowClear:!0,children:[e.jsx(D.Option,{value:"all",children:"All Businesses"}),ee.map(t=>e.jsx(D.Option,{value:t,children:t},t))]}),e.jsx(ne.Search,{placeholder:"Search invoices",onSearch:Te,onChange:t=>Te(t.target.value),style:{width:240},allowClear:!0,prefix:e.jsx(Tt,{})}),e.jsx(U,{onClick:ot,children:"Export Excel"}),e.jsx(U,{type:"primary",icon:e.jsx(St,{}),onClick:_,children:"New Invoice"})]}),children:[st,e.jsx(F,{dataSource:Ie,columns:rt,rowKey:"_id",pagination:{pageSize:10},bordered:!0,scroll:{x:!0}})]}),e.jsx(le,{title:"Invoice Details",open:k,onCancel:()=>i(!1),footer:e.jsx(U,{onClick:()=>i(!1),children:"Close"}),width:1e3,children:o&&e.jsxs("div",{children:[e.jsxs(j,{bordered:!0,column:2,size:"small",children:[e.jsx(j.Item,{label:o.invoiceType==="Proforma"?"Proforma No":"Invoice No",children:o.invoiceType==="Proforma"?o.proformaNumber:o.invoiceNumber}),e.jsx(j.Item,{label:"Type",children:o.invoiceType}),e.jsx(j.Item,{label:"Date",children:o.date?new Date(o.date).toLocaleDateString("en-IN"):"N/A"}),e.jsx(j.Item,{label:"Due Date",children:o.dueDate?new Date(o.dueDate).toLocaleDateString("en-IN"):"N/A"}),e.jsx(j.Item,{label:"Business",children:o.businessName}),e.jsx(j.Item,{label:"Customer",children:o.customerName}),e.jsx(j.Item,{label:"GSTIN",span:2,children:e.jsx(m,{code:!0,children:o.gstin||"N/A"})}),e.jsx(j.Item,{label:"Business Info",span:2,children:e.jsx(m,{style:{whiteSpace:"pre-wrap"},children:o.businessInfo||"N/A"})})]}),((Ne=o.items)==null?void 0:Ne.length)>0&&e.jsxs(e.Fragment,{children:[e.jsxs(Se,{orientation:"left",children:["Items (",o.items.length,")"]}),e.jsx(F,{dataSource:o.items,columns:at(),pagination:!1,size:"small",rowKey:(t,n)=>`${o._id}-item-${n}`,bordered:!0,expandable:{expandedRowRender:t=>{var n;return e.jsx("div",{style:{margin:0,padding:0},children:((n=t.specifications)==null?void 0:n.length)>0&&e.jsx(j,{column:1,size:"small",children:t.specifications.filter(a=>a.name!=="SPECIFICATION").map((a,s)=>e.jsx(j.Item,{label:a.name,children:a.value},s))})})},rowExpandable:t=>{var n;return((n=t.specifications)==null?void 0:n.length)>0}},summary:t=>{const n=t.reduce((ce,Q)=>ce+(Q.quantity||0)*(Q.rate||0),0),a=o.gstPercentage||0,s=o.gstType||"intrastate";let R=0,S=0,W=0,J=0;s==="interstate"?(J=n*(a/100),R=J):(S=n*(a/200),W=n*(a/200),R=S+W);const K=n+R;return e.jsxs(F.Summary,{fixed:!0,children:[e.jsxs(F.Summary.Row,{children:[e.jsx(F.Summary.Cell,{index:0,colSpan:5,align:"right",children:e.jsx(m,{strong:!0,children:"Sub Total:"})}),e.jsx(F.Summary.Cell,{index:5,children:e.jsx(m,{strong:!0,children:E(n)})})]}),s==="interstate"?e.jsxs(F.Summary.Row,{children:[e.jsx(F.Summary.Cell,{index:0,colSpan:5,align:"right",children:e.jsxs(m,{strong:!0,children:["IGST (",a,"%):"]})}),e.jsx(F.Summary.Cell,{index:5,children:e.jsx(m,{strong:!0,children:E(J)})})]}):e.jsxs(e.Fragment,{children:[e.jsxs(F.Summary.Row,{children:[e.jsx(F.Summary.Cell,{index:0,colSpan:5,align:"right",children:e.jsxs(m,{strong:!0,children:["CGST (",a/2,"%):"]})}),e.jsx(F.Summary.Cell,{index:5,children:e.jsx(m,{strong:!0,children:E(S)})})]}),e.jsxs(F.Summary.Row,{children:[e.jsx(F.Summary.Cell,{index:0,colSpan:5,align:"right",children:e.jsxs(m,{strong:!0,children:["SGST (",a/2,"%):"]})}),e.jsx(F.Summary.Cell,{index:5,children:e.jsx(m,{strong:!0,children:E(W)})})]})]}),e.jsxs(F.Summary.Row,{children:[e.jsx(F.Summary.Cell,{index:0,colSpan:5,align:"right",children:e.jsx(m,{strong:!0,children:"Grand Total:"})}),e.jsx(F.Summary.Cell,{index:5,children:e.jsx(m,{strong:!0,style:{color:"#52c41a"},children:E(K)})})]}),e.jsx(F.Summary.Row,{children:e.jsx(F.Summary.Cell,{index:0,colSpan:6,children:e.jsxs(m,{italic:!0,children:["Amount in words:"," ",G(Math.floor(K))," Rupees Only"]})})})]})}})]}),e.jsxs(j,{column:2,bordered:!0,size:"small",style:{marginTop:"20px"},children:[e.jsxs(j.Item,{label:"Sub Total",span:2,children:["₹",((Ce=o.subTotal)==null?void 0:Ce.toFixed(2))||"0.00"]}),o.gstType==="interstate"?e.jsxs(j.Item,{label:"IGST Amount",span:2,children:["₹",((De=o.igstAmount)==null?void 0:De.toFixed(2))||"0.00"]}):e.jsxs(e.Fragment,{children:[e.jsxs(j.Item,{label:"CGST Amount",span:1,children:["₹",((Ae=o.cgstAmount)==null?void 0:Ae.toFixed(2))||"0.00"]}),e.jsxs(j.Item,{label:"SGST Amount",span:1,children:["₹",((ke=o.sgstAmount)==null?void 0:ke.toFixed(2))||"0.00"]})]}),e.jsx(j.Item,{label:"Grand Total",span:2,children:e.jsxs(m,{strong:!0,style:{fontSize:"18px",color:"#52c41a"},children:["₹",((ve=o.totalAmount)==null?void 0:ve.toFixed(2))||"0.00"]})}),e.jsx(j.Item,{label:"Amount in Words",span:2,children:e.jsxs(m,{italic:!0,children:[G(Math.floor(o.totalAmount||0))," ","Rupees Only"]})}),e.jsxs(j.Item,{label:"Status",span:2,children:[Fe(u[o._id])," "]}),e.jsx(j.Item,{label:"Closed",span:2,children:o.isClosed?e.jsx(ae,{color:"red",children:"Yes"}):e.jsx(ae,{color:"green",children:"No"})}),o.invoiceType==="Proforma"&&e.jsx(j.Item,{label:"Conversion Status",span:2,children:e.jsx(ae,{color:o.conversionStatus==="converted"?"green":o.conversionStatus==="rejected"?"red":"blue",children:o.conversionStatus==="converted"?"Converted":o.conversionStatus==="rejected"?"Rejected":"Pending Conversion"})})]}),((Pe=o.notes)==null?void 0:Pe.length)>0&&e.jsxs(e.Fragment,{children:[e.jsxs(Se,{orientation:"left",children:["Notes (",o.notes.length,")"]}),o.notes.map((t,n)=>e.jsxs("div",{style:{marginBottom:8},children:[e.jsx(m,{strong:!0,children:t.author})," on"," ",e.jsx(m,{type:"secondary",children:t.timestamp}),e.jsx("p",{children:t.text})]},n))]})]})}),e.jsx(le,{title:"Item Specifications",open:B,onCancel:()=>O(!1),footer:e.jsx(U,{onClick:()=>O(!1),children:"Close"}),width:800,children:o&&o.items&&e.jsx(oe,{itemLayout:"vertical",dataSource:o.items,renderItem:(t,n)=>e.jsx(oe.Item,{children:e.jsx(oe.Item.Meta,{title:e.jsx(m,{strong:!0,children:t.description||"No Description"}),description:e.jsxs(e.Fragment,{children:[e.jsxs(m,{children:["Quantity: ",t.quantity]}),e.jsx("br",{}),e.jsxs(m,{children:["Rate: ₹",E(t.rate)]}),e.jsx("br",{}),t.hsnSac&&e.jsxs(m,{children:["HSN/SAC: ",t.hsnSac]}),t.specifications&&t.specifications.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),e.jsx(m,{strong:!0,children:"Specifications:"}),e.jsx("ul",{children:t.specifications.map((a,s)=>e.jsxs("li",{children:[a.name,": ",a.value]},s))})]})]})})},n)})}),o&&e.jsx(Ot,{visible:L,onClose:()=>X(!1),invoice:o,refreshInvoices:h}),o&&e.jsx(Bt,{visible:p,onClose:()=>I(!1),invoice:o,refreshInvoices:h}),e.jsx(Yt,{visible:x,onClose:()=>T(!1),invoice:o,refreshInvoices:h})]})},fn=Object.freeze(Object.defineProperty({__proto__:null,default:Lt},Symbol.toStringTag,{value:"Module"}));export{Lt as I,Ot as N,fn as a};
