import{r as n,x as s,B as v,H as q,ao as Ie,ap as b,S as ze,an as i}from"./index-3j2E7pUL.js";import{i as f}from"./axios-CSlAuMiO.js";import{R as Le,h as Fe,E as $e}from"./html2canvas.esm-D5fRu8Us.js";import{u as U,a as Pe}from"./xlsx-CyWl6TWy.js";import{R as De,a as Re,b as Ee,B as Ue,N as _e,F as Be}from"./FollowUpDrawer-CyApDoYa.js";import{I as K}from"./index-CsUGJ7YV.js";import{b as J}from"./TextArea-DELUlYzR.js";import{T as X}from"./index-BrSJe371.js";import{R as Ve}from"./EditOutlined-0_cnfjzU.js";import{R as Oe}from"./MessageOutlined-DZkEco9W.js";import{P as Me}from"./index-CFb1Uy8W.js";import{R as Ze}from"./DeleteOutlined-BAvkxAoL.js";import{C as Ge}from"./index-DhvOivYi.js";import{R as We}from"./PlusOutlined-BdSH2k4o.js";import{T as ee}from"./index-BRTO4pFo.js";import{F as Qe}from"./Table-HKvwWm1_.js";import{E as He}from"./index-DiojptZP.js";import{M as Ye}from"./index-B80iahJ-.js";import{T as qe}from"./index-C-eCguuc.js";import"./index-jd3XYpcD.js";import"./row-BatVd8KW.js";import"./index-DVSodFTC.js";import"./context-DJnMqWkY.js";import"./useClosable-CC1Ls4ip.js";import"./extendsObject-78o_rR5W.js";import"./MinusCircleOutlined-BOYpYwy0.js";import"./index-VOyckxEQ.js";import"./index-MHS1ptoq.js";import"./moment-C5S46NFB.js";import"./index-NsnFnMr_.js";import"./dayjs.min-BAOJIqCz.js";import"./index-BoISyFuH.js";import"./Pagination-Buu9EMH_.js";import"./ActionButton-RId_fRI3.js";import"./styleChecker-D89VOBbV.js";import"./addEventListener-BJarX3AI.js";import"./index-CfNZZRpy.js";import"./InfoCircleFilled-DSywJBHM.js";import"./index-Dgbp67W9.js";const{Title:Ke}=qe,{TabPane:S}=ee,T="/api/accounts",_t=()=>{const[te,A]=n.useState(!1),[F,_]=n.useState(null),[m,se]=n.useState(""),[h,oe]=n.useState("all"),[ae,$]=n.useState(!1),[B,P]=n.useState(null),[D,R]=n.useState(null),[k,re]=n.useState([]),[ne,V]=n.useState(!1),[ie,O]=n.useState(!1),[E,M]=n.useState(null),[N,ce]=n.useState({}),[r,I]=n.useState({current:1,pageSize:10,total:0}),[Je,le]=n.useState({all:0,active:0,customers:0,Pipeline:0,closed:0,quotations:0,TargetLeads:0}),[de,ue]=n.useState([]),[pe,Z]=n.useState(!1),[G,me]=n.useState([]),[ge,W]=n.useState(!1),[he,Q]=n.useState(!0),C=JSON.parse(localStorage.getItem("user")),d=C==null?void 0:C.role,u=C==null?void 0:C._id,H=n.useRef(null),fe=async()=>{Z(!0);try{const e=await f.get("/api/accounts/users");ue(e.data)}catch(e){console.error("Error fetching users:",e),i.error("Failed to load users for assignment.")}finally{Z(!1)}},xe=async()=>{W(!0);try{const e=await f.get("/api/zones");me(e.data)}catch(e){console.error("Error fetching zones:",e),i.error("Failed to load zones.")}finally{W(!1)}},w=async()=>{try{let e=`${T}/counts`;d==="Employee"&&u?e+=`?userId=${u}&role=${d}`:d==="Team Leader"&&u&&(e+=`?teamLeaderId=${u}&role=${d}`);const t=await f.get(e);le(t.data)}catch(e){i.error("Failed to fetch tab counts."),console.error("Fetch counts error:",e)}},x=async(e={})=>{Q(!0);try{const{current:t=r.current,pageSize:o=r.pageSize,searchText:a="",activeTab:c="all",sortBy:g="createdAt",sortOrder:p="desc",filters:l=N}=e,j=c==="all"?"":c;let y=`${T}/paginated?page=${t}&pageSize=${o}&search=${a}`;j&&(y+=`&status=${j}`),g&&(y+=`&sortBy=${g}`),p&&(y+=`&sortOrder=${p}`),Object.keys(l).forEach(L=>{l[L]&&l[L].length>0&&(y+=`&${L}=${l[L].join(",")}`)}),d==="Employee"&&u?y+=`&userId=${u}&role=${d}`:d==="Team Leader"&&u&&(y+=`&teamLeaderId=${u}&role=${d}`);const z=await f.get(y);re(z.data.data),I({...r,current:z.data.page,pageSize:z.data.pageSize,total:z.data.total})}catch(t){i.error("Failed to fetch accounts."),console.error("Fetch accounts error:",t)}finally{Q(!1)}};n.useEffect(()=>{x({current:r.current,pageSize:r.pageSize,searchText:m,activeTab:h}),fe(),xe()},[r.current,r.pageSize,m,h,d,u]),n.useEffect(()=>{w()},[d,u]);const ye=async e=>{var t;try{const o={...e};F?(await f.put(`${T}/${F._id}`,o),i.success("Account updated successfully!")):(await f.post(T,o),i.success("Account created successfully!")),A(!1),x({current:r.current,pageSize:r.pageSize,searchText:m,activeTab:h,filters:N}),w()}catch(o){throw o.response&&o.response.status===409||(i.error("Failed to save account."),console.error("Save account error:",((t=o.response)==null?void 0:t.data)||o.message)),o}},be=e=>{_(e),A(!0)},Se=async e=>{var t;try{await f.delete(`${T}/${e}`),i.success("Account status set to Closed!"),x({current:r.current,pageSize:r.pageSize,searchText:m,activeTab:h,filters:N}),w()}catch(o){i.error("Failed to set account status to Closed."),console.error("Delete account error:",((t=o.response)==null?void 0:t.data)||o.message)}},Ce=e=>{M(e),V(!0)},we=e=>{M(e),O(!0)},Y=(e,t)=>{P(t),R(e),$(!0)},je=async()=>{var e;try{const t={...B,status:D};await f.put(`${T}/${B._id}`,t),i.success(`Account status changed to ${D}!`),x({current:r.current,pageSize:r.pageSize,searchText:m,activeTab:h,filters:N}),w()}catch(t){i.error("Failed to update account status."),console.error("Status update error:",((e=t.response)==null?void 0:e.data)||t.message)}finally{$(!1),P(null),R(null)}},ve=()=>{$(!1),P(null),R(null)},Te=async()=>{const e=H.current;if(!e){i.error("Table content not found for PDF export.");return}i.loading("Generating PDF...",{id:"pdf-toast"});try{const t=await Fe(e,{scale:2}),o=t.toDataURL("image/png"),a=new $e("p","mm","a4"),c=210,g=297,p=t.height*c/t.width;let l=p,j=0;for(a.addImage(o,"PNG",0,j,c,p),l-=g;l>=0;)j=l-p,a.addPage(),a.addImage(o,"PNG",0,j,c,p),l-=g;a.save("Leads_Customers_Details.pdf"),i.success("PDF generated!",{id:"pdf-toast"})}catch(t){console.error("Error generating PDF:",t),i.error("Failed to generate PDF.",{id:"pdf-toast"})}},Ae=()=>{if(k.length===0){i.error("No data to export to Excel.");return}const e=k.map((a,c)=>{var p,l;return{"S.No":c+1+(r.current-1)*r.pageSize,"Business Name":a.businessName,"Contact Name":a.contactName,Email:a.email,"Mobile Number":a.mobileNumber,"Lead Type":a.type,Status:a.status,"Source Type":a.sourceType,"Assigned To":((p=a.assignedTo)==null?void 0:p.name)||"Unassigned","GST Number":a.gstNumber,"Phone Number":a.phoneNumber,"Address Line 1":a.addressLine1,"Address Line 2":a.addressLine2,"Address Line 3":a.addressLine3,Landmark:a.landmark,City:a.city,Pincode:a.pincode,State:a.state,Country:a.country,Website:a.website,"Is Customer":a.isCustomer?"Yes":"No","Created At":new Date(a.createdAt).toLocaleString(),Zone:((l=a.zone)==null?void 0:l.name)||"N/A"}}),t=U.json_to_sheet(e),o=U.book_new();U.book_append_sheet(o,t,"Leads & Customers"),Pe(o,"Leads_Customers_Data.xlsx"),i.success("Data exported to Excel!")},ke=[{title:"S.No",key:"sno",render:(e,t,o)=>o+1+(r.current-1)*r.pageSize,width:60},{title:"Business Name",dataIndex:"businessName",key:"businessName",sorter:!0,filterDropdown:({setSelectedKeys:e,selectedKeys:t,confirm:o,clearFilters:a})=>s.jsxs("div",{style:{padding:8},children:[s.jsx(K,{placeholder:"Search Business Name",value:t[0],onChange:c=>e(c.target.value?[c.target.value]:[]),onPressEnter:()=>o(),style:{marginBottom:8,display:"block"}}),s.jsx(v,{type:"primary",onClick:()=>o(),icon:s.jsx(J,{}),size:"small",style:{width:90,marginRight:8,backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},children:"Search"}),s.jsx(v,{onClick:()=>a(),size:"small",style:{width:90},children:"Reset"})]}),responsive:["xs","sm","md","lg"]},{title:"Contact Name",dataIndex:"contactName",key:"contactName",sorter:!0,responsive:["md","lg"]},{title:"Email",dataIndex:"email",key:"email",responsive:["lg"]},{title:"Product",dataIndex:"selectedProduct",key:"selectedProduct",render:e=>e?e.productName:"N/A",responsive:["md","lg"]},{title:"Mobile Number",dataIndex:"mobileNumber",key:"mobileNumber",responsive:["md","lg"]},{title:"Type of Leads",dataIndex:"typeOfLead",key:"typeOfLead",render:e=>s.jsx(q,{children:e&&e.map(t=>s.jsx(X,{color:"blue",children:t},t))}),responsive:["lg"]},{title:"Status",dataIndex:"status",key:"status",render:e=>{let t;switch(e){case"Active":t="green";break;case"Pipeline":t="orange";break;case"Closed":t="purple";break;case"Customer":t="blue";break;case"Quotations":t="cyan";break;case"TargetLeads":t="gold";break;default:t="gray"}return s.jsx(X,{color:t,children:e})},filters:[{text:"Active",value:"Active"},{text:"Pipeline",value:"Pipeline"},{text:"Closed",value:"Closed"},{text:"Customer",value:"Customer"},{text:"Quotations",value:"Quotations"},{text:"TargetLeads",value:"TargetLeads"}],filterMultiple:!0,responsive:["sm","md","lg"]},{title:"Assigned To",dataIndex:"assignedTo",key:"assignedTo",render:e=>e?e.name:"Unassigned",responsive:["md","lg"]},{title:"Zone",dataIndex:"zone",key:"zone",render:e=>e?e.name:"N/A",sorter:(e,t)=>{var c,g;const o=((c=e.zone)==null?void 0:c.name)||"",a=((g=t.zone)==null?void 0:g.name)||"";return o.localeCompare(a)},responsive:["lg"],filters:G.map(e=>({text:e.name,value:e._id})),onFilter:(e,t)=>{var o;return((o=t.zone)==null?void 0:o._id)===e}},{title:"Source Type",dataIndex:"sourceType",key:"sourceType",filters:[{text:"Direct",value:"Direct"},{text:"Facebook",value:"Facebook"},{text:"Google Ads",value:"Google Ads"},{text:"Website",value:"Website"},{text:"Cold Call",value:"Cold Call"},{text:"Client",value:"Client"},{text:"Tradefair",value:"Tradefair"},{text:"Other",value:"Other"}],onFilter:(e,t)=>{var o;return((o=t.sourceType)==null?void 0:o.indexOf(e))===0},responsive:["lg"]},{title:"Action",key:"action",width:80,render:(e,t)=>s.jsx(Ie,{overlay:s.jsxs(b,{children:[s.jsx(b.Item,{icon:s.jsx(Ve,{}),onClick:()=>be(t),children:"Edit Account"},"edit"),s.jsx(b.Item,{icon:s.jsx(Oe,{}),onClick:()=>Ce(t),children:"View/Add Notes"},"notes"),s.jsx(b.Item,{icon:s.jsx(De,{}),onClick:()=>we(t),children:"View/Add Follow-ups"},"followup"),t.status==="Customer"?s.jsx(b.Item,{onClick:()=>Y("Active",t),children:"Change to Lead"},"change-to-lead"):s.jsx(b.Item,{onClick:()=>Y("Customer",t),children:"Change to Customer"},"change-to-customer"),d==="Superadmin"&&s.jsx(b.Item,{children:s.jsxs(Me,{title:"Are you sure you want to close this account? This will set its status to 'Closed'.",onConfirm:()=>Se(t._id),okText:"Yes",cancelText:"No",children:[s.jsx(Ze,{}),"Close Account"]})},"close-account")]}),trigger:["click"],children:s.jsx(v,{icon:s.jsx(Le,{})})})}],Ne=(e,t,o)=>{I(e);const a=o.field,c=o.order==="ascend"?"asc":o.order==="descend"?"desc":void 0;ce(t),x({current:e.current,pageSize:e.pageSize,searchText:m,activeTab:h,sortBy:a,sortOrder:c,filters:{status:t.status,sourceType:t.sourceType,zone:t.zone}})};return s.jsxs(Ge,{title:s.jsx(Ke,{level:4,children:"Manage Leads & Customers"}),children:[s.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:"10px"},children:[s.jsx(K,{placeholder:"Search by business or contact name",prefix:s.jsx(J,{}),style:{width:"100%",maxWidth:300},value:m,onChange:e=>{se(e.target.value),I({...r,current:1})}}),s.jsxs(q,{children:[s.jsx(v,{type:"primary",icon:s.jsx(We,{}),style:{backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},onClick:()=>{_(null),A(!0)},children:"Add New Account"}),s.jsx(v,{icon:s.jsx(Re,{}),onClick:Te}),s.jsx(v,{icon:s.jsx(Ee,{}),onClick:Ae})]})]}),s.jsxs(ee,{defaultActiveKey:"all",onChange:e=>{oe(e),I({...r,current:1})},children:[s.jsx(S,{tab:"All Leads"},"all"),s.jsx(S,{tab:"Target Leads "},"TargetLeads"),s.jsx(S,{tab:"Lead "},"Active"),s.jsx(S,{tab:"Enquiry "},"Pipeline"),s.jsx(S,{tab:"Quotations Sent "},"Quotations"),s.jsx(S,{tab:"Converted "},"Customer"),s.jsx(S,{tab:"Closed Accounts "},"Closed")]}),s.jsx("div",{ref:H,children:he?s.jsx(ze,{size:"large",style:{display:"block",margin:"50px auto"}}):k.length>0?s.jsx(Qe,{columns:ke,dataSource:k,rowKey:"_id",scroll:{x:"max-content"},pagination:r,onChange:Ne}):s.jsx(He,{description:"No accounts found."})}),s.jsx(Ue,{visible:te,onClose:()=>A(!1),onSave:ye,initialValues:F,allUsers:de,loadingUsers:pe,allZones:G,loadingZones:ge}),E&&s.jsxs(s.Fragment,{children:[s.jsx(_e,{visible:ne,onClose:()=>V(!1),account:E,refreshAccounts:()=>{x({current:r.current,pageSize:r.pageSize,searchText:m,activeTab:h}),w()}}),s.jsx(Be,{visible:ie,onClose:()=>O(!1),account:E,refreshAccounts:()=>{x({current:r.current,pageSize:r.pageSize,searchText:m,activeTab:h}),w()}})]}),s.jsx(Ye,{title:"Change Account Status",open:ae,onOk:je,onCancel:ve,okText:"Yes",cancelText:"No",children:s.jsxs("p",{children:["Are you sure you want to change this account's status to"," ","**",D,"**?"]})})]})};export{_t as default};
