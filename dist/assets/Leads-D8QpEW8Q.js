import{r as n,ap as Pe,S as X,U as s,a4 as ee,a0 as A,bg as te,ao as se,$ as ae,bh as De,bi as y,aa as Ee,V as Re,bd as _e,bb as oe,an as Ue,a2 as Ve,bz as Be,a3 as Oe,W as Ze,a6 as f,be as l}from"./index-CdWk2t8q.js";import{R as Me,h as We,E as Ge}from"./html2canvas.esm-DyM8d13i.js";import{u as V,a as Qe}from"./xlsx-CyWl6TWy.js";import{R as qe,a as Ye,b as He,B as Ke,N as Je,F as Xe}from"./FollowUpDrawer-DYtgy-LN.js";import{R as et}from"./MessageOutlined-ZwMFkqtk.js";import{P as tt}from"./index-BWEg3k1d.js";import{R as st}from"./DeleteOutlined-ArRDP0IZ.js";import"./MinusCircleOutlined-B1jLPKPS.js";import"./moment-C5S46NFB.js";const{Title:at}=Ze,{TabPane:S}=oe,T="/api/accounts",ht=()=>{const[re,N]=n.useState(!1),[L,B]=n.useState(null),[u,ne]=n.useState(""),[p,le]=n.useState("all"),[ce,P]=n.useState(!1),[O,D]=n.useState(null),[E,R]=n.useState(null),[I,ie]=n.useState([]),[de,Z]=n.useState(!1),[ue,M]=n.useState(!1),[_,W]=n.useState(null),pe=Pe(),[C,G]=n.useState({}),[r,k]=n.useState({current:1,pageSize:10,total:0}),[ot,ge]=n.useState({all:0,active:0,customers:0,Pipeline:0,closed:0,quotations:0,TargetLeads:0}),[me,he]=n.useState([]),[xe,Q]=n.useState(!1),[U,fe]=n.useState([]),[be,q]=n.useState(!1),[ye,Y]=n.useState(!0),j=JSON.parse(localStorage.getItem("user")),d=j==null?void 0:j.role,g=j==null?void 0:j._id,[z,Se]=n.useState("all"),{Option:H}=X,K=n.useRef(null),Ce=async()=>{Q(!0);try{let e="/api/accounts/users";z&&z!=="all"&&(e+=`?zone=${z}`);const t=await f.get(e);he(t.data)}catch(e){console.error("Error fetching users:",e),l.error("Failed to load users for assignment.")}finally{Q(!1)}},je=async()=>{q(!0);try{const e=await f.get("/api/zones");fe(e.data)}catch(e){console.error("Error fetching zones:",e),l.error("Failed to load zones.")}finally{q(!1)}},v=async()=>{try{let e=`${T}/counts`;d==="Employee"&&g?e+=`?userId=${g}&role=${d}`:d==="Team Leader"&&g&&(e+=`?teamLeaderId=${g}&role=${d}`);const t=await f.get(e);ge(t.data)}catch(e){l.error("Failed to fetch tab counts."),console.error("Fetch counts error:",e)}},x=async(e={})=>{Y(!0);try{const{current:t=r.current,pageSize:a=r.pageSize,searchText:o="",activeTab:c="all",sortBy:h="createdAt",sortOrder:m="desc",filters:i=C}=e,w=c==="all"?"":c;let b=`${T}/paginated?page=${t}&pageSize=${a}&search=${o}`;w&&(b+=`&status=${w}`),h&&(b+=`&sortBy=${h}`),m&&(b+=`&sortOrder=${m}`),Object.keys(i).forEach($=>{i[$]&&i[$].length>0&&(b+=`&${$}=${i[$].join(",")}`)}),d==="Employee"&&g?b+=`&userId=${g}&role=${d}`:d==="Team Leader"&&g&&(b+=`&teamLeaderId=${g}&role=${d}`);const F=await f.get(b);ie(F.data.data),k({...r,current:F.data.page,pageSize:F.data.pageSize,total:F.data.total})}catch(t){l.error("Failed to fetch accounts."),console.error("Fetch accounts error:",t)}finally{Y(!1)}};n.useEffect(()=>{x({current:r.current,pageSize:r.pageSize,searchText:u,activeTab:p,filters:C}),Ce(),je()},[r.current,r.pageSize,u,p,d,g,z]),n.useEffect(()=>{v()},[d,g]);const ve=async e=>{var t;try{const a={...e};L?(await f.put(`${T}/${L._id}`,a),l.success("Account updated successfully!")):(await f.post(T,a),l.success("Account created successfully!")),N(!1),x({current:r.current,pageSize:r.pageSize,searchText:u,activeTab:p,filters:C}),v()}catch(a){throw a.response&&a.response.status===409||(l.error("Failed to save account."),console.error("Save account error:",((t=a.response)==null?void 0:t.data)||a.message)),a}},we=e=>{B(e),N(!0)},Ae=async e=>{var t;try{await f.delete(`${T}/${e}`),l.success("Account status set to Closed!"),x({current:r.current,pageSize:r.pageSize,searchText:u,activeTab:p,filters:C}),v()}catch(a){l.error("Failed to set account status to Closed."),console.error("Delete account error:",((t=a.response)==null?void 0:t.data)||a.message)}},Te=e=>{W(e),Z(!0)},ke=e=>{W(e),M(!0)},J=(e,t)=>{D(t),R(e),P(!0)},ze=async()=>{var e;try{const t={...O,status:E};await f.put(`${T}/${O._id}`,t),l.success(`Account status changed to ${E}!`),x({current:r.current,pageSize:r.pageSize,searchText:u,activeTab:p,filters:C}),v()}catch(t){l.error("Failed to update account status."),console.error("Status update error:",((e=t.response)==null?void 0:e.data)||t.message)}finally{P(!1),D(null),R(null)}},Ne=()=>{P(!1),D(null),R(null)},Ie=async()=>{const e=K.current;if(!e){l.error("Table content not found for PDF export.");return}l.loading("Generating PDF...",{id:"pdf-toast"});try{const t=await We(e,{scale:2}),a=t.toDataURL("image/png"),o=new Ge("p","mm","a4"),c=210,h=297,m=t.height*c/t.width;let i=m,w=0;for(o.addImage(a,"PNG",0,w,c,m),i-=h;i>=0;)w=i-m,o.addPage(),o.addImage(a,"PNG",0,w,c,m),i-=h;o.save("Leads_Customers_Details.pdf"),l.success("PDF generated!",{id:"pdf-toast"})}catch(t){console.error("Error generating PDF:",t),l.error("Failed to generate PDF.",{id:"pdf-toast"})}},Fe=()=>{if(I.length===0){l.error("No data to export to Excel.");return}const e=I.map((o,c)=>{var m,i;return{"S.No":c+1+(r.current-1)*r.pageSize,"Business Name":o.businessName,"Contact Name":o.contactName,Email:o.email,"Mobile Number":o.mobileNumber,"Lead Type":o.type,Status:o.status,"Source Type":o.sourceType,"Assigned To":((m=o.assignedTo)==null?void 0:m.name)||"Unassigned","GST Number":o.gstNumber,"Phone Number":o.phoneNumber,"Address Line 1":o.addressLine1,"Address Line 2":o.addressLine2,"Address Line 3":o.addressLine3,Landmark:o.landmark,City:o.city,Pincode:o.pincode,State:o.state,Country:o.country,Website:o.website,"Is Customer":o.isCustomer?"Yes":"No","Created At":new Date(o.createdAt).toLocaleString(),Zone:((i=o.zone)==null?void 0:i.name)||"N/A"}}),t=V.json_to_sheet(e),a=V.book_new();V.book_append_sheet(a,t,"Leads & Customers"),Qe(a,"Leads_Customers_Data.xlsx"),l.success("Data exported to Excel!")},$e=[{title:"S.No",key:"sno",render:(e,t,a)=>a+1+(r.current-1)*r.pageSize,width:60},{title:"Business Name",dataIndex:"businessName",key:"businessName",sorter:!0,filterDropdown:({setSelectedKeys:e,selectedKeys:t,confirm:a,clearFilters:o})=>s.jsxs("div",{style:{padding:8},children:[s.jsx(ee,{placeholder:"Search Business Name",value:t[0],onChange:c=>e(c.target.value?[c.target.value]:[]),onPressEnter:()=>a(),style:{marginBottom:8,display:"block"}}),s.jsx(A,{type:"primary",onClick:()=>a(),icon:s.jsx(te,{}),size:"small",style:{width:90,marginRight:8,backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},children:"Search"}),s.jsx(A,{onClick:()=>o(),size:"small",style:{width:90},children:"Reset"})]}),responsive:["xs","sm","md","lg"],render:(e,t)=>p==="Pipeline"?s.jsx("a",{style:{color:"#1890ff",cursor:"pointer"},onClick:()=>pe(`/leads/enquiry/${t._id}`),children:e}):e},{title:"Contact Name",dataIndex:"contactName",key:"contactName",sorter:!0,responsive:["md","lg"]},{title:"Email",dataIndex:"email",key:"email",responsive:["lg"]},{title:"Product",dataIndex:"selectedProduct",key:"selectedProduct",render:e=>e?e.productName:"N/A",responsive:["md","lg"]},{title:"Mobile Number",dataIndex:"mobileNumber",key:"mobileNumber",responsive:["md","lg"]},{title:"Type of Leads",dataIndex:"typeOfLead",key:"typeOfLead",render:e=>s.jsx(se,{children:e&&e.map(t=>s.jsx(ae,{color:"blue",children:t},t))}),responsive:["lg"]},{title:"Status",dataIndex:"status",key:"status",render:e=>{let t;switch(e){case"Active":t="green";break;case"Pipeline":t="orange";break;case"Closed":t="purple";break;case"Customer":t="blue";break;case"Quotations":t="cyan";break;case"TargetLeads":t="gold";break;default:t="gray"}return s.jsx(ae,{color:t,children:e})},filters:[{text:"Active",value:"Active"},{text:"Pipeline",value:"Pipeline"},{text:"Closed",value:"Closed"},{text:"Customer",value:"Customer"},{text:"Quotations",value:"Quotations"},{text:"TargetLeads",value:"TargetLeads"}],filterMultiple:!0,responsive:["sm","md","lg"]},{title:"Assigned To",dataIndex:"assignedTo",key:"assignedTo",render:e=>e?e.name:"Unassigned",responsive:["md","lg"]},{title:"Zone",dataIndex:"zone",key:"zone",render:e=>e?e.name:"N/A",sorter:(e,t)=>{var c,h;const a=((c=e.zone)==null?void 0:c.name)||"",o=((h=t.zone)==null?void 0:h.name)||"";return a.localeCompare(o)},responsive:["lg"],filters:U.map(e=>({text:e.name,value:e._id})),onFilter:(e,t)=>{var a;return((a=t.zone)==null?void 0:a._id)===e}},{title:"Source Type",dataIndex:"sourceType",key:"sourceType",filters:[{text:"Direct",value:"Direct"},{text:"Facebook",value:"Facebook"},{text:"Google Ads",value:"Google Ads"},{text:"Website",value:"Website"},{text:"Cold Call",value:"Cold Call"},{text:"Client",value:"Client"},{text:"Tradefair",value:"Tradefair"},{text:"Other",value:"Other"}],onFilter:(e,t)=>{var a;return((a=t.sourceType)==null?void 0:a.indexOf(e))===0},responsive:["lg"]},{title:"Action",key:"action",width:80,render:(e,t)=>s.jsx(De,{overlay:s.jsxs(y,{children:[s.jsx(y.Item,{icon:s.jsx(Ee,{}),onClick:()=>we(t),children:"Edit Account"},"edit"),s.jsx(y.Item,{icon:s.jsx(et,{}),onClick:()=>Te(t),children:"View/Add Notes"},"notes"),s.jsx(y.Item,{icon:s.jsx(qe,{}),onClick:()=>ke(t),children:"View/Add Follow-ups"},"followup"),t.status==="Customer"?s.jsx(y.Item,{onClick:()=>J("Active",t),children:"Change to Lead"},"change-to-lead"):s.jsx(y.Item,{onClick:()=>J("Customer",t),children:"Change to Customer"},"change-to-customer"),d==="Superadmin"&&s.jsx(y.Item,{children:s.jsxs(tt,{title:"Are you sure you want to close this account? This will set its status to 'Closed'.",onConfirm:()=>Ae(t._id),okText:"Yes",cancelText:"No",children:[s.jsx(st,{}),"Close Account"]})},"close-account")]}),trigger:["click"],children:s.jsx(A,{icon:s.jsx(Me,{})})})}],Le=(e,t,a)=>{k(e);const o=a.field,c=a.order==="ascend"?"asc":a.order==="descend"?"desc":void 0;G(t),x({current:e.current,pageSize:e.pageSize,searchText:u,activeTab:p,sortBy:o,sortOrder:c,filters:{status:t.status,sourceType:t.sourceType,zone:t.zone}})};return s.jsxs(Re,{title:s.jsx(at,{level:4,children:"Manage Leads & Customers"}),children:[s.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:"10px"},children:[s.jsx(ee,{placeholder:"Search by business or contact name",prefix:s.jsx(te,{}),style:{width:"100%",maxWidth:300},value:u,onChange:e=>{ne(e.target.value),k({...r,current:1})}}),s.jsxs(se,{children:[s.jsxs(X,{defaultValue:"all",style:{width:150},value:z,onChange:e=>{Se(e),k({...r,current:1});const t={...C,zone:e==="all"?[]:[e]};G(t),x({current:1,pageSize:r.pageSize,searchText:u,activeTab:p,filters:t})},children:[s.jsx(H,{value:"all",children:"All Zones"}),U.map(e=>s.jsx(H,{value:e._id,children:e.name},e._id))]}),s.jsx(A,{type:"primary",icon:s.jsx(_e,{}),style:{backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},onClick:()=>{B(null),N(!0)},children:"Add New Account"}),s.jsx(A,{icon:s.jsx(Ye,{}),onClick:Ie}),s.jsx(A,{icon:s.jsx(He,{}),onClick:Fe})]})]}),s.jsxs(oe,{defaultActiveKey:"all",onChange:e=>{le(e),k({...r,current:1})},children:[s.jsx(S,{tab:"All Leads"},"all"),s.jsx(S,{tab:"Target Leads "},"TargetLeads"),s.jsx(S,{tab:"Lead "},"Active"),s.jsx(S,{tab:"Enquiry "},"Pipeline"),s.jsx(S,{tab:"Quotations Sent "},"Quotations"),s.jsx(S,{tab:"Converted "},"Customer"),s.jsx(S,{tab:"Closed Accounts "},"Closed")]}),s.jsx("div",{ref:K,children:ye?s.jsx(Ue,{size:"large",style:{display:"block",margin:"50px auto"}}):I.length>0?s.jsx(Ve,{columns:$e,dataSource:I,rowKey:"_id",scroll:{x:"max-content"},pagination:r,onChange:Le}):s.jsx(Be,{description:"No accounts found."})}),s.jsx(Ke,{visible:re,onClose:()=>N(!1),onSave:ve,initialValues:L,allUsers:me,loadingUsers:xe,allZones:U,loadingZones:be}),_&&s.jsxs(s.Fragment,{children:[s.jsx(Je,{visible:de,onClose:()=>Z(!1),account:_,refreshAccounts:()=>{x({current:r.current,pageSize:r.pageSize,searchText:u,activeTab:p}),v()}}),s.jsx(Xe,{visible:ue,onClose:()=>M(!1),account:_,refreshAccounts:()=>{x({current:r.current,pageSize:r.pageSize,searchText:u,activeTab:p}),v()}})]}),s.jsx(Oe,{title:"Change Account Status",open:ce,onOk:ze,onCancel:Ne,okText:"Yes",cancelText:"No",children:s.jsxs("p",{children:["Are you sure you want to change this account's status to"," ","**",E,"**?"]})})]})};export{ht as default};
