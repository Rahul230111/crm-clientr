import{r as p,V as f,x as e,T as G,B as S,H as W}from"./index-3j2E7pUL.js";import{i as _}from"./axios-CSlAuMiO.js";import{d as X}from"./dayjs.min-BAOJIqCz.js";import{F as l}from"./index-jd3XYpcD.js";import{t as ie}from"./index-BbeVABxr.js";import{C as B}from"./index-DhvOivYi.js";import{D as T}from"./index-MHS1ptoq.js";import{R as y,C as n}from"./row-BatVd8KW.js";import{I as u}from"./index-CsUGJ7YV.js";import{S as P}from"./index-DiojptZP.js";import{D as K}from"./index-NsnFnMr_.js";import{T as le}from"./index-VOyckxEQ.js";import{R as ne}from"./DeleteOutlined-BAvkxAoL.js";import{R as de}from"./MinusCircleOutlined-BOYpYwy0.js";import{R as ce}from"./PlusOutlined-BdSH2k4o.js";import{R as ue}from"./SaveOutlined-CrZtMtWj.js";import"./TextArea-DELUlYzR.js";import"./index-BRTO4pFo.js";const me=t=>({quotationCard:{borderRadius:t.borderRadiusXL,border:`1px solid ${t.colorBorderBg}`,backgroundColor:t.colorBgContainer},mainCardTitle:{color:t.colorPrimary,fontSize:t.fontSizeHeading2,fontWeight:t.fontWeightStronger,textAlign:"center",textTransform:"uppercase",letterSpacing:"1px"},businessInfoCard:{background:`linear-gradient(135deg, ${t.colorFillQuaternary} 0%, ${t.colorFillAlter} 100%)`,border:`1px solid ${t.colorBorderSecondary}`,borderRadius:t.borderRadiusLG,minHeight:"80px",boxShadow:t.boxShadowTertiary,display:"flex",alignItems:"center",transition:"all 0.3s ease-in-out","&:hover":{boxShadow:t.boxShadow,transform:"translateY(-2px)"}},businessInfoPre:{margin:0,whiteSpace:"pre-wrap",flexGrow:1,fontFamily:"monospace",fontSize:t.fontSizeSM,color:t.colorTextSecondary,lineHeight:t.lineHeightSM,opacity:.8},formField:{width:"100%",borderRadius:t.borderRadiusSM,borderColor:t.colorBorder,transition:"all 0.2s ease","&:hover":{borderColor:t.colorPrimaryBorder},"&:focus":{boxShadow:`0 0 0 2px ${t.colorPrimaryBorderHover}`}},readOnlyFormField:{width:"100%",color:t.colorTextDisabled,borderRadius:t.borderRadiusSM,background:t.colorFillQuaternary,cursor:"not-allowed"},textAreaField:{width:"100%",marginBottom:t.marginS,borderRadius:t.borderRadiusSM,borderColor:t.colorBorder},readOnlyTextArea:{width:"100%",marginBottom:t.marginS,borderRadius:t.borderRadiusSM,color:t.colorTextDisabled,background:t.colorFillQuaternary,cursor:"not-allowed"},divider:{borderColor:t.colorBorderSecondary,color:t.colorTextTertiary,fontWeight:t.fontWeightStrong},itemCard:{marginBottom:t.marginMD,border:`1px solid ${t.colorBorderSecondary}`,borderRadius:t.borderRadiusLG,backgroundColor:t.colorFillContentBackground,transition:"all 0.2s ease-in-out","&:hover":{boxShadow:t.boxShadowXl,transform:"translateY(-3px)"}},deleteButton:{height:"auto",display:"flex",alignItems:"center",justifyContent:"center",color:t.colorError,"&:hover":{color:t.colorErrorHover,background:t.colorErrorBg}},addButton:{height:"auto",display:"flex",alignItems:"center",justifyContent:"center",color:t.colorPrimary,borderColor:t.colorPrimaryBorder,"&:hover":{color:t.colorPrimaryHover,borderColor:t.colorPrimaryBorderHover,background:t.colorPrimaryBg}},addSpecButton:{marginTop:t.margin,borderRadius:t.borderRadiusSM,borderColor:t.colorBorderDashed,color:t.colorTextSecondary,"&:hover":{color:t.colorPrimaryText,borderColor:t.colorPrimary}},addItemButton:{marginTop:t.marginLG,borderRadius:t.borderRadiusSM,borderColor:t.colorPrimaryBorderDashed,color:t.colorPrimary,"&:hover":{background:t.colorPrimaryBgHover}},specificationRow:{marginBottom:t.marginXXS},summaryRow:{fontWeight:t.fontWeightStrong,borderTop:`1px dashed ${t.colorBorderSecondary}`,paddingTop:t.paddingMD,marginTop:t.marginLG},totalField:{width:"100%",borderRadius:t.borderRadiusSM,textAlign:"right",backgroundColor:t.colorFillTertiary,borderColor:t.colorBorder,color:t.colorText},grandTotalField:{width:"100%",borderRadius:t.borderRadiusSM,color:t.colorSuccess,fontSize:t.fontSizeHeading4,fontWeight:t.fontWeightStronger,textAlign:"right",backgroundColor:t.colorSuccessBg,borderColor:t.colorSuccessBorder},notesCard:{background:t.colorFillQuaternary,marginBottom:t.margin,borderRadius:t.borderRadiusLG,border:`1px solid ${t.colorBorderQuaternary}`},noteText:{margin:0,paddingBottom:t.paddingXXS,color:t.colorTextSecondary,fontSize:t.fontSizeSM,lineHeight:1.5},buttonGroup:{marginTop:t.marginLG,paddingTop:t.paddingMD,borderTop:`1px solid ${t.colorBorderSecondary}`,display:"flex",justifyContent:"flex-end",gap:t.marginSM}}),{Option:R}=P,{TextArea:J}=u,{useToken:pe}=ie,De=({onCancel:t,onSave:Z,initialValues:m,isSaving:N})=>{const[b]=l.useForm(),[I,V]=p.useState([]),[L,k]=p.useState([]),[g,j]=p.useState([{id:1,productId:null,description:"",hsnSac:"",quantity:1,quantityType:"",rate:0,specifications:[{key:Date.now(),name:"",value:""}]}]),[F,ee]=p.useState([]),[D,Y]=p.useState(null),[h,M]=p.useState(null),{token:$}=pe(),o=me($),O=p.useRef(!1),q=p.useRef(!1),v=p.useCallback(r=>{var s,a;return r?`
${(s=r.businessName)==null?void 0:s.toUpperCase()}
${r.contactName?`Mr. ${(a=r.contactName)==null?void 0:a.toUpperCase()}`:""}
${r.addressLine1||""}${r.addressLine2?", "+r.addressLine2:""}
${r.city||""}${r.pincode?" - "+r.pincode:""}
${r.state||""}, ${r.country||""}
${r.gstNumber||""}
${r.email||""} 
`.trim():""},[]),E=p.useCallback(async()=>{if(O.current)return;O.current=!0;const r=f.loading("Loading business options...");try{const s=await _.get("/api/quotations/leads/active");V(s.data),f.success("Business options loaded",{id:r})}catch(s){f.error("Failed to load businesses",{id:r}),console.error("Error fetching business options:",s),O.current=!1}},[]),Q=p.useCallback(async()=>{if(q.current)return;q.current=!0;const r=f.loading("Loading product options...");try{const s=await _.get("/api/product");k(s.data.map(a=>({...a,hsnSac:a.hsnSac||"",quantityType:a.quantityType||"",options:a.options||[]}))),f.success("Product options loaded",{id:r})}catch(s){f.error("Failed to load products",{id:r}),console.error("Error fetching product options:",s),q.current=!1}},[]);p.useEffect(()=>{if(E(),Q(),m&&(b.setFieldsValue({...m,date:m.date?X(m.date):null,validUntil:m.validUntil?X(m.validUntil):null,noteText:""}),j(m.items||[]),ee(m.notes||[]),Y(m.gstType||null),m.businessId&&I.length>0)){const r=I.find(s=>s._id===m.businessId);r&&(M(r),b.setFieldsValue({businessName:r.businessName,businessType:r.type,gstin:r.gstNumber,businessInfo:v(r)}))}},[m,E,Q,b,v,I]);const re=async r=>{var c,d;if(!g||g.length===0){f.error("At least one item is required.");return}if(!D){f.error("Please select a GST type.");return}const s=new Date().toLocaleString(),a=r.noteText?{text:r.noteText,timestamp:s}:null,i={...r,date:(c=r.date)==null?void 0:c.format("YYYY-MM-DD"),validUntil:(d=r.validUntil)==null?void 0:d.format("YYYY-MM-DD"),items:g,notes:a?[...F,a]:F,subTotal:w(),tax:A(),total:U(),createdDate:new Date().toLocaleDateString(),gstType:D,businessName:h==null?void 0:h.businessName,businessType:h==null?void 0:h.type,gstin:h==null?void 0:h.gstNumber,businessInfo:h?v(h):"",customerName:r.customerName,customerEmail:r.customerEmail};try{await Z(i)}catch(x){console.error("Error in QuotationForm onFinish:",x)}finally{}},te=()=>j([...g,{id:Date.now(),productId:null,description:"",hsnSac:"",quantity:1,rate:0,quantityType:"",specifications:[{key:Date.now(),name:"",value:""}]}]),oe=r=>j(g.filter(s=>s.id!==r)),C=(r,s,a)=>{j(i=>i.map(c=>{if(c.id===r){if(s==="productId"){const d=L.find(x=>x._id===a);if(d)return{...c,productId:a,description:d.description||"",hsnSac:d.hsnSac||"",rate:d.price||0,quantityType:d.quantityType||"",specifications:d.options&&d.options.length>0?d.options.map(x=>({key:Date.now()+Math.random(),name:x.type||"",value:x.description||""})):[{key:Date.now()+Math.random(),name:"",value:""}]}}return{...c,[s]:a}}return c}))},H=r=>{j(s=>s.map(a=>a.id===r?{...a,specifications:[...a.specifications,{key:Date.now()+Math.random(),name:"",value:""}]}:a))},se=(r,s)=>{j(a=>a.map(i=>i.id===r?{...i,specifications:i.specifications.filter(c=>c.key!==s)}:i))},z=(r,s,a,i)=>{j(c=>c.map(d=>d.id===r?{...d,specifications:d.specifications.map(x=>x.key===s?{...x,[a]:i}:x)}:d))},w=()=>g.reduce((r,s)=>r+(s.quantity||0)*(s.rate||0),0),A=()=>w()*.18,U=()=>w()+A(),ae=r=>{const s=I.find(a=>a._id===r);if(s){M(s);const a=v(s);b.setFieldsValue({businessId:s._id,businessName:s.businessName,businessType:s.type,gstin:s.gstNumber,businessInfo:a})}else M(null),b.setFieldsValue({businessId:null,businessName:null,businessType:null,gstin:null,businessInfo:""})};return e.jsx(B,{title:e.jsx("span",{style:o.mainCardTitle,children:m?"Edit Quotation":"Create New Quotation"}),loading:N,style:o.quotationCard,children:e.jsxs(l,{form:b,layout:"vertical",onFinish:re,children:[e.jsx(T,{style:o.divider,children:"Customer Details"}),e.jsxs(y,{gutter:[16,24],children:[e.jsx(n,{xs:24,md:12,children:e.jsx(l.Item,{label:"Customer Name",name:"customerName",rules:[{required:!0,message:"Please enter customer name!"},{min:2,message:"Customer name must be at least 2 characters!"}],children:e.jsx(u,{placeholder:"Enter customer full name",style:o.formField})})}),e.jsx(n,{xs:24,md:12,children:e.jsx(l.Item,{label:"Customer Email",name:"customerEmail",rules:[{required:!0,message:"Please enter customer email!"},{type:"email",message:"Please enter a valid email address!"}],children:e.jsx(u,{placeholder:"Enter customer email address",style:o.formField,type:"email"})})})]}),e.jsx(T,{style:o.divider,children:"Business Details"}),e.jsxs(y,{gutter:[16,24],children:[e.jsxs(n,{xs:24,md:12,children:[e.jsx(l.Item,{label:"Business Name",name:"businessId",rules:[{required:!0,message:"Please select a business!"}],children:e.jsx(P,{placeholder:"Select business",showSearch:!0,optionFilterProp:"children",filterOption:(r,s)=>((s==null?void 0:s.children)||"").toLowerCase().includes(r.toLowerCase()),onChange:ae,allowClear:!0,style:o.formField,children:I.map(r=>e.jsx(R,{value:r._id,children:r.businessName},r._id))})}),e.jsx(l.Item,{name:"businessName",hidden:!0,children:e.jsx(u,{})})]}),e.jsx(n,{xs:24,md:12,children:e.jsx(l.Item,{name:"businessType",label:"Type",children:e.jsx(u,{readOnly:!0,style:o.readOnlyFormField})})})]}),e.jsxs(y,{gutter:[16],children:[e.jsx(n,{xs:24,md:12,children:e.jsx(l.Item,{name:"gstType",label:"GST Type",rules:[{required:!0,message:"Please select a GST type!"}],children:e.jsxs(P,{placeholder:"Select GST calculation type",onChange:r=>Y(r),value:D,style:o.formField,children:[e.jsx(R,{value:"interstate",children:"Interstate - IGST (Integrated GST)"}),e.jsx(R,{value:"intrastate",children:"Intrastate - SGST/CGST (State/Central GST)"})]})})}),e.jsx(n,{xs:24,md:12,children:e.jsx(l.Item,{label:"Business Info",children:e.jsx(B,{bordered:!0,style:o.businessInfoCard,children:e.jsx("pre",{style:o.businessInfoPre,children:b.getFieldValue("businessInfo")||"Select a business to view details..."})})})})]}),e.jsx(T,{style:o.divider,children:"Quotation Details"}),e.jsxs(y,{gutter:[16,24],children:[e.jsx(n,{xs:24,md:12,children:e.jsx(l.Item,{name:"date",label:"Date",rules:[{required:!0,message:"Please select a date!"}],children:e.jsx(K,{style:o.formField,format:"DD/MM/YYYY"})})}),e.jsx(n,{xs:24,md:12,children:e.jsx(l.Item,{name:"validUntil",label:"Valid Until",children:e.jsx(K,{style:o.formField,format:"DD/MM/YYYY"})})})]}),e.jsx(T,{style:o.divider,children:"Quotation Items"}),g.map((r,s)=>{const a=r.productId!==null;return e.jsxs(B,{style:o.itemCard,size:"small",children:[e.jsxs(y,{gutter:[16,16],align:"middle",children:[e.jsx(n,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Product",noStyle:!0,children:e.jsx(P,{placeholder:"Search or select a product",showSearch:!0,optionFilterProp:"children",filterOption:(i,c)=>((c==null?void 0:c.children)||"").toLowerCase().includes(i.toLowerCase()),onChange:i=>C(r.id,"productId",i),value:r.productId,style:o.formField,children:L.map(i=>e.jsx(R,{value:i._id,children:i.productName||i.name},i._id))})})}),e.jsx(n,{xs:12,sm:4,children:e.jsx(l.Item,{label:"Qty",noStyle:!0,children:e.jsx(le,{placeholder:"1",value:r.quantity,onChange:i=>C(r.id,"quantity",i),style:o.formField,min:0})})}),e.jsx(n,{xs:12,sm:6,children:e.jsx(l.Item,{label:"Unit Type",noStyle:!0,children:e.jsx(u,{placeholder:"e.g., Pcs, Kg, Mtr",value:r.quantityType,onChange:i=>C(r.id,"quantityType",i.target.value),style:a?o.readOnlyFormField:o.formField,readOnly:a,disabled:a})})}),e.jsx(n,{xs:24,sm:6,style:{display:"flex",justifyContent:"flex-end",alignItems:"center"},children:g.length>1&&e.jsx(G,{title:"Remove Item",children:e.jsx(S,{icon:e.jsx(ne,{}),danger:!0,onClick:()=>oe(r.id),type:"text",style:o.deleteButton})})})]}),e.jsxs(y,{gutter:[16,16],style:{marginTop:$.marginS},children:[e.jsx(n,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Price (per unit)",noStyle:!0,children:e.jsx(u,{prefix:"₹",value:r.rate.toFixed(2),readOnly:!0,style:o.readOnlyFormField})})}),e.jsx(n,{xs:24,sm:16,children:e.jsx(l.Item,{label:"Description",noStyle:!0,children:e.jsx(J,{placeholder:"Detailed description of the item",value:r.description,onChange:i=>C(r.id,"description",i.target.value),style:a?o.readOnlyTextArea:o.textAreaField,rows:2})})})]}),e.jsxs(y,{gutter:[16,16],style:{marginTop:$.marginS},children:[e.jsx(n,{xs:24,sm:8,children:e.jsx(l.Item,{label:"HSN/SAC Code",noStyle:!0,children:e.jsx(u,{placeholder:"HSN/SAC",value:r.hsnSac,onChange:i=>C(r.id,"hsnSac",i.target.value),style:a?o.readOnlyFormField:o.formField,readOnly:a,disabled:a})})}),e.jsx(n,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Item Total",noStyle:!0,children:e.jsx(u,{value:`₹${((r.quantity||0)*(r.rate||0)).toFixed(2)}`,readOnly:!0,style:o.totalItemField})})})]}),r.specifications&&r.specifications.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(T,{orientation:"left",style:o.specificationDivider,children:"Specifications"}),r.specifications.map((i,c)=>e.jsxs(y,{gutter:16,style:o.specificationRow,align:"middle",children:[e.jsx(n,{xs:24,sm:10,children:e.jsx(u,{placeholder:"Specification Name (e.g., Color)",value:i.name,onChange:d=>z(r.id,i.key,"name",d.target.value),style:o.formField})}),e.jsx(n,{xs:24,sm:10,children:e.jsx(u,{placeholder:"Specification Value (e.g., Blue)",value:i.value,onChange:d=>z(r.id,i.key,"value",d.target.value),style:o.formField})}),e.jsx(n,{xs:24,sm:4,children:e.jsxs(W,{children:[r.specifications.length>1&&e.jsx(G,{title:"Remove Specification",children:e.jsx(S,{icon:e.jsx(de,{}),onClick:()=>se(r.id,i.key),type:"text",danger:!0,style:o.deleteButton})}),c===r.specifications.length-1&&e.jsx(G,{title:"Add New Specification",children:e.jsx(S,{icon:e.jsx(ce,{}),onClick:()=>H(r.id),type:"dashed",style:o.addButton})})]})})]},i.key))]}),(!r.specifications||r.specifications.length===0||r.specifications.length>0&&r.specifications[r.specifications.length-1].name&&r.specifications[r.specifications.length-1].value)&&e.jsx(S,{onClick:()=>H(r.id),block:!0,type:"dashed",style:o.addSpecButton,children:"+ Add Specification"})]},r.id)}),e.jsx(S,{onClick:te,block:!0,type:"dashed",style:o.addItemButton,children:"+ Add Another Item"}),e.jsx(T,{style:o.divider,children:"Quotation Summary"}),e.jsxs(y,{gutter:[16,16],style:o.summaryRow,children:[e.jsx(n,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Sub Total",children:e.jsx(u,{readOnly:!0,value:`₹${w().toFixed(2)}`,style:o.totalField})})}),e.jsx(n,{xs:24,sm:8,children:e.jsx(l.Item,{label:"GST (18%)",children:e.jsx(u,{readOnly:!0,value:`₹${A().toFixed(2)}`,style:o.totalField})})}),e.jsx(n,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Total Amount",children:e.jsx(u,{readOnly:!0,value:`₹${U().toFixed(2)}`,style:o.grandTotalField})})})]}),F.length>0&&e.jsx(l.Item,{label:"Existing Notes",children:e.jsx(B,{style:o.notesCard,children:F.map((r,s)=>e.jsxs("p",{style:o.noteText,children:[e.jsxs("strong",{children:[r.timestamp,":"]})," ",r.text]},s))})}),e.jsx(l.Item,{name:"noteText",label:"Add New Note",children:e.jsx(J,{rows:3,style:o.textAreaField,placeholder:"Add any additional notes, terms, or conditions for this quotation..."})}),e.jsx(l.Item,{style:o.buttonGroup,children:e.jsxs(W,{size:"middle",children:[e.jsx(S,{onClick:t,disabled:N,size:"large",children:"Cancel"}),e.jsx(S,{htmlType:"submit",type:"primary",icon:e.jsx(ue,{}),loading:N,size:"large",children:"Save Quotation"})]})})]})})};export{De as default};
