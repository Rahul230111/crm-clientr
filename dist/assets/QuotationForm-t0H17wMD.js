import{X as l,r as h,ar as f,a6 as W,P as _,U as e,V as B,aB as T,Y as y,Z as n,a4 as u,S as P,a5 as X,bc as ie,ab as G,a0 as S,ao as K,bd as le}from"./index-CdWk2t8q.js";import{t as ne}from"./index-D-FcpsyV.js";import{R as de}from"./DeleteOutlined-ArRDP0IZ.js";import{R as ce}from"./MinusCircleOutlined-B1jLPKPS.js";import{R as ue}from"./SaveOutlined-DH1JahLj.js";const me=t=>({quotationCard:{borderRadius:t.borderRadiusXL,border:`1px solid ${t.colorBorderBg}`,backgroundColor:t.colorBgContainer},mainCardTitle:{color:t.colorPrimary,fontSize:t.fontSizeHeading2,fontWeight:t.fontWeightStronger,textAlign:"center",textTransform:"uppercase",letterSpacing:"1px"},businessInfoCard:{background:`linear-gradient(135deg, ${t.colorFillQuaternary} 0%, ${t.colorFillAlter} 100%)`,border:`1px solid ${t.colorBorderSecondary}`,borderRadius:t.borderRadiusLG,minHeight:"80px",boxShadow:t.boxShadowTertiary,display:"flex",alignItems:"center",transition:"all 0.3s ease-in-out","&:hover":{boxShadow:t.boxShadow,transform:"translateY(-2px)"}},businessInfoPre:{margin:0,whiteSpace:"pre-wrap",flexGrow:1,fontFamily:"monospace",fontSize:t.fontSizeSM,color:t.colorTextSecondary,lineHeight:t.lineHeightSM,opacity:.8},formField:{width:"100%",borderRadius:t.borderRadiusSM,borderColor:t.colorBorder,transition:"all 0.2s ease","&:hover":{borderColor:t.colorPrimaryBorder},"&:focus":{boxShadow:`0 0 0 2px ${t.colorPrimaryBorderHover}`}},readOnlyFormField:{width:"100%",color:t.colorTextDisabled,borderRadius:t.borderRadiusSM,background:t.colorFillQuaternary,cursor:"not-allowed"},textAreaField:{width:"100%",marginBottom:t.marginS,borderRadius:t.borderRadiusSM,borderColor:t.colorBorder},readOnlyTextArea:{width:"100%",marginBottom:t.marginS,borderRadius:t.borderRadiusSM,color:t.colorTextDisabled,background:t.colorFillQuaternary,cursor:"not-allowed"},divider:{borderColor:t.colorBorderSecondary,color:t.colorTextTertiary,fontWeight:t.fontWeightStrong},itemCard:{marginBottom:t.marginMD,border:`1px solid ${t.colorBorderSecondary}`,borderRadius:t.borderRadiusLG,backgroundColor:t.colorFillContentBackground,transition:"all 0.2s ease-in-out","&:hover":{boxShadow:t.boxShadowXl,transform:"translateY(-3px)"}},deleteButton:{height:"auto",display:"flex",alignItems:"center",justifyContent:"center",color:t.colorError,"&:hover":{color:t.colorErrorHover,background:t.colorErrorBg}},addButton:{height:"auto",display:"flex",alignItems:"center",justifyContent:"center",color:t.colorPrimary,borderColor:t.colorPrimaryBorder,"&:hover":{color:t.colorPrimaryHover,borderColor:t.colorPrimaryBorderHover,background:t.colorPrimaryBg}},addSpecButton:{marginTop:t.margin,borderRadius:t.borderRadiusSM,borderColor:t.colorBorderDashed,color:t.colorTextSecondary,"&:hover":{color:t.colorPrimaryText,borderColor:t.colorPrimary}},addItemButton:{marginTop:t.marginLG,borderRadius:t.borderRadiusSM,borderColor:t.colorPrimaryBorderDashed,color:t.colorPrimary,"&:hover":{background:t.colorPrimaryBgHover}},specificationRow:{marginBottom:t.marginXXS},summaryRow:{fontWeight:t.fontWeightStrong,borderTop:`1px dashed ${t.colorBorderSecondary}`,paddingTop:t.paddingMD,marginTop:t.marginLG},totalField:{width:"100%",borderRadius:t.borderRadiusSM,textAlign:"right",backgroundColor:t.colorFillTertiary,borderColor:t.colorBorder,color:t.colorText},grandTotalField:{width:"100%",borderRadius:t.borderRadiusSM,color:t.colorSuccess,fontSize:t.fontSizeHeading4,fontWeight:t.fontWeightStronger,textAlign:"right",backgroundColor:t.colorSuccessBg,borderColor:t.colorSuccessBorder},notesCard:{background:t.colorFillQuaternary,marginBottom:t.margin,borderRadius:t.borderRadiusLG,border:`1px solid ${t.colorBorderQuaternary}`},noteText:{margin:0,paddingBottom:t.paddingXXS,color:t.colorTextSecondary,fontSize:t.fontSizeSM,lineHeight:1.5},buttonGroup:{marginTop:t.marginLG,paddingTop:t.paddingMD,borderTop:`1px solid ${t.colorBorderSecondary}`,display:"flex",justifyContent:"flex-end",gap:t.marginSM}}),{Option:R}=P,{TextArea:Z}=u,{useToken:he}=ne,be=({onCancel:t,onSave:J,initialValues:m,isSaving:N})=>{const[b]=l.useForm(),[I,V]=h.useState([]),[Y,k]=h.useState([]),[g,j]=h.useState([{id:1,productId:null,description:"",hsnSac:"",quantity:1,quantityType:"",rate:0,specifications:[{key:Date.now(),name:"",value:""}]}]),[F,ee]=h.useState([]),[D,L]=h.useState(null),[x,M]=h.useState(null),{token:$}=he(),s=me($),O=h.useRef(!1),q=h.useRef(!1),v=h.useCallback(r=>{var o,a;return r?`
${(o=r.businessName)==null?void 0:o.toUpperCase()}
${r.contactName?`Mr. ${(a=r.contactName)==null?void 0:a.toUpperCase()}`:""}
${r.addressLine1||""}${r.addressLine2?", "+r.addressLine2:""}
${r.city||""}${r.pincode?" - "+r.pincode:""}
${r.state||""}, ${r.country||""}
${r.gstNumber||""}
${r.email||""} 
`.trim():""},[]),E=h.useCallback(async()=>{if(O.current)return;O.current=!0;const r=f.loading("Loading business options...");try{const o=await W.get("/api/quotations/leads/active");V(o.data),f.success("Business options loaded",{id:r})}catch(o){f.error("Failed to load businesses",{id:r}),console.error("Error fetching business options:",o),O.current=!1}},[]),Q=h.useCallback(async()=>{if(q.current)return;q.current=!0;const r=f.loading("Loading product options...");try{const o=await W.get("/api/product");k(o.data.map(a=>({...a,hsnSac:a.hsnSac||"",quantityType:a.quantityType||"",options:a.options||[]}))),f.success("Product options loaded",{id:r})}catch(o){f.error("Failed to load products",{id:r}),console.error("Error fetching product options:",o),q.current=!1}},[]);h.useEffect(()=>{if(E(),Q(),m&&(b.setFieldsValue({...m,date:m.date?_(m.date):null,validUntil:m.validUntil?_(m.validUntil):null,noteText:""}),j(m.items||[]),ee(m.notes||[]),L(m.gstType||null),m.businessId&&I.length>0)){const r=I.find(o=>o._id===m.businessId);r&&(M(r),b.setFieldsValue({businessName:r.businessName,businessType:r.type,gstin:r.gstNumber,businessInfo:v(r)}))}},[m,E,Q,b,v,I]);const re=async r=>{var c,d;if(!g||g.length===0){f.error("At least one item is required.");return}if(!D){f.error("Please select a GST type.");return}const o=new Date().toLocaleString(),a=r.noteText?{text:r.noteText,timestamp:o}:null,i={...r,date:(c=r.date)==null?void 0:c.format("YYYY-MM-DD"),validUntil:(d=r.validUntil)==null?void 0:d.format("YYYY-MM-DD"),items:g,notes:a?[...F,a]:F,subTotal:w(),tax:A(),total:U(),createdDate:new Date().toLocaleDateString(),gstType:D,businessName:x==null?void 0:x.businessName,businessType:x==null?void 0:x.type,gstin:x==null?void 0:x.gstNumber,businessInfo:x?v(x):"",customerName:r.customerName,customerEmail:r.customerEmail};try{await J(i)}catch(p){console.error("Error in QuotationForm onFinish:",p)}finally{}},te=()=>j([...g,{id:Date.now(),productId:null,description:"",hsnSac:"",quantity:1,rate:0,quantityType:"",specifications:[{key:Date.now(),name:"",value:""}]}]),se=r=>j(g.filter(o=>o.id!==r)),C=(r,o,a)=>{j(i=>i.map(c=>{if(c.id===r){if(o==="productId"){const d=Y.find(p=>p._id===a);if(d)return{...c,productId:a,description:d.description||"",hsnSac:d.hsnSac||"",rate:d.price||0,quantityType:d.quantityType||"",specifications:d.options&&d.options.length>0?d.options.map(p=>({key:Date.now()+Math.random(),name:p.type||"",value:p.description||""})):[{key:Date.now()+Math.random(),name:"",value:""}]}}return{...c,[o]:a}}return c}))},H=r=>{j(o=>o.map(a=>a.id===r?{...a,specifications:[...a.specifications,{key:Date.now()+Math.random(),name:"",value:""}]}:a))},oe=(r,o)=>{j(a=>a.map(i=>i.id===r?{...i,specifications:i.specifications.filter(c=>c.key!==o)}:i))},z=(r,o,a,i)=>{j(c=>c.map(d=>d.id===r?{...d,specifications:d.specifications.map(p=>p.key===o?{...p,[a]:i}:p)}:d))},w=()=>g.reduce((r,o)=>r+(o.quantity||0)*(o.rate||0),0),A=()=>w()*.18,U=()=>w()+A(),ae=r=>{const o=I.find(a=>a._id===r);if(o){M(o);const a=v(o);b.setFieldsValue({businessId:o._id,businessName:o.businessName,businessType:o.type,gstin:o.gstNumber,businessInfo:a})}else M(null),b.setFieldsValue({businessId:null,businessName:null,businessType:null,gstin:null,businessInfo:""})};return e.jsx(B,{title:e.jsx("span",{style:s.mainCardTitle,children:m?"Edit Quotation":"Create New Quotation"}),loading:N,style:s.quotationCard,children:e.jsxs(l,{form:b,layout:"vertical",onFinish:re,children:[e.jsx(T,{style:s.divider,children:"Customer Details"}),e.jsxs(y,{gutter:[16,24],children:[e.jsx(n,{xs:24,md:12,children:e.jsx(l.Item,{label:"Customer Name",name:"customerName",rules:[{required:!0,message:"Please enter customer name!"},{min:2,message:"Customer name must be at least 2 characters!"}],children:e.jsx(u,{placeholder:"Enter customer full name",style:s.formField})})}),e.jsx(n,{xs:24,md:12,children:e.jsx(l.Item,{label:"Customer Email",name:"customerEmail",rules:[{required:!0,message:"Please enter customer email!"},{type:"email",message:"Please enter a valid email address!"}],children:e.jsx(u,{placeholder:"Enter customer email address",style:s.formField,type:"email"})})})]}),e.jsx(T,{style:s.divider,children:"Business Details"}),e.jsxs(y,{gutter:[16,24],children:[e.jsxs(n,{xs:24,md:12,children:[e.jsx(l.Item,{label:"Business Name",name:"businessId",rules:[{required:!0,message:"Please select a business!"}],children:e.jsx(P,{placeholder:"Select business",showSearch:!0,optionFilterProp:"children",filterOption:(r,o)=>((o==null?void 0:o.children)||"").toLowerCase().includes(r.toLowerCase()),onChange:ae,allowClear:!0,style:s.formField,children:I.map(r=>e.jsx(R,{value:r._id,children:r.businessName},r._id))})}),e.jsx(l.Item,{name:"businessName",hidden:!0,children:e.jsx(u,{})})]}),e.jsx(n,{xs:24,md:12,children:e.jsx(l.Item,{name:"businessType",label:"Type",children:e.jsx(u,{readOnly:!0,style:s.readOnlyFormField})})})]}),e.jsxs(y,{gutter:[16],children:[e.jsx(n,{xs:24,md:12,children:e.jsx(l.Item,{name:"gstType",label:"GST Type",rules:[{required:!0,message:"Please select a GST type!"}],children:e.jsxs(P,{placeholder:"Select GST calculation type",onChange:r=>L(r),value:D,style:s.formField,children:[e.jsx(R,{value:"interstate",children:"Interstate - IGST (Integrated GST)"}),e.jsx(R,{value:"intrastate",children:"Intrastate - SGST/CGST (State/Central GST)"})]})})}),e.jsx(n,{xs:24,md:12,children:e.jsx(l.Item,{label:"Business Info",children:e.jsx(B,{bordered:!0,style:s.businessInfoCard,children:e.jsx("pre",{style:s.businessInfoPre,children:b.getFieldValue("businessInfo")||"Select a business to view details..."})})})})]}),e.jsx(T,{style:s.divider,children:"Quotation Details"}),e.jsxs(y,{gutter:[16,24],children:[e.jsx(n,{xs:24,md:12,children:e.jsx(l.Item,{name:"date",label:"Date",rules:[{required:!0,message:"Please select a date!"}],children:e.jsx(X,{style:s.formField,format:"DD/MM/YYYY"})})}),e.jsx(n,{xs:24,md:12,children:e.jsx(l.Item,{name:"validUntil",label:"Valid Until",children:e.jsx(X,{style:s.formField,format:"DD/MM/YYYY"})})})]}),e.jsx(T,{style:s.divider,children:"Quotation Items"}),g.map((r,o)=>{const a=r.productId!==null;return e.jsxs(B,{style:s.itemCard,size:"small",children:[e.jsxs(y,{gutter:[16,16],align:"middle",children:[e.jsx(n,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Product",noStyle:!0,children:e.jsx(P,{placeholder:"Search or select a product",showSearch:!0,optionFilterProp:"children",filterOption:(i,c)=>((c==null?void 0:c.children)||"").toLowerCase().includes(i.toLowerCase()),onChange:i=>C(r.id,"productId",i),value:r.productId,style:s.formField,children:Y.map(i=>e.jsx(R,{value:i._id,children:i.productName||i.name},i._id))})})}),e.jsx(n,{xs:12,sm:4,children:e.jsx(l.Item,{label:"Qty",noStyle:!0,children:e.jsx(ie,{placeholder:"1",value:r.quantity,onChange:i=>C(r.id,"quantity",i),style:s.formField,min:0})})}),e.jsx(n,{xs:12,sm:6,children:e.jsx(l.Item,{label:"Unit Type",noStyle:!0,children:e.jsx(u,{placeholder:"e.g., Pcs, Kg, Mtr",value:r.quantityType,onChange:i=>C(r.id,"quantityType",i.target.value),style:a?s.readOnlyFormField:s.formField,readOnly:a,disabled:a})})}),e.jsx(n,{xs:24,sm:6,style:{display:"flex",justifyContent:"flex-end",alignItems:"center"},children:g.length>1&&e.jsx(G,{title:"Remove Item",children:e.jsx(S,{icon:e.jsx(de,{}),danger:!0,onClick:()=>se(r.id),type:"text",style:s.deleteButton})})})]}),e.jsxs(y,{gutter:[16,16],style:{marginTop:$.marginS},children:[e.jsx(n,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Price (per unit)",noStyle:!0,children:e.jsx(u,{prefix:"₹",value:r.rate.toFixed(2),readOnly:!0,style:s.readOnlyFormField})})}),e.jsx(n,{xs:24,sm:16,children:e.jsx(l.Item,{label:"Description",noStyle:!0,children:e.jsx(Z,{placeholder:"Detailed description of the item",value:r.description,onChange:i=>C(r.id,"description",i.target.value),style:a?s.readOnlyTextArea:s.textAreaField,rows:2})})})]}),e.jsxs(y,{gutter:[16,16],style:{marginTop:$.marginS},children:[e.jsx(n,{xs:24,sm:8,children:e.jsx(l.Item,{label:"HSN/SAC Code",noStyle:!0,children:e.jsx(u,{placeholder:"HSN/SAC",value:r.hsnSac,onChange:i=>C(r.id,"hsnSac",i.target.value),style:a?s.readOnlyFormField:s.formField,readOnly:a,disabled:a})})}),e.jsx(n,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Item Total",noStyle:!0,children:e.jsx(u,{value:`₹${((r.quantity||0)*(r.rate||0)).toFixed(2)}`,readOnly:!0,style:s.totalItemField})})})]}),r.specifications&&r.specifications.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(T,{orientation:"left",style:s.specificationDivider,children:"Specifications"}),r.specifications.map((i,c)=>e.jsxs(y,{gutter:16,style:s.specificationRow,align:"middle",children:[e.jsx(n,{xs:24,sm:10,children:e.jsx(u,{placeholder:"Specification Name (e.g., Color)",value:i.name,onChange:d=>z(r.id,i.key,"name",d.target.value),style:s.formField})}),e.jsx(n,{xs:24,sm:10,children:e.jsx(u,{placeholder:"Specification Value (e.g., Blue)",value:i.value,onChange:d=>z(r.id,i.key,"value",d.target.value),style:s.formField})}),e.jsx(n,{xs:24,sm:4,children:e.jsxs(K,{children:[r.specifications.length>1&&e.jsx(G,{title:"Remove Specification",children:e.jsx(S,{icon:e.jsx(ce,{}),onClick:()=>oe(r.id,i.key),type:"text",danger:!0,style:s.deleteButton})}),c===r.specifications.length-1&&e.jsx(G,{title:"Add New Specification",children:e.jsx(S,{icon:e.jsx(le,{}),onClick:()=>H(r.id),type:"dashed",style:s.addButton})})]})})]},i.key))]}),(!r.specifications||r.specifications.length===0||r.specifications.length>0&&r.specifications[r.specifications.length-1].name&&r.specifications[r.specifications.length-1].value)&&e.jsx(S,{onClick:()=>H(r.id),block:!0,type:"dashed",style:s.addSpecButton,children:"+ Add Specification"})]},r.id)}),e.jsx(S,{onClick:te,block:!0,type:"dashed",style:s.addItemButton,children:"+ Add Another Item"}),e.jsx(T,{style:s.divider,children:"Quotation Summary"}),e.jsxs(y,{gutter:[16,16],style:s.summaryRow,children:[e.jsx(n,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Sub Total",children:e.jsx(u,{readOnly:!0,value:`₹${w().toFixed(2)}`,style:s.totalField})})}),e.jsx(n,{xs:24,sm:8,children:e.jsx(l.Item,{label:"GST (18%)",children:e.jsx(u,{readOnly:!0,value:`₹${A().toFixed(2)}`,style:s.totalField})})}),e.jsx(n,{xs:24,sm:8,children:e.jsx(l.Item,{label:"Total Amount",children:e.jsx(u,{readOnly:!0,value:`₹${U().toFixed(2)}`,style:s.grandTotalField})})})]}),F.length>0&&e.jsx(l.Item,{label:"Existing Notes",children:e.jsx(B,{style:s.notesCard,children:F.map((r,o)=>e.jsxs("p",{style:s.noteText,children:[e.jsxs("strong",{children:[r.timestamp,":"]})," ",r.text]},o))})}),e.jsx(l.Item,{name:"noteText",label:"Add New Note",children:e.jsx(Z,{rows:3,style:s.textAreaField,placeholder:"Add any additional notes, terms, or conditions for this quotation..."})}),e.jsx(l.Item,{style:s.buttonGroup,children:e.jsxs(K,{size:"middle",children:[e.jsx(S,{onClick:t,disabled:N,size:"large",children:"Cancel"}),e.jsx(S,{htmlType:"submit",type:"primary",icon:e.jsx(ue,{}),loading:N,size:"large",children:"Save Quotation"})]})})]})})};export{be as default};
