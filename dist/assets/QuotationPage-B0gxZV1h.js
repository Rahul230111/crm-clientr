import{X as F,r as n,U as e,aC as V,an as T,a4 as A,a0 as U,W as $,ar as a,a6 as v}from"./index-CdWk2t8q.js";import k from"./QuotationForm-t0H17wMD.js";import O from"./QuotationList-BBSnpSZc.js";import{R as P}from"./SendOutlined-nXgaPsIE.js";import"./index-D-FcpsyV.js";import"./DeleteOutlined-ArRDP0IZ.js";import"./MinusCircleOutlined-B1jLPKPS.js";import"./SaveOutlined-DH1JahLj.js";import"./moment-C5S46NFB.js";import"./html2canvas.esm-DyM8d13i.js";import"./index-BOl5G6xx.js";import"./PrinterOutlined-L02Xwkho.js";import"./MessageOutlined-ZwMFkqtk.js";import"./ScheduleOutlined-0yo2LJpA.js";import"./index-BWEg3k1d.js";const{TextArea:R}=A,{Title:B,Text:W}=$,_=({visible:y,onClose:Q,quotation:r,refreshQuotations:d})=>{const[u]=F.useForm(),[i,w]=n.useState(!1),[m,N]=n.useState([]);n.useEffect(()=>{N((r==null?void 0:r.notes)||[])},[r]);const S=()=>{try{const s=JSON.parse(localStorage.getItem("user"));return(s==null?void 0:s.email)||"Unknown"}catch{return"Unknown"}},j=async s=>{try{w(!0);const l=a.loading("Adding note..."),c={text:s.note,timestamp:new Date().toLocaleString(),author:S()},p=[...m,c];await v.put(`/api/quotations/${r._id}`,{notes:p}),N(p),a.success("Note added",{id:l}),u.resetFields(),d()}catch{a.error("Failed to add note")}finally{w(!1)}},D=()=>m.length?m.map((s,l)=>{const c=l>0?m[l-1]:null,p=new Date(s.timestamp).toDateString(),C=c?new Date(c.timestamp).toDateString():null,b=p!==C;return e.jsxs("div",{children:[b&&e.jsx("div",{className:"note-date-header",children:p}),e.jsxs("div",{className:"note-bubble",children:[e.jsxs("div",{className:"note-meta",children:[s.author,"    ",s.timestamp]}),e.jsx("div",{className:"note-text",children:s.text})]})]},l)}):e.jsx(W,{type:"secondary",children:"No notes added yet"});return e.jsx(V,{title:e.jsxs(B,{level:4,style:{margin:0},children:["Notes for Quotation #",r==null?void 0:r.quotationNumber]}),open:y,onClose:Q,width:440,destroyOnClose:!0,children:e.jsxs(T,{spinning:i,children:[e.jsx("div",{style:{maxHeight:460,overflowY:"auto",marginBottom:16},children:D()}),e.jsxs(F,{form:u,layout:"vertical",onFinish:j,children:[e.jsx(F.Item,{name:"note",rules:[{required:!0,message:"Please enter a note"}],children:e.jsx(R,{rows:3,placeholder:"Type your note here"})}),e.jsx(U,{type:"primary",htmlType:"submit",loading:i,block:!0,icon:e.jsx(P,{}),children:"Add Note"})]})]})})},re=()=>{const[y,Q]=n.useState([]),[r,d]=n.useState(!1),[u,i]=n.useState(null),[w,m]=n.useState([]),[N,S]=n.useState(!1),[j,D]=n.useState(!1),[s,l]=n.useState(!1),c=async()=>{D(!0);const o=a.loading("Loading quotations...");try{const t=await v.get("/api/quotations");Q(t.data),m(t.data),a.success("Quotations loaded successfully",{id:o})}catch(t){a.error("Failed to load quotations",{id:o}),console.error("Error fetching quotations:",t)}finally{D(!1)}};n.useEffect(()=>{c()},[]);const p=async o=>{var h,f,x;if(s){a("Quotation save in progress. Please wait...",{icon:"⏳"});return}l(!0);const t=a.loading("Saving quotation...");try{u?await v.put(`/api/quotations/${u._id}`,o):await v.post("/api/quotations",o),a.success("Quotation saved successfully!",{id:t}),await c(),d(!1),i(null)}catch(g){console.error("Error saving quotation:",((h=g.response)==null?void 0:h.data)||g),a.error(`Failed to save quotation: ${((x=(f=g.response)==null?void 0:f.data)==null?void 0:x.error)||g.message||"Unknown error"}`,{id:t})}finally{l(!1)}},C=async o=>{const t=a.loading("Deleting quotation...");try{await v.delete(`/api/quotations/${o}`),a.success("Quotation deleted successfully",{id:t}),c()}catch(h){a.error(`Failed to delete quotation: ${h.message}`,{id:t}),console.error("Error deleting quotation:",h)}},b=o=>{const t=o.toLowerCase(),h=y.filter(f=>{var x,g,L,E;return((x=f.businessName)==null?void 0:x.toLowerCase().includes(t))||((g=f.customerName)==null?void 0:g.toLowerCase().includes(t))||((L=f.quotationNumber)==null?void 0:L.toLowerCase().includes(t))||((E=f.notes)==null?void 0:E.some(q=>{var I;return(I=q.text)==null?void 0:I.toLowerCase().includes(t)}))});m(h)};return e.jsxs(e.Fragment,{children:[e.jsx(O,{quotations:w.length>0||w.length===0&&y.length===0&&!j?w:y,onAddNew:()=>{i(null),d(!0)},onEdit:o=>{i(o),d(!0)},onDelete:C,onSearch:b,onViewNotes:o=>{i(o),S(!0)},loading:j}),e.jsx(V,{open:r,title:u?"Edit Quotation":"Create Quotation",onClose:()=>{d(!1),i(null)},width:window.innerWidth>768?"80vw":"95vw",destroyOnClose:!0,children:e.jsx(k,{initialValues:u,onSave:p,onCancel:()=>{d(!1),i(null)},isSaving:s})}),e.jsx(_,{visible:N,onClose:()=>{S(!1),i(null)},quotation:u,refreshQuotations:c})]})};export{re as default};
