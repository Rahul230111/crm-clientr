import{r as i,I as Q,e as W,x as r,B as m,K as X,H as Z,V as o}from"./index-BdO_Kpjh.js";import{i as y}from"./axios-YBtE4rUB.js";import{F as l}from"./index-EeCVaXf7.js";import{R as U}from"./PlusOutlined-CUpbz60d.js";import{C as D}from"./Collapse-DjgBclvE.js";import{L as S}from"./index-CimJwxIX.js";import{R as ee}from"./SwapOutlined-CuraDSFh.js";import{R as re}from"./TeamOutlined-Dp5-LNzB.js";import{R as ae}from"./EditOutlined-4_YZT7jJ.js";import{P as te}from"./index-B4pYjJAu.js";import{R as se}from"./DeleteOutlined-ShQKCs3W.js";import{D as $}from"./index-CLg-5-vI.js";import{I as ne}from"./index-WQ39I5Mf.js";import{S as c}from"./index-BhtCKA3g.js";import"./TextArea-DCODP0f3.js";import"./useClosable-BS0kZpJW.js";import"./Pagination-BAjxXHH4.js";import"./ActionButton-C-p52bNr.js";import"./context-BpnDtaRr.js";var le={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M908 640H804V488c0-4.4-3.6-8-8-8H548v-96h108c8.8 0 16-7.2 16-16V80c0-8.8-7.2-16-16-16H368c-8.8 0-16 7.2-16 16v288c0 8.8 7.2 16 16 16h108v96H228c-4.4 0-8 3.6-8 8v152H116c-8.8 0-16 7.2-16 16v288c0 8.8 7.2 16 16 16h288c8.8 0 16-7.2 16-16V656c0-8.8-7.2-16-16-16H292v-88h440v88H620c-8.8 0-16 7.2-16 16v288c0 8.8 7.2 16 16 16h288c8.8 0 16-7.2 16-16V656c0-8.8-7.2-16-16-16zm-564 76v168H176V716h168zm84-408V140h168v168H428zm420 576H680V716h168v168z"}}]},name:"apartment",theme:"outlined"},oe=function(p,j){return i.createElement(Q,W({},p,{ref:j,icon:le}))},ie=i.forwardRef(oe);const{Option:x}=c,{Panel:H}=D,Le=({teams:b,departments:p,allUsers:j,fetchTeams:C,fetchDepartments:me,fetchUsers:v})=>{const[z,h]=i.useState(!1),[n,L]=i.useState(null),[g]=l.useForm(),[A,w]=i.useState(!1),[u,F]=i.useState(null),[f]=l.useForm(),[R,T]=i.useState([]),d=JSON.parse(localStorage.getItem("user")),I=(d==null?void 0:d.role)==="Superadmin",_=(d==null?void 0:d.role)==="Admin",k=j.filter(e=>e.role==="Team Leader"&&!e.team),O=j.filter(e=>e.role==="Employee"&&!e.team),B=i.useCallback(()=>{const e=n==null?void 0:n.teamLeader;let a=[...k];return e&&!a.some(t=>t._id===e._id)&&a.push(e),a.sort((t,s)=>t.name.localeCompare(s.name))},[n,k]),N=i.useCallback(()=>{const e=(n==null?void 0:n.members)||[];let a=[...O];return e.forEach(t=>{a.some(s=>s._id===t._id)||a.push(t)}),a.sort((t,s)=>t.name.localeCompare(s.name))},[n,O]),M=()=>{L(null),g.resetFields(),h(!0)},P=e=>{var a,t;L(e),g.setFieldsValue({name:e.name,department:(a=e.department)==null?void 0:a._id,teamLeader:(t=e.teamLeader)==null?void 0:t._id,members:e.members.map(s=>s._id)}),h(!0)},q=async()=>{var e,a;try{const t=await g.validateFields();n?(await y.put(`/api/teams/${n._id}`,t),o.success("Team updated successfully")):(await y.post("/api/teams",t),o.success("Team created successfully")),h(!1),C(),v()}catch(t){console.error("Team submission failed:",t),o.error(((a=(e=t==null?void 0:t.response)==null?void 0:e.data)==null?void 0:a.message)||"Failed to submit team.")}},K=async e=>{var a,t;try{await y.delete(`/api/teams/${e}`),o.success("Team deleted"),C(),v()}catch(s){console.error("Team deletion failed:",s),o.error(((t=(a=s==null?void 0:s.response)==null?void 0:a.data)==null?void 0:t.message)||"Failed to delete team.")}},E=p.reduce((e,a)=>(e[a._id]={...a,teams:b.filter(t=>{var s;return((s=t.department)==null?void 0:s._id)===a._id})},e),{}),J=e=>{F(e),f.resetFields(),T([]),w(!0)},Y=e=>{if(f.setFieldsValue({newTeamId:void 0}),e){const a=b.filter(t=>{var s;return((s=t.department)==null?void 0:s._id)===e});T(a)}else T([])},G=async()=>{var e,a;try{const t=await f.validateFields(),{newDepartmentId:s,newTeamId:V}=t;if(!u){o.error("No user selected for transfer.");return}if(!s&&!V){o.error("Please select a new department or team for transfer.");return}await y.put(`/api/users/${u._id}/transfer`,{newDepartmentId:s||null,newTeamId:V||null}),o.success(`${u.name} transferred successfully.`),w(!1),F(null),v(),C()}catch(t){console.error("User transfer failed:",t),o.error(((a=(e=t==null?void 0:t.response)==null?void 0:e.data)==null?void 0:a.message)||"Failed to transfer user.")}};return r.jsxs(r.Fragment,{children:[r.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[r.jsx("h2",{children:"Team Management"}),(I||_)&&r.jsx(m,{type:"primary",style:{backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},icon:r.jsx(U,{}),onClick:M,children:"Create Team"})]}),r.jsx(D,{accordion:!0,bordered:!1,defaultActiveKey:Object.keys(E)[0],children:Object.values(E).map(e=>r.jsx(H,{header:r.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[r.jsx(ie,{style:{marginRight:8,fontSize:"1.2em"}}),r.jsxs("h3",{children:[e.name," (",e.teams.length," Teams)"]})]}),style:{marginBottom:10,borderRadius:8,overflow:"hidden",border:"1px solid #d9d9d9"},children:e.teams.length===0?r.jsx("p",{children:"No teams in this department."}):r.jsx(D,{accordion:!0,bordered:!1,style:{background:"#f0f2f5"},children:e.teams.map(a=>r.jsx(H,{header:r.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[r.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[r.jsx(re,{style:{marginRight:8}}),r.jsx("strong",{children:a.name}),a.teamLeader&&r.jsxs("span",{style:{marginLeft:15,fontSize:"0.9em",color:"#555"},children:["(Leader: ",a.teamLeader.name,")"]})]}),(I||_)&&r.jsxs(Z,{onClick:t=>t.stopPropagation(),children:[" ",r.jsx(m,{icon:r.jsx(ae,{}),onClick:()=>P(a),size:"small",title:"Edit Team"}),r.jsx(te,{title:"Delete this team?",onConfirm:()=>K(a._id),okText:"Yes",cancelText:"No",children:r.jsx(m,{danger:!0,icon:r.jsx(se,{}),size:"small",title:"Delete Team"})})]})]}),style:{marginBottom:5,borderRadius:6,border:"1px solid #e8e8e8"},children:r.jsxs("div",{style:{paddingLeft:20},children:[r.jsx("h4",{children:"Team Members:"}),a.members.length===0?r.jsx("p",{children:"No members in this team."}):r.jsx(S,{size:"small",dataSource:a.members,renderItem:t=>r.jsx(S.Item,{actions:[(I||_)&&r.jsx(m,{type:"link",icon:r.jsx(ee,{}),onClick:()=>J(t),size:"small",title:"Transfer User",children:"Transfer"})],children:r.jsx(S.Item.Meta,{avatar:r.jsx(X,{}),title:t.name,description:t.email})})})]})},a._id))})},e._id))}),r.jsx($,{title:n?"Edit Team":"Create Team",open:z,onClose:()=>h(!1),width:420,destroyOnClose:!0,footer:r.jsxs("div",{style:{textAlign:"right"},children:[r.jsx(m,{onClick:()=>h(!1),style:{marginRight:8},children:"Cancel"}),r.jsx(m,{type:"primary",style:{backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},onClick:q,children:n?"Update":"Create"})]}),children:r.jsxs(l,{form:g,layout:"vertical",children:[r.jsx(l.Item,{name:"name",label:"Team Name",rules:[{required:!1,message:"Team name is required"}],children:r.jsx(ne,{placeholder:"Enter team name"})}),r.jsx(l.Item,{name:"department",label:"Department",rules:[{required:!0,message:"Please select a department"}],children:r.jsx(c,{placeholder:"Select department",children:p.map(e=>r.jsx(x,{value:e._id,children:e.name},e._id))})}),r.jsx(l.Item,{name:"teamLeader",label:"Team Leader",children:r.jsx(c,{placeholder:"Select team leader (optional)",allowClear:!0,showSearch:!0,filterOption:(e,a)=>a.children[0].toLowerCase().includes(e.toLowerCase()),children:B().map(e=>r.jsxs(x,{value:e._id,children:[e.name," (",e.email,")"]},e._id))})}),r.jsx(l.Item,{name:"members",label:"Team Members",children:r.jsx(c,{mode:"multiple",placeholder:"Select team members (optional)",showSearch:!0,filterOption:(e,a)=>a.children[0].toLowerCase().includes(e.toLowerCase()),children:N().map(e=>r.jsxs(x,{value:e._id,children:[e.name," (",e.email,")"]},e._id))})})]})}),r.jsx($,{title:`Transfer ${u?u.name:"User"}`,open:A,onClose:()=>w(!1),width:420,destroyOnClose:!0,footer:r.jsxs("div",{style:{textAlign:"right"},children:[r.jsx(m,{onClick:()=>w(!1),style:{marginRight:8},children:"Cancel"}),r.jsx(m,{type:"primary",style:{backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},onClick:G,children:"Transfer"})]}),children:r.jsxs(l,{form:f,layout:"vertical",children:[r.jsx(l.Item,{name:"newDepartmentId",label:"New Department",children:r.jsx(c,{placeholder:"Select new department (optional)",allowClear:!0,onChange:Y,showSearch:!0,filterOption:(e,a)=>a.children.toLowerCase().includes(e.toLowerCase()),children:p.map(e=>r.jsx(x,{value:e._id,children:e.name},e._id))})}),r.jsx(l.Item,{name:"newTeamId",label:"New Team",children:r.jsx(c,{placeholder:"Select new team (optional)",allowClear:!0,showSearch:!0,filterOption:(e,a)=>a.children.toLowerCase().includes(e.toLowerCase()),disabled:!f.getFieldValue("newDepartmentId")||R.length===0,children:R.map(e=>r.jsx(x,{value:e._id,children:e.name},e._id))})})]})})]})};export{Le as default};
