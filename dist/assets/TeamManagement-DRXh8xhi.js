import{r as d,M as l,K as a,Q as o,aX as X,aZ as S,ai as Z,V as G,ag as H,a3 as U,aW as ee,bp as ae,aw as N,Y as re,S as m,$ as w,aj as i}from"./index-FVmEbnB1.js";import{C as _}from"./Collapse-BGJArvLw.js";import{R as se}from"./SwapOutlined-CZyI5BrA.js";import{P as te}from"./index-BTVJIO-A.js";const{Option:f}=m,{Panel:A}=_,ce=({teams:v,departments:g,allUsers:D,fetchTeams:y,fetchDepartments:ne,fetchUsers:b})=>{const[B,u]=d.useState(!1),[n,L]=d.useState(null),[x]=l.useForm(),[M,j]=d.useState(!1),[h,F]=d.useState(null),[p]=l.useForm(),[k,C]=d.useState([]),c=JSON.parse(localStorage.getItem("user")),T=(c==null?void 0:c.role)==="Superadmin",I=(c==null?void 0:c.role)==="Admin",R=D.filter(e=>e.role==="Team Leader"&&!e.team),O=D.filter(e=>e.role==="Employee"&&!e.team),z=d.useCallback(()=>{const e=n==null?void 0:n.teamLeader;let r=[...R];return e&&!r.some(s=>s._id===e._id)&&r.push(e),r.sort((s,t)=>s.name.localeCompare(t.name))},[n,R]),P=d.useCallback(()=>{const e=(n==null?void 0:n.members)||[];let r=[...O];return e.forEach(s=>{r.some(t=>t._id===s._id)||r.push(s)}),r.sort((s,t)=>s.name.localeCompare(t.name))},[n,O]),V=()=>{L(null),x.resetFields(),u(!0)},q=e=>{var r,s;L(e),x.setFieldsValue({name:e.name,department:(r=e.department)==null?void 0:r._id,teamLeader:(s=e.teamLeader)==null?void 0:s._id,members:e.members.map(t=>t._id)}),u(!0)},K=async()=>{var e,r;try{const s=await x.validateFields();n?(await w.put(`/api/teams/${n._id}`,s),i.success("Team updated successfully")):(await w.post("/api/teams",s),i.success("Team created successfully")),u(!1),y(),b()}catch(s){console.error("Team submission failed:",s),i.error(((r=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:r.message)||"Failed to submit team.")}},Y=async e=>{var r,s;try{await w.delete(`/api/teams/${e}`),i.success("Team deleted"),y(),b()}catch(t){console.error("Team deletion failed:",t),i.error(((s=(r=t==null?void 0:t.response)==null?void 0:r.data)==null?void 0:s.message)||"Failed to delete team.")}},$=g.reduce((e,r)=>(e[r._id]={...r,teams:v.filter(s=>{var t;return((t=s.department)==null?void 0:t._id)===r._id})},e),{}),J=e=>{F(e),p.resetFields(),C([]),j(!0)},Q=e=>{if(p.setFieldsValue({newTeamId:void 0}),e){const r=v.filter(s=>{var t;return((t=s.department)==null?void 0:t._id)===e});C(r)}else C([])},W=async()=>{var e,r;try{const s=await p.validateFields(),{newDepartmentId:t,newTeamId:E}=s;if(!h){i.error("No user selected for transfer.");return}if(!t&&!E){i.error("Please select a new department or team for transfer.");return}await w.put(`/api/users/${h._id}/transfer`,{newDepartmentId:t||null,newTeamId:E||null}),i.success(`${h.name} transferred successfully.`),j(!1),F(null),b(),y()}catch(s){console.error("User transfer failed:",s),i.error(((r=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:r.message)||"Failed to transfer user.")}};return a.jsxs(a.Fragment,{children:[a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[a.jsx("h2",{children:"Team Management"}),(T||I)&&a.jsx(o,{type:"primary",style:{backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},icon:a.jsx(X,{}),onClick:V,children:"Create Team"})]}),a.jsx(_,{accordion:!0,bordered:!1,defaultActiveKey:Object.keys($)[0],children:Object.values($).map(e=>a.jsx(A,{header:a.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[a.jsx(ae,{style:{marginRight:8,fontSize:"1.2em"}}),a.jsxs("h3",{children:[e.name," (",e.teams.length," Teams)"]})]}),style:{marginBottom:10,borderRadius:8,overflow:"hidden",border:"1px solid #d9d9d9"},children:e.teams.length===0?a.jsx("p",{children:"No teams in this department."}):a.jsx(_,{accordion:!0,bordered:!1,style:{background:"#f0f2f5"},children:e.teams.map(r=>a.jsx(A,{header:a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[a.jsxs("div",{style:{display:"flex",alignItems:"center"},children:[a.jsx(G,{style:{marginRight:8}}),a.jsx("strong",{children:r.name}),r.teamLeader&&a.jsxs("span",{style:{marginLeft:15,fontSize:"0.9em",color:"#555"},children:["(Leader: ",r.teamLeader.name,")"]})]}),(T||I)&&a.jsxs(H,{onClick:s=>s.stopPropagation(),children:[" ",a.jsx(o,{icon:a.jsx(U,{}),onClick:()=>q(r),size:"small",title:"Edit Team"}),a.jsx(te,{title:"Delete this team?",onConfirm:()=>Y(r._id),okText:"Yes",cancelText:"No",children:a.jsx(o,{danger:!0,icon:a.jsx(ee,{}),size:"small",title:"Delete Team"})})]})]}),style:{marginBottom:5,borderRadius:6,border:"1px solid #e8e8e8"},children:a.jsxs("div",{style:{paddingLeft:20},children:[a.jsx("h4",{children:"Team Members:"}),r.members.length===0?a.jsx("p",{children:"No members in this team."}):a.jsx(S,{size:"small",dataSource:r.members,renderItem:s=>a.jsx(S.Item,{actions:[(T||I)&&a.jsx(o,{type:"link",icon:a.jsx(se,{}),onClick:()=>J(s),size:"small",title:"Transfer User",children:"Transfer"})],children:a.jsx(S.Item.Meta,{avatar:a.jsx(Z,{}),title:s.name,description:s.email})})})]})},r._id))})},e._id))}),a.jsx(N,{title:n?"Edit Team":"Create Team",open:B,onClose:()=>u(!1),width:420,destroyOnClose:!0,footer:a.jsxs("div",{style:{textAlign:"right"},children:[a.jsx(o,{onClick:()=>u(!1),style:{marginRight:8},children:"Cancel"}),a.jsx(o,{type:"primary",style:{backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},onClick:K,children:n?"Update":"Create"})]}),children:a.jsxs(l,{form:x,layout:"vertical",children:[a.jsx(l.Item,{name:"name",label:"Team Name",rules:[{required:!1,message:"Team name is required"}],children:a.jsx(re,{placeholder:"Enter team name"})}),a.jsx(l.Item,{name:"department",label:"Department",rules:[{required:!0,message:"Please select a department"}],children:a.jsx(m,{placeholder:"Select department",children:g.map(e=>a.jsx(f,{value:e._id,children:e.name},e._id))})}),a.jsx(l.Item,{name:"teamLeader",label:"Team Leader",children:a.jsx(m,{placeholder:"Select team leader (optional)",allowClear:!0,showSearch:!0,filterOption:(e,r)=>r.children[0].toLowerCase().includes(e.toLowerCase()),children:z().map(e=>a.jsxs(f,{value:e._id,children:[e.name," (",e.email,")"]},e._id))})}),a.jsx(l.Item,{name:"members",label:"Team Members",children:a.jsx(m,{mode:"multiple",placeholder:"Select team members (optional)",showSearch:!0,filterOption:(e,r)=>r.children[0].toLowerCase().includes(e.toLowerCase()),children:P().map(e=>a.jsxs(f,{value:e._id,children:[e.name," (",e.email,")"]},e._id))})})]})}),a.jsx(N,{title:`Transfer ${h?h.name:"User"}`,open:M,onClose:()=>j(!1),width:420,destroyOnClose:!0,footer:a.jsxs("div",{style:{textAlign:"right"},children:[a.jsx(o,{onClick:()=>j(!1),style:{marginRight:8},children:"Cancel"}),a.jsx(o,{type:"primary",style:{backgroundColor:"#ef7a1b",borderColor:"#orange",color:"white"},onClick:W,children:"Transfer"})]}),children:a.jsxs(l,{form:p,layout:"vertical",children:[a.jsx(l.Item,{name:"newDepartmentId",label:"New Department",children:a.jsx(m,{placeholder:"Select new department (optional)",allowClear:!0,onChange:Q,showSearch:!0,filterOption:(e,r)=>r.children.toLowerCase().includes(e.toLowerCase()),children:g.map(e=>a.jsx(f,{value:e._id,children:e.name},e._id))})}),a.jsx(l.Item,{name:"newTeamId",label:"New Team",children:a.jsx(m,{placeholder:"Select new team (optional)",allowClear:!0,showSearch:!0,filterOption:(e,r)=>r.children.toLowerCase().includes(e.toLowerCase()),disabled:!p.getFieldValue("newDepartmentId")||k.length===0,children:k.map(e=>a.jsx(f,{value:e._id,children:e.name},e._id))})})]})})]})};export{ce as default};
